<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link href="stylesheets/pygments.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="stylesheets/softcover.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="stylesheets/custom.css" media="screen" rel="stylesheet" type="text/css" />
    
    <title>nimdays</title>
    
      <script type="text/x-mathjax-config">
              MathJax.Hub.Config({
        "HTML-CSS": {
          availableFonts: ["TeX"],
        },
        TeX: {
          extensions: ["AMSmath.js", "AMSsymbols.js", "color.js"],
          equationNumbers: {
            autoNumber: "AMS",
            
          },
          Macros: {
            PolyTeX:    "Poly{\\TeX}",
            PolyTeXnic: "Poly{\\TeX}nic",
            "softcover": "\\texttt{softcover}",
"unitvec": ["{\\hat #1}", 1]
          }
        },
        showProcessingMessages: false,
        messageStyle: "none",
        imageFont: null,
        "AssistiveMML": { disabled: true }
      });

        if (/PhantomJS/.test(window.navigator.userAgent)) {
          MathJax.Hub.Queue([alert, 'MathJax Done']);
        }
      </script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_SVG"></script>
    
  </head>
  <body>
    
    <div id="book">
      <div id="frontmatter" data-number="0"><div id="title_page"><h1 class="title">Nim Days</h1><h1 class="subtitle">My Nim diary</h1><h2 class="author">Ahmed T. Youssef</h2></div>
<h1 class="contents">Contents</h1><div id="table_of_contents"><ul><li class="chapter-star"><a href="#preface" class="heading hyperref">Preface</a></li><li class="chapter"><a href="#cid1" class="heading hyperref"><span class="number">Chapter 1 </span>Day 1: Parsing DMIDecode output</a></li><li><ul><li class="section"><a href="#cid2" class="heading hyperref"><span class="number">1.1 </span>What to expect ?</a></li><li class="section"><a href="#cid3" class="heading hyperref"><span class="number">1.2 </span>Implementation</a></li><li><ul><li class="subsection"><a href="#uid1" class="heading hyperref"><span class="number">1.2.1 </span>nimble ready!</a></li><li class="subsection"><a href="#uid2" class="heading hyperref"><span class="number">1.2.2 </span>So how does dmidecode output look like?</a></li><li class="subsection"><a href="#uid3" class="heading hyperref"><span class="number">1.2.3 </span>Mapping DMI to nim structures</a></li><li class="subsection"><a href="#uid4" class="heading hyperref"><span class="number">1.2.4 </span>Parsing DMI source into nim structures</a></li></ul></li></ul></li><li class="chapter"><a href="#cid4" class="heading hyperref"><span class="number">Chapter 2 </span>Day 2: Parsing Bencode</a></li><li><ul><li class="section"><a href="#cid5" class="heading hyperref"><span class="number">2.1 </span>What to expect?</a></li><li class="section"><a href="#cid6" class="heading hyperref"><span class="number">2.2 </span>Implementation</a></li></ul></li><li class="chapter"><a href="#cid7" class="heading hyperref"><span class="number">Chapter 3 </span>Day 3: Talking to C (FFI and libmagic)</a></li><li><ul><li class="section"><a href="#cid8" class="heading hyperref"><span class="number">3.1 </span>What to expect?</a></li><li class="section"><a href="#cid9" class="heading hyperref"><span class="number">3.2 </span>Implementation</a></li><li><ul><li class="subsection"><a href="#uid5" class="heading hyperref"><span class="number">3.2.1 </span>Step 1: Get the library info</a></li><li class="subsection"><a href="#uid6" class="heading hyperref"><span class="number">3.2.2 </span>Step 2: Extract constants</a></li><li class="subsection"><a href="#uid7" class="heading hyperref"><span class="number">3.2.3 </span>Step 3: Extract the types</a></li><li class="subsection"><a href="#uid8" class="heading hyperref"><span class="number">3.2.4 </span>Step 4: Extract procedures</a></li><li class="subsection"><a href="#uid9" class="heading hyperref"><span class="number">3.2.5 </span>Step 5: Friendly API</a></li></ul></li></ul></li><li class="chapter"><a href="#cid10" class="heading hyperref"><span class="number">Chapter 4 </span>Day 4: LinksChecker</a></li><li><ul><li class="section"><a href="#cid11" class="heading hyperref"><span class="number">4.1 </span>What to expect ?</a></li><li class="section"><a href="#cid12" class="heading hyperref"><span class="number">4.2 </span>Implementation</a></li><li><ul><li class="subsection"><a href="#uid10" class="heading hyperref"><span class="number">4.2.1 </span>Step 0: Imports</a></li><li class="subsection"><a href="#uid11" class="heading hyperref"><span class="number">4.2.2 </span>Step 1: Data types</a></li><li class="subsection"><a href="#uid12" class="heading hyperref"><span class="number">4.2.3 </span>Step 2: GO Sequential!</a></li><li class="subsection"><a href="#uid13" class="heading hyperref"><span class="number">4.2.4 </span>Step 3: GO ASYNC!</a></li><li class="subsection"><a href="#uid14" class="heading hyperref"><span class="number">4.2.5 </span>Step 4 simple cli</a></li><li class="subsection"><a href="#uid15" class="heading hyperref"><span class="number">4.2.6 </span>Extra, threading</a></li></ul></li></ul></li><li class="chapter"><a href="#cid13" class="heading hyperref"><span class="number">Chapter 5 </span>Day 5: Creating INI Parser</a></li><li><ul><li class="section"><a href="#cid14" class="heading hyperref"><span class="number">5.1 </span>What to expect ?</a></li><li class="section"><a href="#cid15" class="heading hyperref"><span class="number">5.2 </span>Implementation</a></li><li><ul><li class="subsection"><a href="#uid16" class="heading hyperref"><span class="number">5.2.1 </span>Ini sample</a></li><li class="subsection"><a href="#uid17" class="heading hyperref"><span class="number">5.2.2 </span>Define your data types</a></li><li class="subsection"><a href="#uid18" class="heading hyperref"><span class="number">5.2.3 </span>Define API</a></li><li class="subsection"><a href="#uid19" class="heading hyperref"><span class="number">5.2.4 </span>Parse!</a></li></ul></li></ul></li><li class="chapter"><a href="#cid16" class="heading hyperref"><span class="number">Chapter 6 </span>Day 6: Manage your dotfiles easily with nistow</a></li><li><ul><li class="section"><a href="#cid17" class="heading hyperref"><span class="number">6.1 </span>Dotfiles layout</a></li><li class="section"><a href="#cid18" class="heading hyperref"><span class="number">6.2 </span>What do we expect?</a></li><li class="section"><a href="#cid19" class="heading hyperref"><span class="number">6.3 </span>Implementation</a></li></ul></li></ul></div>
<div class="chapter-star" id="preface"><h1><a href="#preface" class="heading hyperref">Preface</a></h1>
<p class="noindent">Documenting my days with The Nim Programming language.</p>
</div></div>

<div id="cid1" data-tralics-id="cid1" class="chapter" data-number="1"><h1><a href="#cid1" class="heading hyperref"><span class="number">Chapter 1 </span>Day 1: Parsing DMIDecode output</a></h1>
<p class="noindent">In our first day we will write a <a href="https://man.cx/?page=dmidecode(8)" target="_blank" rel="noopener">dmidecode</a> parser in nim</p>
</div>
<div id="cid2" data-tralics-id="cid2" class="section" data-number="1.1"><h2><a href="#cid2" class="heading hyperref"><span class="number">1.1 </span>What to expect ?</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">sample1</span> <span class="o">=</span> <span class="s">"""</span>
<span class="s"># dmidecode 3.1</span>
<span class="s">Getting SMBIOS data from sysfs.</span>
<span class="s">SMBIOS 2.6 present.</span>

<span class="s">Handle 0x0001, DMI type 1, 27 bytes</span>
<span class="s">System Information</span>
<span class="s">        Manufacturer: LENOVO</span>
<span class="s">        Product Name: 20042</span>
<span class="s">        Version: Lenovo G560</span>
<span class="s">        Serial Number: 2677240001087</span>
<span class="s">        UUID: CB3E6A50-A77B-E011-88E9-B870F4165734</span>
<span class="s">        Wake-up Type: Power Switch</span>
<span class="s">        SKU Number: Calpella_CRB</span>
<span class="s">        Family: Intel_Mobile</span>
<span class="s">"""</span>

<span class="kn">import</span> <span class="n">dmidecode</span><span class="p">,</span> <span class="n">tables</span>

<span class="kd">var</span> <span class="n">obj</span> <span class="p">:</span> <span class="n">Table</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="n">dmidecode</span><span class="p">.</span><span class="n">Section</span><span class="o">]</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">parseDMI</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
<span class="k">for</span> <span class="n">secname</span><span class="p">,</span> <span class="n">sec</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
    <span class="n">echo</span> <span class="n">secname</span> <span class="o">&amp;</span> <span class="s">" with "</span> <span class="o">&amp;</span> <span class="o">$</span><span class="n">len</span><span class="p">(</span><span class="n">sec</span><span class="p">.</span><span class="n">props</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sec</span><span class="p">.</span><span class="n">props</span><span class="p">:</span>
        <span class="n">echo</span> <span class="s">"k : "</span> <span class="o">&amp;</span> <span class="n">k</span> <span class="o">&amp;</span> <span class="s">" =&gt; "</span> <span class="o">&amp;</span> <span class="n">p</span><span class="p">.</span><span class="n">val</span> 
        <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">items</span><span class="p">:</span>
                <span class="n">echo</span> <span class="s">"</span><span class="se">\t\t</span><span class="s"> I: "</span><span class="p">,</span> <span class="n">i</span>
</pre></div></div>
</div>
<div id="cid3" data-tralics-id="cid3" class="section" data-number="1.2"><h2><a href="#cid3" class="heading hyperref"><span class="number">1.2 </span>Implementation</a></h2>
<p class="noindent">a while ago at work (https://github.com/zero-os/0-core) we needed to parse some dmidecode output, and it sounds like an good problem with enough concepts to get my feet wet in nim.</p>
<div id="uid1" data-tralics-id="uid1" class="subsection" data-number="1.2.1"><h3><a href="#uid1" class="heading hyperref"><span class="number">1.2.1 </span>nimble ready!</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span>mkdir dmidecode
nimble init
</pre></div></div>
</div>
<div id="uid2" data-tralics-id="uid2" class="subsection" data-number="1.2.2"><h3><a href="#uid2" class="heading hyperref"><span class="number">1.2.2 </span>So how does dmidecode output look like?</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span># dmidecode 3.1
Getting SMBIOS data from sysfs.
SMBIOS 2.6 present.

Handle 0x0001, DMI type 1, 27 bytes
System Information
        Manufacturer: LENOVO
        Product Name: 20042
        Version: Lenovo G560
        Serial Number: 2677240001087
        UUID: CB3E6A50-A77B-E011-88E9-B870F4165734
        Wake-up Type: Power Switch
        SKU Number: Calpella_CRB
        Family: Intel_Mobile
</pre></div></div>
<p>or</p>
<div class="code"><div class="highlight"><pre><span></span>Getting SMBIOS data from sysfs.
SMBIOS 2.6 present.

Handle 0x0000, DMI type 0, 24 bytes
BIOS Information
        Vendor: LENOVO
        Version: 29CN40WW(V2.17)
        Release Date: 04/13/2011
        ROM Size: 2048 kB
        Characteristics:
                PCI is supported
                BIOS is upgradeable
                BIOS shadowing is allowed
                Boot from CD is supported
                Selectable boot is supported
                EDD is supported
                Japanese floppy for NEC 9800 1.2 MB is supported (int 13h)
                Japanese floppy for Toshiba 1.2 MB is supported (int 13h)
                5.25"/360 kB floppy services are supported (int 13h)
                5.25"/1.2 MB floppy services are supported (int 13h)
                3.5"/720 kB floppy services are supported (int 13h)
                3.5"/2.88 MB floppy services are supported (int 13h)
                8042 keyboard services are supported (int 9h)
                CGA/mono video services are supported (int 10h)
                ACPI is supported
                USB legacy is supported
                BIOS boot specification is supported
                Targeted content distribution is supported
        BIOS Revision: 1.40
</pre></div></div>
<p>### DMI structure
- DMIDecode output is some meta like comments, versions and one or more sections
- Section: consists of a
* handle line
* title line
* one or more indented properties
- Property: consists of
* key
* optional value
* optional list of indented items</p>
</div>
<div id="uid3" data-tralics-id="uid3" class="subsection" data-number="1.2.3"><h3><a href="#uid3" class="heading hyperref"><span class="number">1.2.3 </span>Mapping DMI to nim structures</a></h3>
<p class="noindent">So ourplan is to have an api like
</p><div class="code"><div class="highlight"><pre><span></span><span class="n">dmifile</span> <span class="o">=</span> <span class="n">parseDMI</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="n">dmifile</span><span class="o">[</span><span class="s">"section1"</span><span class="o">][</span><span class="s">"property1].value</span>
</pre></div></div>
<p>Let’s describe the document structure we have
</p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span>  <span class="n">sequtils</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">strutils</span>

<span class="k">type</span> 
    <span class="n">Property</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span>
        <span class="n">val</span><span class="o">*</span><span class="p">:</span> <span class="kt">string</span>
        <span class="n">items</span><span class="o">*</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="kt">string</span><span class="o">]</span>
<span class="k">type</span>
    <span class="n">Section</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span>
        <span class="n">handleLine</span><span class="o">*</span><span class="p">,</span> <span class="n">title</span><span class="o">*</span><span class="p">:</span> <span class="kt">string</span>
        <span class="n">props</span><span class="o">*</span> <span class="p">:</span> <span class="n">Table</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="n">Property</span><span class="o">]</span>

<span class="k">method</span> <span class="n">addItem</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Property</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">this</span><span class="p">.</span><span class="n">items</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div></div>
<p>As our parsing will depend on the indentation level we can use this handy function to get the indentation level of a line (number of spaces before the first asciiLetter)</p>
<div class="code"><div class="highlight"><pre><span></span>proc getIndentLevel(line: string) : int = 
    for i, c in pairs(line):
        if not c.isSpaceAscii():
            return i
    return 0
</pre></div></div>
<p>It’d have been nicer to use <code>takewhile</code>, but it’s not available in nim stdlib
</p><div class="code"><div class="highlight"><pre><span></span>    <span class="n">getindentlevel</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>  <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">takewhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">isspace</span><span class="p">(),</span> <span class="n">l</span><span class="p">)))</span>
</pre></div></div>
</div>
<div id="uid4" data-tralics-id="uid4" class="subsection" data-number="1.2.4"><h3><a href="#uid4" class="heading hyperref"><span class="number">1.2.4 </span>Parsing DMI source into nim structures</a></h3>
<p class="noindent">There’re many ways to parse the DMI (e.g using regex which would be fairly simple “feel free to implement it” and kindly send me a PR to update this tutorial)
</p><div class="code"><div class="highlight"><pre><span></span>proc parseDMI* (source: string) : Table[string, Section]=
</pre></div></div>
<p>In plain english for output like this
</p><div class="code"><div class="highlight"><pre><span></span>Getting SMBIOS data from sysfs.
SMBIOS 2.6 present.

Handle 0x0000, DMI type 0, 24 bytes
BIOS Information
        Vendor: LENOVO
        Version: 29CN40WW(V2.17)
        Release Date: 04/13/2011
        ROM Size: 2048 kB
        Characteristics:
                PCI is supported
                BIOS is upgradeable
                BIOS shadowing is allowed
                Boot from CD is supported
                Selectable boot is supported
                EDD is supported
                Japanese floppy for NEC 9800 1.2 MB is supported (int 13h)
                Japanese floppy for Toshiba 1.2 MB is supported (int 13h)
                5.25"/360 kB floppy services are supported (int 13h)
                5.25"/1.2 MB floppy services are supported (int 13h)
                3.5"/720 kB floppy services are supported (int 13h)
                3.5"/2.88 MB floppy services are supported (int 13h)
                8042 keyboard services are supported (int 9h)
                CGA/mono video services are supported (int 10h)
                ACPI is supported
                USB legacy is supported
                BIOS boot specification is supported
                Targeted content distribution is supported
        BIOS Revision: 1.40
</pre></div></div>
<p>we have couple of states
</p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> 
    <span class="n">ParserState</span> <span class="o">=</span> <span class="k">enum</span>
        <span class="n">noOp</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">,</span> <span class="n">readKeyValue</span><span class="p">,</span> <span class="n">readList</span>
</pre></div></div>
<p>- noOp: no action yet
- sectionName: read sectionName
- readKeyValue: read a line has colon <code>:</code> in it into a key value pair
- readList: when the next line has greater indentation level than the property line</p>
<p>so our state is noOp until we reach line
<code>Handle 0x0000, DMI type 0, 24 bytes</code>
then moves to sectionName
for line <code>BIOS Information</code> then state changes to reading properties
</p><div class="code"><div class="highlight"><pre><span></span>        Vendor: LENOVO
        Version: 29CN40WW(V2.17)
        Release Date: 04/13/2011
        ROM Size: 2048 kB
        Characteristics:
</pre></div></div>
<p>then we notice the indentation on the next line
</p><div class="code"><div class="highlight"><pre><span></span>                PCI is supported
``` 
is greater than the one on the current line
</pre></div></div>
<p>Characteristics:
</p><div class="code"><div class="highlight"><pre><span></span>so state moves into readList to read the items related to property `Characterstics`
</pre></div></div>
<p>PCI is supported
BIOS is upgradeable
BIOS shadowing is allowed
Boot from CD is supported
Selectable boot is supported
EDD is supported
Japanese floppy for NEC 9800 1.2 MB is supported (int 13h)
Japanese floppy for Toshiba 1.2 MB is supported (int 13h)
5.25”/360 kB floppy services are supported (int 13h)
5.25”/1.2 MB floppy services are supported (int 13h)
3.5”/720 kB floppy services are supported (int 13h)
3.5”/2.88 MB floppy services are supported (int 13h)
8042 keyboard services are supported (int 9h)
CGA/mono video services are supported (int 10h)
ACPI is supported
USB legacy is supported
BIOS boot specification is supported
Targeted content distribution is supported
</p><div class="code"><div class="highlight"><pre><span></span>and again it notices the indentation is of the next line 
</pre></div></div>
<p>BIOS Revision: 1.40
</p><div class="code"><div class="highlight"><pre><span></span>is less than the current line 
</pre></div></div>
<p>Targeted content distribution is supported
</p><div class="code"><div class="highlight"><pre><span></span>so state switches again into `readKeyValue`

- if we encounter an empty line:
    * if not in parsing state then it's a noOp we ignore meta and empty lines
    * if in parsing state `current Section isn't nil` we finish parsing the section object


```nim

proc parseDMI* (source: string) : Table[string, Section]=
    
    var
        state : ParserState = noOp
        lines = strutils.splitLines(source)
        sects = initTable[string, Section]()
        
        p: Property = nil
        s: Section = nil 
        k, v: string
```
Here we define the current state, code lines, initialize a table `sects` from `sectionName` to `Section Object` and variables p `current property`, s `current section`, k, v `current property key, value`

```nim
    for i, l in pairs(lines):
```
Start looping on index, line using `pairs` 
&gt; pairs is kinda like enumerate in python
</pre></div></div>
<p>if l.startsWith(“Handle”):
s = new Section
s.props = initTable<a href="" target="_blank" rel="noopener">string, Property</a>
s.handleline = l
state = sectionName
continue
</p><div class="code"><div class="highlight"><pre><span></span>If we encounter the string `Handle` 
- create new section object and initialize it's props table
- keep track of the handle line
- switch state to reading sectionName
- continue the loop to move to the title line

```nim
        if l == "": # can be just new line before reading any sections. 
            if s != nil:
                sects[s.title] = s
            continue
```
if line is empty and we have a section object `not nil` we finish the section and continue 

```nim
        if state == sectionName:  # current line is the title line
            s.title = l
            state = readKeyValue  # change state into reading key value pairs
```
If state is sectionName:
- this line is a title line 
- change state for the upcoming to readKeyValue
</pre></div></div>
<p>elif state == readKeyValue:
let pair = l.split({‘:’})
k = pair[0].strip()
if len(pair) == 2:
v = pair[1].strip()
else: # value can be empty
v = “”
p = Property(val: v)
p.items = newSeq<a href="" target="_blank" rel="noopener">string</a>
p.val = v
</p><div class="code"><div class="highlight"><pre><span></span>If state is readKeyValue
- split the line on colon `:` to get key, value pair and set v to "" if not present
- make current Property `p` and initialize its related fields `items`, `val`

```nim
            # current line indentation is &lt;  nextline indentation =&gt; change state to readList
            if i &lt; len(lines) and (getIndentlevel(l) &lt; getIndentlevel(lines[i+1])) :
                state = readList
```
If the next line indentation is greater this means we're should be reading list of items regarding the current property `p`

```nim
            else:
                # add key/value pair directly
                s.props[k] = p
```
If not finish the property


```nim
        elif state == readList:
            # keep adding the current line to current property items and if dedented =&gt; change state to readKeyValue
            p.add_item(l.strip())
            if getindentlevel(l) &gt; getindentlevel(lines[i+1]):
                state = readKeyValue 
                s.props[k] = p
```
if state is `readList`
- keep adding items to current property `p`
- if the indentation level decreased change state to `readKeyValue` and finish property
</pre></div></div>
<p>return sects</p>
<div class="code"><div class="highlight"><pre><span></span>Feel free to send PRs regarding idiomatic nim, tests, improvements to the tutorial, .. etc :)
</pre></div></div>
</div></div>
<div id="cid4" data-tralics-id="cid4" class="chapter" data-number="2"><h1><a href="#cid4" class="heading hyperref"><span class="number">Chapter 2 </span>Day 2: Parsing Bencode</a></h1>
<p class="noindent">nim-bencode is a library to encode/decode torrent files <a href="https://en.wikipedia.org/wiki/Bencode" target="_blank" rel="noopener">Bencode</a></p>
</div>
<div id="cid5" data-tralics-id="cid5" class="section" data-number="2.1"><h2><a href="#cid5" class="heading hyperref"><span class="number">2.1 </span>What to expect?</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">bencode</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">strformat</span>

<span class="k">let</span> <span class="n">encoder</span> <span class="o">=</span> <span class="n">newEncoder</span><span class="p">()</span>
<span class="k">let</span> <span class="n">decoder</span> <span class="o">=</span> <span class="n">newDecoder</span><span class="p">()</span>

<span class="k">let</span> <span class="n">btListSample1</span> <span class="o">=</span> <span class="o">@[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"hi"</span><span class="p">)</span> <span class="o">]</span>
<span class="kd">var</span> <span class="n">btDictSample1</span> <span class="o">=</span> <span class="n">initOrderedTable</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">,</span> <span class="n">BencodeType</span><span class="o">]</span><span class="p">()</span>
<span class="n">btDictSample1</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"name"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"dmdm"</span><span class="p">)</span>
<span class="n">btDictSample1</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"lang"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"nim"</span><span class="p">)</span>
<span class="n">btDictSample1</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"age"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="mi">50</span><span class="p">)</span>
<span class="n">btDictSample1</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"alist"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btList</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">btListSample1</span><span class="p">)</span>

<span class="kd">var</span> <span class="n">testObjects</span> <span class="o">=</span> <span class="n">initOrderedTable</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">,</span> <span class="kt">string</span><span class="o">]</span><span class="p">()</span>
<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"hello"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"5:hello"</span>
<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"yes"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"3:yes"</span>
<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="mi">55</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"i55e"</span>

<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="mi">12345</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"i12345e"</span>
<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btList</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">btListSample1</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"li1e2:hie"</span>
<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btDict</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span><span class="n">btDictSample1</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"d4:name4:dmdm4:lang3:nim3:agei50e5:alistli1e2:hiee"</span>


<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">testObjects</span><span class="p">.</span><span class="n">pairs</span><span class="p">():</span>
    <span class="n">echo</span> <span class="o">$</span><span class="n">k</span> <span class="o">&amp;</span> <span class="s">" =&gt; "</span> <span class="o">&amp;</span> <span class="o">$</span><span class="n">v</span>
    <span class="n">doAssert</span><span class="p">(</span><span class="n">encoder</span><span class="p">.</span><span class="n">encodeObject</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">doAssert</span><span class="p">(</span><span class="n">decoder</span><span class="p">.</span><span class="n">decodeObject</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
</pre></div></div>
</div>
<div id="cid6" data-tralics-id="cid6" class="section" data-number="2.2"><h2><a href="#cid6" class="heading hyperref"><span class="number">2.2 </span>Implementation</a></h2>
<p class="noindent">TODO</p>
</div>
<div id="cid7" data-tralics-id="cid7" class="chapter" data-number="3"><h1><a href="#cid7" class="heading hyperref"><span class="number">Chapter 3 </span>Day 3: Talking to C (FFI and libmagic)</a></h1>
<p class="noindent">Libmagic is a magic number recognition library, remember everytime you called <code>file</code> utility on a file to know its type?</p>
<div class="code"><div class="highlight"><pre><span></span>➜  file /usr/bin/rm
/usr/bin/rm: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=cbae26b2a032b1ce3129d56aee2bcf70dd8deeb0, stripped
➜  nim-magic file /
/: directory
➜  file /usr/include/stdio.h
/usr/include/stdio.h: C source, ASCII text
</pre></div></div>
</div>
<div id="cid8" data-tralics-id="cid8" class="section" data-number="3.1"><h2><a href="#cid8" class="heading hyperref"><span class="number">3.1 </span>What to expect?</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">magic</span>

<span class="n">echo</span> <span class="n">magic</span><span class="p">.</span><span class="n">guessFile</span><span class="p">(</span><span class="s">"/usr/bin/rm"</span><span class="p">)</span>
</pre></div></div>
<p>The output should be something like
</p><div class="code"><div class="highlight"><pre><span></span>ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=cbae26b2a032b1ce3129d56aee2bcf70dd8deeb0, stripped
</pre></div></div>
</div>
<div id="cid9" data-tralics-id="cid9" class="section" data-number="3.2"><h2><a href="#cid9" class="heading hyperref"><span class="number">3.2 </span>Implementation</a></h2>
<p class="noindent"><a href="https://livebook.manning.com/#!/book/nim-in-action/chapter-8/1" target="_blank" rel="noopener">FFI Chapter</a> of <a href="https://www.manning.com/books/nim-in-action" target="_blank" rel="noopener">Nim in Action</a> is freely available.</p>
<div id="uid5" data-tralics-id="uid5" class="subsection" data-number="3.2.1"><h3><a href="#uid5" class="heading hyperref"><span class="number">3.2.1 </span>Step 1: Get the library info</a></h3>
<p class="noindent">Well, libmagic has <code>libmagic.so</code> in your library path <code>/usr/lib/libmagic.so</code> and a header file <code>magic.h</code> in <code>/usr/include/magic.h</code>.<span class="intersentencespace"></span> create a constant for the libmagic library name.<span class="intersentencespace"></span> </p><div class="code"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">libName</span><span class="o">*</span> <span class="o">=</span> <span class="s">"libmagic.so"</span>
</pre></div></div>
</div>
<div id="uid6" data-tralics-id="uid6" class="subsection" data-number="3.2.2"><h3><a href="#uid6" class="heading hyperref"><span class="number">3.2.2 </span>Step 2: Extract constants</a></h3>
<p class="noindent">We should extract the constants from the header</p>
<div class="code"><div class="highlight"><pre><span></span><span class="cp">#define MAGIC_NONE              0x0000000 </span><span class="cm">/* No flags */</span><span class="cp"></span>
<span class="cp">#define MAGIC_DEBUG             0x0000001 </span><span class="cm">/* Turn on debugging */</span><span class="cp"></span>
<span class="cp">#define MAGIC_SYMLINK           0x0000002 </span><span class="cm">/* Follow symlinks */</span><span class="cp"></span>
<span class="cp">#define MAGIC_COMPRESS          0x0000004 </span><span class="cm">/* Check inside compressed files */</span><span class="cp"></span>
<span class="cp">#define MAGIC_DEVICES           0x0000008 </span><span class="cm">/* Look at the contents of devices */</span><span class="cp"></span>
<span class="cp">#define MAGIC_MIME_TYPE         0x0000010 </span><span class="cm">/* Return the MIME type */</span><span class="cp"></span>
<span class="cp">#define MAGIC_CONTINUE          0x0000020 </span><span class="cm">/* Return all matches */</span><span class="cp"></span>
<span class="cp">#define MAGIC_CHECK             0x0000040 </span><span class="cm">/* Print warnings to stderr */</span><span class="cp"></span>
<span class="p">....</span>
</pre></div></div>
<p>So in nim It’d be something like this
</p><div class="code"><div class="highlight"><pre><span></span><span class="k">const</span>  <span class="n">MAGIC_NONE</span><span class="o">*</span>  <span class="o">=</span> <span class="mh">0x000000</span>                 <span class="c"># No flags </span>
<span class="k">const</span>  <span class="n">MAGIC_DEBUG</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000001</span>                 <span class="c"># Turn on debugging </span>
<span class="k">const</span>  <span class="n">MAGIC_SYMLINK</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000002</span>                 <span class="c"># Follow symlinks </span>
<span class="k">const</span>  <span class="n">MAGIC_COMPRESS</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000004</span>                <span class="c"># Check inside compressed files </span>
<span class="k">const</span>  <span class="n">MAGIC_DEVICES</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000008</span>                 <span class="c"># Look at the contents of devices </span>
<span class="k">const</span>  <span class="n">MAGIC_MIME_TYPE</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000010</span>            <span class="c"># Return only the MIME type </span>
<span class="k">const</span>  <span class="n">MAGIC_CONTINUE</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000020</span>             <span class="c"># Return all matches </span>
<span class="k">const</span>  <span class="n">MAGIC_CHECK</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000040</span>                 <span class="c"># Print warnings to stderr </span>
<span class="k">const</span>  <span class="n">MAGIC_PRESERVE_ATIME</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000080</span>        <span class="c"># Restore access time on exit </span>
<span class="k">const</span>  <span class="n">MAGIC_RAW</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000100</span>                    <span class="c"># Don't translate unprint chars </span>
<span class="k">const</span>  <span class="n">MAGIC_ERROR</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000200</span>                 <span class="c"># Handle ENOENT etc as real errors </span>
<span class="k">const</span>  <span class="n">MAGIC_MIME_ENCODING</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000400</span>         <span class="c"># Return only the MIME encoding </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_COMPRESS</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x001000</span>     <span class="c"># Don't check for compressed files </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_TAR</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x002000</span>         <span class="c"># Don't check for tar files </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_SOFT</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x004000</span>         <span class="c"># Don't check magic entries </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_APPTYPE</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x008000</span>        <span class="c"># Don't check application type </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_ELF</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x010000</span>            <span class="c"># Don't check for elf details </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_ASCII</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x020000</span>         <span class="c"># Don't check for ascii files </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_TOKENS</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x100000</span>         <span class="c"># Don't check ascii/tokens </span>
</pre></div></div>
</div>
<div id="uid7" data-tralics-id="uid7" class="subsection" data-number="3.2.3"><h3><a href="#uid7" class="heading hyperref"><span class="number">3.2.3 </span>Step 3: Extract the types</a></h3>
<p class="noindent"><code>typedef struct magic_set *magic_t;</code>
so the only type we have is a pointer to some struct (object)</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">Magic</span> <span class="o">=</span> <span class="k">object</span>
<span class="k">type</span> <span class="n">MagicPtr</span><span class="o">*</span> <span class="o">=</span> <span class="k">ptr</span> <span class="n">Magic</span> 
</pre></div></div>
</div>
<div id="uid8" data-tralics-id="uid8" class="subsection" data-number="3.2.4"><h3><a href="#uid8" class="heading hyperref"><span class="number">3.2.4 </span>Step 4: Extract procedures</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="n">magic_t</span> <span class="nf">magic_open</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">magic_close</span><span class="p">(</span><span class="n">magic_t</span><span class="p">);</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">magic_getpath</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">magic_file</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">magic_descriptor</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">magic_buffer</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">magic_error</span><span class="p">(</span><span class="n">magic_t</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_getflags</span><span class="p">(</span><span class="n">magic_t</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_setflags</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">magic_version</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_load</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_load_buffers</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">magic_compile</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_check</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_list</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_errno</span><span class="p">(</span><span class="n">magic_t</span><span class="p">);</span>
</pre></div></div>
<p>we only care about <code>magic_open</code>, <code>magic_load</code>, <code>magic_close</code>, <code>magic_file</code>, <code>magic_error</code></p>
<div class="code"><div class="highlight"><pre><span></span><span class="c"># magic_t magic_open(int);</span>
<span class="k">proc </span><span class="nf">magic_open</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">cint</span><span class="p">)</span> <span class="p">:</span> <span class="n">MagicPtr</span> <span class="p">{.</span><span class="n">importc</span><span class="p">,</span> <span class="n">dynlib</span><span class="p">:</span><span class="n">libName</span><span class="p">.}</span>
</pre></div></div>
<p><code>magic_open</code> is a proc declared in dynamic lib <code>libmagic.so</code>, that is takes a cint “compatible c int” <code>i</code> and returns a <code>MagicPtr</code>.</p>
<p>From the manpage
</p><div class="code"><div class="highlight"><pre><span></span>The function magic_open() creates a magic cookie pointer and returns it.  It returns NULL if there was an error allocating the magic cookie.  The flags argument specifies how the other magic functions should behave
</pre></div></div>
<div class="code"><div class="highlight"><pre><span></span><span class="c"># void magic_close(magic_t);</span>
<span class="k">proc </span><span class="nf">magic_close</span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">MagicPtr</span><span class="p">):</span> <span class="n">void</span> <span class="p">{.</span><span class="n">importc</span><span class="p">,</span>  <span class="n">dynlib</span><span class="p">:</span><span class="n">libName</span><span class="p">.}</span>
</pre></div></div>
<p><code>magic_close</code> is a proc declared in dynlib <code>libmagic.so</code> and takes an argumnet p of type <code>MagicPtr</code> and returns <code>void</code></p>
<p>From the manpage:
</p><div class="code"><div class="highlight"><pre><span></span>The magic_close() function closes the magic(5) database and deallocates any resources used.
</pre></div></div>
<div class="code"><div class="highlight"><pre><span></span><span class="c">#int magic_load(magic_t, const char *);</span>
<span class="k">proc </span><span class="nf">magic_load</span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">MagicPtr</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="n">cstring</span><span class="p">)</span> <span class="p">:</span> <span class="n">cint</span> <span class="p">{.</span><span class="n">importc</span><span class="p">,</span> <span class="n">dynlib</span><span class="p">:</span> <span class="n">libName</span><span class="p">.}</span>
</pre></div></div>
<p><code>magic_load</code> is a proc declared in dynlib <code>libmagic.so</code> takes argument p of type <code>MagicPtr</code> and a <code>cstring</code> “compatible c string” <code>s</code> and returns a <code>cint</code></p>
<p>From manpage:
</p><div class="code"><div class="highlight"><pre><span></span> The magic_load() function must be used to load the colon separated list of database files passed in as filename, or NULL for the default database
     file before any magic queries can performed.
</pre></div></div>
<div class="code"><div class="highlight"><pre><span></span><span class="c">#int magic_errno(magic_t);</span>
<span class="k">proc </span><span class="nf">magic_error</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">MagicPtr</span><span class="p">)</span> <span class="p">:</span> <span class="n">cstring</span>  <span class="p">{.</span><span class="n">importc</span><span class="p">,</span> <span class="n">dynlib</span><span class="p">:</span><span class="n">libName</span><span class="p">.}</span>
</pre></div></div>
<p><code>magic_errno</code> is a proc declared in dynlib <code>libmagic.so</code> and takes argument p of type <code>MagicPtr</code> and returns a <code>cstring</code></p>
<p>From manpage
</p><div class="code"><div class="highlight"><pre><span></span>     The magic_error() function returns a textual explanation of the last error, or NULL if there was no error.
</pre></div></div>
<div class="code"><div class="highlight"><pre><span></span><span class="c">#const char *magic_file(magic_t, const char *);</span>
<span class="k">proc </span><span class="nf">magic_file</span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">MagicPtr</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">cstring</span><span class="p">):</span> <span class="n">cstring</span> <span class="p">{.</span><span class="n">importc</span><span class="p">,</span> <span class="n">dynlib</span><span class="p">:</span> <span class="n">libName</span><span class="p">.}</span> 
</pre></div></div>
<p><code>magic_file</code> is proc declared in dynlib <code>libmagic.so</code> takes argument p of type <code>MagicPtr</code> and a filepath of type <code>cstring</code> and returns a <code>cstring</code></p>
<p>From manpage:
</p><div class="code"><div class="highlight"><pre><span></span>     The magic_file() function returns a textual description of the contents of the filename argument, or NULL if an error occurred.  If the filename is
     NULL, then stdin is used.
</pre></div></div>
</div>
<div id="uid9" data-tralics-id="uid9" class="subsection" data-number="3.2.5"><h3><a href="#uid9" class="heading hyperref"><span class="number">3.2.5 </span>Step 5: Friendly API</a></h3>
<p class="noindent">It’d be annoying for people to write C code and take care of pointers and such in a higher level language like nim</p>
<p>So let’s expose a proc <code>guessFile</code> takes a filepath and flags and internally use the functions we exposed through the FFI in the previous step.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">guessFile</span><span class="o">*</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="n">cint</span> <span class="o">=</span> <span class="n">MAGIC_NONE</span><span class="p">):</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">mt</span> <span class="p">:</span> <span class="n">MagicPtr</span>
    <span class="n">mt</span> <span class="o">=</span> <span class="n">magic_open</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
    <span class="k">discard</span> <span class="n">magic_load</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fileExists</span><span class="p">(</span><span class="n">expandFilename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="o">$</span><span class="n">magic_file</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">cstring</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
    <span class="n">magic_close</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
</pre></div></div>
<p>Only one note here to convert from <code>cstring</code> to <code>string</code> we use the <code>toString</code> operator <code>$</code>
</p><div class="code"><div class="highlight"><pre><span></span>        result = $magic_file(mt, cstring(filepath))
</pre></div></div>
<p>Feel free to send me PRs to improve the library or tutorial :)</p>
</div></div>
<div id="cid10" data-tralics-id="cid10" class="chapter" data-number="4"><h1><a href="#cid10" class="heading hyperref"><span class="number">Chapter 4 </span>Day 4: LinksChecker</a></h1>
</div>
<div id="cid11" data-tralics-id="cid11" class="section" data-number="4.1"><h2><a href="#cid11" class="heading hyperref"><span class="number">4.1 </span>What to expect ?</a></h2>
<p class="noindent">We will be writing a simple linkschecker in both <code>sequential</code> and <code>asynchronous</code> style in nim</p>
</div>
<div id="cid12" data-tralics-id="cid12" class="section" data-number="4.2"><h2><a href="#cid12" class="heading hyperref"><span class="number">4.2 </span>Implementation</a></h2>
<div id="uid10" data-tralics-id="uid10" class="subsection" data-number="4.2.1"><h3><a href="#uid10" class="heading hyperref"><span class="number">4.2.1 </span>Step 0: Imports</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span>  <span class="n">os</span><span class="p">,</span> <span class="n">httpclient</span>
<span class="kn">import</span> <span class="n">strutils</span>
<span class="kn">import</span> <span class="n">times</span>
<span class="kn">import</span> <span class="n">asyncdispatch</span>
</pre></div></div>
</div>
<div id="uid11" data-tralics-id="uid11" class="subsection" data-number="4.2.2"><h3><a href="#uid11" class="heading hyperref"><span class="number">4.2.2 </span>Step 1: Data types</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span>
    <span class="n">LinkCheckResult</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> 
        <span class="n">link</span><span class="p">:</span> <span class="kt">string</span>
        <span class="n">state</span><span class="p">:</span> <span class="kt">bool</span>
</pre></div></div>
<p>LinkCheckResult is a simple representation for a link and its state</p>
</div>
<div id="uid12" data-tralics-id="uid12" class="subsection" data-number="4.2.3"><h3><a href="#uid12" class="heading hyperref"><span class="number">4.2.3 </span>Step 2: GO Sequential!</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">checkLink</span><span class="p">(</span><span class="n">link</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="n">LinkCheckResult</span>  <span class="o">=</span>
    <span class="kd">var</span> <span class="n">client</span> <span class="o">=</span> <span class="n">newHttpClient</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">link</span><span class="p">).</span><span class="n">code</span> <span class="o">==</span> <span class="n">Http200</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>
</pre></div></div>
<p>Here, we have a proc <code>checkLink</code> takes a link and returns <code>LinkCheckResult</code>
- <code>newHttpClient()</code> to create a new client
- <code>client.get</code> to send a get request to a link and it returns a response
- <code>response.code</code> gives us the HTTP status code, and we consider a link is valid if its status == 200
- <code>client.get</code> raises error for invalid structured links that’s why we wrapped it a <code>try/except</code> block</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">sequentialLinksChecker</span><span class="p">(</span><span class="n">links</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="kt">string</span><span class="o">]</span><span class="p">):</span> <span class="n">void</span> <span class="o">=</span> 
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">link</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s">""</span><span class="p">:</span>
            <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">checkLink</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
            <span class="n">echo</span> <span class="n">result</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="s">" is "</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">state</span>
</pre></div></div>
<p>Here, <code>sequentialLinksChecker</code> proc takes sequence of <code>links</code> and executes <code>checkLink</code> on them <code>sequentially</code></p>
<div class="code"><div class="highlight"><pre><span></span>LINKS: @["https://www.google.com.eg", "https://yahoo.com", "https://reddit.com", "https://none.nonadasdet", "https://github.com", ""]
SEQUENTIAL::
https://www.google.com.eg is true
https://yahoo.com is true
https://reddit.com is true
https://none.nonadasdet is false
https://github.com is true
7.716497898101807
</pre></div></div>
<p>On my lousy internet it took 7.7 seconds to finish :(</p>
</div>
<div id="uid13" data-tralics-id="uid13" class="subsection" data-number="4.2.4"><h3><a href="#uid13" class="heading hyperref"><span class="number">4.2.4 </span>Step 3: GO ASYNC!</a></h3>
<p class="noindent">We can do better than waiting on IO requests to finish</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">checkLinkAsync</span><span class="p">(</span><span class="n">link</span><span class="p">:</span> <span class="kt">string</span><span class="p">):</span> <span class="n">Future</span><span class="o">[</span><span class="n">LinkCheckResult</span><span class="o">]</span> <span class="p">{.</span><span class="n">async</span><span class="p">.}</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">client</span> <span class="o">=</span> <span class="n">newAsyncHttpClient</span><span class="p">()</span>

    <span class="k">let</span> <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">future</span>
    <span class="k">if</span> <span class="n">future</span><span class="p">.</span><span class="n">failed</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">let</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">future</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">resp</span><span class="p">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">Http200</span><span class="p">)</span> 
</pre></div></div>
<p>Here, we define a <code>checkLinkAsync</code> proc
- to declare a proc as async we use <code>async</code> pragma
- notice the client is of type <code>newAsyncHttpClient</code> that doesn’t block on <code>.get</code> calls
- <code>client.get</code> returns immediately a future that can either fail, and we can infer know that from <code>future.failed</code> or succeed
- <code>yield future</code> means okay i’m done for now dear <code>event loop</code> you can schedule other tasks and continue my execution when you have more update on my fancy <code>future</code>
when the eventloop comes back because the future now has some updates
- clearly, if the <code>future</code> failed we return the link with a <code>false</code> state
- otherwise, we get the <code>response</code> object that’s enclosed in the future by calling <code>read</code></p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">asyncLinksChecker</span><span class="p">(</span><span class="n">links</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="kt">string</span><span class="o">]</span><span class="p">)</span> <span class="p">{.</span><span class="n">async</span><span class="p">.}</span> <span class="o">=</span> 
    <span class="c"># client.maxRedirects = 0</span>
    <span class="kd">var</span> <span class="n">futures</span> <span class="o">=</span> <span class="n">newSeq</span><span class="o">[</span><span class="n">Future</span><span class="o">[</span><span class="n">LinkCheckResult</span><span class="o">]]</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">link</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s">""</span><span class="p">:</span>
            <span class="n">futures</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">checkLinkAsync</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
    
    <span class="c"># waitFor -&gt; call async proc from sync proc, await -&gt; call async proc from async proc</span>
    <span class="k">let</span> <span class="n">done</span> <span class="o">=</span> <span class="n">await</span> <span class="n">all</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
        <span class="n">echo</span> <span class="n">x</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="s">" is "</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">state</span>
</pre></div></div>
<p>Here, we have another async procedure <code>asyncLinksChecker</code> that will take a sequence of <code>links</code> and create futures for all of them and wait when they finish and give us some results
- <code>futures</code> is a sequence for the future results of all the <code>LinkCheckResults</code> for all the links passed to <code>asyncLinksChecker</code> proc
- we loop on the links and get <code>future</code> for the execution of <code>checkLinkAsync</code> and add it to the <code>futures</code> sequence.<span class="intersentencespace"></span> - we now ask to force to block until we get all of the results out of the futures into <code>done</code> variable
- then we print all the results
- Please notice <code>await</code> is used only to call <code>async</code> proc from another <code>async</code> proc, and <code>waitFor</code> is used to call <code>async</code> proc from <code>sync</code> proc</p>
<div class="code"><div class="highlight"><pre><span></span>ASYNC::
https://www.google.com.eg is true
https://yahoo.com is true
https://reddit.com is true
https://none.nonadasdet is false
https://github.com is true
 is false
3.601503849029541
</pre></div></div>
</div>
<div id="uid14" data-tralics-id="uid14" class="subsection" data-number="4.2.5"><h3><a href="#uid14" class="heading hyperref"><span class="number">4.2.5 </span>Step 4 simple cli</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">main</span><span class="p">()</span><span class="o">=</span>
    <span class="n">echo</span> <span class="s">"Param count: "</span><span class="p">,</span> <span class="n">paramCount</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">paramCount</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">let</span> <span class="n">linksfile</span> <span class="o">=</span> <span class="n">paramStr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="kd">var</span> <span class="n">f</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">linksfile</span><span class="p">,</span> <span class="n">fmRead</span><span class="p">)</span>
        <span class="k">let</span> <span class="n">links</span> <span class="o">=</span> <span class="n">readAll</span><span class="p">(</span><span class="n">f</span><span class="p">).</span><span class="n">splitLines</span><span class="p">()</span>
        <span class="n">echo</span> <span class="s">"LINKS: "</span> <span class="o">&amp;</span> <span class="o">$</span><span class="n">links</span>
        <span class="n">echo</span> <span class="s">"SEQUENTIAL:: "</span>
        <span class="kd">var</span> <span class="n">t</span> <span class="o">=</span> <span class="n">epochTime</span><span class="p">()</span>
        <span class="n">sequentialLinksChecker</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
        <span class="n">echo</span> <span class="n">epochTime</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>
        <span class="n">echo</span> <span class="s">"ASYNC:: "</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">epochTime</span><span class="p">()</span>
        <span class="n">waitFor</span> <span class="n">asyncLinksChecker</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
        <span class="n">echo</span> <span class="n">epochTime</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">echo</span> <span class="s">"Please provide linksfile"</span>
<span class="n">main</span><span class="p">()</span>
</pre></div></div>
<p>the only interesting part is <code>waitFor asyncLinksChecker(links)</code> as we said to call <code>async</code> proc from <code>sync</code> proc like this main proc you will need to use <code>waitFor</code></p>
</div>
<div id="uid15" data-tralics-id="uid15" class="subsection" data-number="4.2.6"><h3><a href="#uid15" class="heading hyperref"><span class="number">4.2.6 </span>Extra, threading</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">threadpool</span>
<span class="k">proc </span><span class="nf">checkLinkParallel</span><span class="p">(</span><span class="n">link</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="n">LinkCheckResult</span> <span class="p">{.</span><span class="n">thread</span><span class="p">.}</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">client</span> <span class="o">=</span> <span class="n">newHttpClient</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">link</span><span class="p">).</span><span class="n">code</span> <span class="o">==</span> <span class="n">Http200</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>
</pre></div></div>
<p>Same as before, only <code>thread</code> pragma i used to note that proc will be executed within a thread</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">threadsLinksChecker</span><span class="p">(</span><span class="n">links</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="kt">string</span><span class="o">]</span><span class="p">):</span> <span class="n">void</span> <span class="o">=</span> 
    <span class="kd">var</span> <span class="n">LinkCheckResults</span> <span class="o">=</span> <span class="n">newSeq</span><span class="o">[</span><span class="n">FlowVar</span><span class="o">[</span><span class="n">LinkCheckResult</span><span class="o">]]</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
        <span class="n">LinkCheckResults</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">spawn</span> <span class="n">checkLinkParallel</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>  
    
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">LinkCheckResults</span><span class="p">:</span>
        <span class="k">let</span> <span class="n">res</span> <span class="o">=</span> <span class="p">^</span><span class="n">x</span>
        <span class="n">echo</span> <span class="n">res</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="s">" is "</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">state</span>
</pre></div></div>
<p>- spawned <code>tasks</code> or <code>threads</code> returns a value of type <code>FlowVar[T]</code>, where <code>T</code> is the return value of the spawned <code>proc</code>
- To get the value of a <code>FlowVar</code> we use <code></code> operator.</p>
<blockquote class="quotation"><p class="quote">Note: you should use <code>nim.cfg</code> with flags <code>-d:ssl</code> to allow working with https</p>
</blockquote><p>Send me a PR for improvements</p>
</div></div>
<div id="cid13" data-tralics-id="cid13" class="chapter" data-number="5"><h1><a href="#cid13" class="heading hyperref"><span class="number">Chapter 5 </span>Day 5: Creating INI Parser</a></h1>
<p class="noindent">this is a pure <a href="https://en.wikipedia.org/wiki/Ini_file" target="_blank" rel="noopener">Ini</a> parser for nim</p>
<blockquote class="quotation"><p class="quote">Nim has advanced <a href="https://nim-lang.org/docs/parsecfg.html" target="_blank" rel="noopener">parsecfg</a></p>
</blockquote></div>
<div id="cid14" data-tralics-id="cid14" class="section" data-number="5.1"><h2><a href="#cid14" class="heading hyperref"><span class="number">5.1 </span>What to expect ?</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">sample1</span> <span class="o">=</span> <span class="s">"""</span>

<span class="s">[general]</span>
<span class="s">appname = configparser</span>
<span class="s">version = 0.1</span>

<span class="s">[author]</span>
<span class="s">name = xmonader</span>
<span class="s">email = notxmonader@gmail.com</span>


<span class="s">"""</span>

<span class="kd">var</span> <span class="n">d</span> <span class="o">=</span> <span class="n">parseIni</span><span class="p">(</span><span class="n">sample1</span><span class="p">)</span>

<span class="c"># doAssert(d.sectionsCount() == 2)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">"general"</span><span class="p">,</span> <span class="s">"appname"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"configparser"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">"general"</span><span class="p">,</span><span class="s">"version"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"0.1"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span><span class="s">"name"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"xmonader"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span><span class="s">"email"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"notxmonader@gmail.com"</span><span class="p">)</span>

<span class="n">d</span><span class="p">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span> <span class="s">"email"</span><span class="p">,</span> <span class="s">"alsonotxmonader@gmail.com"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span><span class="s">"email"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"alsonotxmonader@gmail.com"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">hasSection</span><span class="p">(</span><span class="s">"general"</span><span class="p">)</span> <span class="o">==</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">hasSection</span><span class="p">(</span><span class="s">"author"</span><span class="p">)</span> <span class="o">==</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">hasProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span> <span class="s">"name"</span><span class="p">)</span> <span class="o">==</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">d</span><span class="p">.</span><span class="n">deleteProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span> <span class="s">"name"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">hasProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span> <span class="s">"name"</span><span class="p">)</span> <span class="o">==</span> <span class="kp">false</span><span class="p">)</span>

<span class="n">echo</span> <span class="n">d</span><span class="p">.</span><span class="n">toIniString</span><span class="p">()</span>
<span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">getSection</span><span class="p">(</span><span class="s">"author"</span><span class="p">)</span>
<span class="n">echo</span> <span class="o">$</span><span class="n">s</span>
</pre></div></div>
</div>
<div id="cid15" data-tralics-id="cid15" class="section" data-number="5.2"><h2><a href="#cid15" class="heading hyperref"><span class="number">5.2 </span>Implementation</a></h2>
<p class="noindent">You can certainly use regular expressions, like pythons configparser, but we will go for a simpler approach here, also we want to keep it pure so we don’t depend on <code>pcre</code></p>
<div id="uid16" data-tralics-id="uid16" class="subsection" data-number="5.2.1"><h3><a href="#uid16" class="heading hyperref"><span class="number">5.2.1 </span>Ini sample</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">[general]</span>
<span class="na">appname</span> <span class="o">=</span> <span class="s">configparser</span>
<span class="na">version</span> <span class="o">=</span> <span class="s">0.1</span>

<span class="k">[author]</span>
<span class="na">name</span> <span class="o">=</span> <span class="s">xmonader</span>
<span class="na">email</span> <span class="o">=</span> <span class="s">notxmonader@gmail.com</span>
</pre></div></div>
<p>Ini file consists of one or more sections and each section consists of one or more key value pairs separated by <code>=</code></p>
</div>
<div id="uid17" data-tralics-id="uid17" class="subsection" data-number="5.2.2"><h3><a href="#uid17" class="heading hyperref"><span class="number">5.2.2 </span>Define your data types</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">tables</span><span class="p">,</span> <span class="n">strutils</span>
</pre></div></div>
<p>We will use tables extensively
</p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">Section</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Table</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="o">]</span>
</pre></div></div>
<p><code>Section</code> type contains <code>properties</code> table represents key value pairs</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">setProperty</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Section</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">this</span><span class="p">.</span><span class="n">properties</span><span class="o">[</span><span class="n">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
</pre></div></div>
<p>To set property in the underlying <code>properties</code> table</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">newSection</span><span class="o">*</span><span class="p">()</span> <span class="p">:</span> <span class="n">Section</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">s</span> <span class="o">=</span> <span class="n">Section</span><span class="p">()</span>
    <span class="n">s</span><span class="p">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">initTable</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="o">]</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">s</span>
</pre></div></div>
<p>To create new Section object</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">`$`</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Section</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="k">return</span> <span class="s">"&lt;Section"</span> <span class="o">&amp;</span> <span class="o">$</span><span class="n">this</span><span class="p">.</span><span class="n">properties</span> <span class="o">&amp;</span> <span class="s">" &gt;"</span>
</pre></div></div>
<p>Simple <code>toString</code> proc using <code>$</code> operator
</p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">Ini</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span>
    <span class="n">sections</span><span class="p">:</span> <span class="n">Table</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="n">Section</span><span class="o">]</span>
</pre></div></div>
<p><code>Ini</code> type represents the whole document and contains a table <code>section</code> from <code>sectionName</code> to <code>Section</code> object.</p>
<div class="code"><div class="highlight"><pre><span></span>proc newIni*() : Ini = 
    var ini = Ini()
    ini.sections = initTable[string, Section]()
    return ini
</pre></div></div>
<p>To craete new Ini object
</p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">`$`</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> 
    <span class="k">return</span> <span class="s">"&lt;Ini "</span> <span class="o">&amp;</span> <span class="o">$</span><span class="n">this</span><span class="p">.</span><span class="n">sections</span> <span class="o">&amp;</span> <span class="s">" &gt;"</span>
</pre></div></div>
<p>define friendly <code>toString</code> proc using <code>$</code> operator</p>
</div>
<div id="uid18" data-tralics-id="uid18" class="subsection" data-number="5.2.3"><h3><a href="#uid18" class="heading hyperref"><span class="number">5.2.3 </span>Define API</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span>proc setSection*(this: Ini, name: string, section: Section) =
    this.sections[name] = section

proc getSection*(this: Ini, name: string): Section =
    return this.sections.getOrDefault(name)

proc hasSection*(this: Ini, name: string): bool =
    return this.sections.contains(name)

proc deleteSection*(this: Ini, name:string) =
    this.sections.del(name)

proc sectionsCount*(this: Ini) : int = 
    echo $this.sections
    return len(this.sections)
</pre></div></div>
<p>Some helper procs around Ini objects for manipulating sections.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">hasProperty</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="kt">string</span><span class="p">):</span> <span class="kt">bool</span><span class="o">=</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sectionName</span><span class="p">)</span> <span class="ow">and</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="o">[</span><span class="n">sectionName</span><span class="o">]</span><span class="p">.</span><span class="n">properties</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">proc </span><span class="nf">setProperty</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span><span class="kt">string</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">echo</span> <span class="o">$</span><span class="n">this</span><span class="p">.</span><span class="n">sections</span>
    <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sectionName</span><span class="p">):</span>
        <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="o">[</span><span class="n">sectionName</span><span class="o">]</span><span class="p">.</span><span class="n">setProperty</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">newException</span><span class="p">(</span><span class="n">ValueError</span><span class="p">,</span> <span class="s">"Ini doesn't have section "</span> <span class="o">&amp;</span> <span class="n">sectionName</span><span class="p">)</span>

<span class="k">proc </span><span class="nf">getProperty</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sectionName</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="o">[</span><span class="n">sectionName</span><span class="o">]</span><span class="p">.</span><span class="n">properties</span><span class="p">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">newException</span><span class="p">(</span><span class="n">ValueError</span><span class="p">,</span> <span class="s">"Ini doesn't have section "</span> <span class="o">&amp;</span> <span class="n">sectionName</span><span class="p">)</span>


<span class="k">proc </span><span class="nf">deleteProperty</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sectionName</span><span class="p">)</span> <span class="ow">and</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="o">[</span><span class="n">sectionName</span><span class="o">]</span><span class="p">.</span><span class="n">properties</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="o">[</span><span class="n">sectionName</span><span class="o">]</span><span class="p">.</span><span class="n">properties</span><span class="p">.</span><span class="n">del</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">newException</span><span class="p">(</span><span class="n">ValueError</span><span class="p">,</span> <span class="s">"Ini doesn't have section "</span> <span class="o">&amp;</span> <span class="n">sectionName</span><span class="p">)</span>
</pre></div></div>
<p>More helpers around properties in the section objects managed by <code>Ini</code> object</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">toIniString</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">,</span> <span class="n">sep</span><span class="p">:</span><span class="kt">char</span><span class="o">=</span><span class="sc">'='</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">output</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">sectName</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">&amp;=</span> <span class="s">"["</span> <span class="o">&amp;</span> <span class="n">sectName</span> <span class="o">&amp;</span> <span class="s">"]"</span> <span class="o">&amp;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">section</span><span class="p">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">&amp;=</span> <span class="n">k</span> <span class="o">&amp;</span> <span class="n">sep</span> <span class="o">&amp;</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span> 
        <span class="n">output</span> <span class="o">&amp;=</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
    <span class="k">return</span> <span class="n">output</span>
</pre></div></div>
<p>Simple proc <code>toIniString</code> to convert the nim structures into Ini text string</p>
</div>
<div id="uid19" data-tralics-id="uid19" class="subsection" data-number="5.2.4"><h3><a href="#uid19" class="heading hyperref"><span class="number">5.2.4 </span>Parse!</a></h3>
<p class="noindent">OK, here comes the cool part</p>
<div id="uid20" data-tralics-id="uid20" class="subsubsection" data-number="5.2.4.1"><h4><a href="#uid20" class="heading">Parser states</a></h4>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">ParserState</span> <span class="o">=</span> <span class="k">enum</span>
    <span class="n">readSection</span><span class="p">,</span> <span class="n">readKV</span>
</pre></div></div>
<p>Here we have two states
- readSection: when we are supposed to extract section name from the current line
- readKV: when we are supposed to read the line in key value pair mode</p>
</div>
<div id="uid21" data-tralics-id="uid21" class="subsubsection" data-number="5.2.4.2"><h4><a href="#uid21" class="heading">ParseIni proc</a></h4>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">parseIni</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="n">Ini</span> <span class="o">=</span> 
</pre></div></div>
<p>Here we define a proc <code>parseIni</code> that takes a string <code>s</code> and creates an <code>Ini</code> object</p>
<div class="code"><div class="highlight"><pre><span></span>    <span class="kd">var</span> <span class="n">ini</span> <span class="o">=</span> <span class="n">newIni</span><span class="p">()</span>
    <span class="kd">var</span> <span class="n">state</span><span class="p">:</span> <span class="n">ParserState</span> <span class="o">=</span> <span class="n">readSection</span>
    <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">splitLines</span>
    
    <span class="kd">var</span> <span class="n">currentSectionName</span><span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="s">""</span>
    <span class="kd">var</span> <span class="n">currentSection</span> <span class="o">=</span> <span class="n">newSection</span><span class="p">()</span>
<span class="p">```</span> 
<span class="o">-</span> <span class="p">`</span><span class="n">ini</span><span class="p">`</span> <span class="ow">is</span> <span class="n">the</span> <span class="k">object</span> <span class="n">to</span> <span class="n">be</span> <span class="n">returned</span> <span class="n">after</span> <span class="n">parsing</span>
<span class="o">-</span> <span class="p">`</span><span class="n">state</span><span class="p">`</span> <span class="n">the</span> <span class="n">current</span> <span class="n">parser</span> <span class="n">state</span> <span class="p">(</span><span class="n">weather</span> <span class="n">it</span><span class="sc">'s `readSection` or `readKV`)</span>
<span class="o">-</span> <span class="p">`</span><span class="n">lines</span><span class="p">`</span> <span class="n">input</span> <span class="kt">string</span> <span class="n">splitted</span> <span class="n">into</span> <span class="n">lines</span> <span class="p">`</span><span class="k">as</span> <span class="n">we</span> <span class="n">are</span> <span class="n">a</span> <span class="n">lines</span> <span class="n">based</span> <span class="n">parser</span><span class="p">`</span>
<span class="o">-</span> <span class="p">`</span><span class="n">currentSectionName</span><span class="p">`</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">track</span> <span class="k">of</span> <span class="n">what</span> <span class="n">section</span> <span class="n">we</span> <span class="n">are</span> <span class="n">currently</span> <span class="ow">in</span>
<span class="o">-</span> <span class="p">`</span><span class="n">currentSection</span><span class="p">`</span> <span class="n">to</span> <span class="n">populate</span> <span class="p">`</span><span class="n">ini</span><span class="p">.</span><span class="n">sections</span><span class="p">`</span> <span class="k">with</span> <span class="p">`</span><span class="n">Section</span><span class="p">`</span> <span class="k">object</span> <span class="n">using</span> <span class="p">`</span><span class="n">setSection</span><span class="p">`</span> <span class="k">proc</span>

<span class="p">```</span><span class="n">nim</span>
   <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
<span class="p">```</span>
<span class="k">for</span> <span class="n">each</span> <span class="n">line</span> 
<span class="p">```</span><span class="n">nim</span>
         <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">""</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">";"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">"#"</span><span class="p">):</span>
            <span class="k">continue</span>
<span class="p">```</span>
<span class="n">We</span> <span class="k">continue</span> <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="n">safe</span> <span class="n">to</span> <span class="n">igore</span> <span class="p">`</span><span class="n">empty</span> <span class="n">line</span><span class="p">`</span> <span class="ow">or</span> <span class="n">starts</span> <span class="k">with</span> <span class="p">`;`</span> <span class="ow">or</span> <span class="p">`</span><span class="c">#`</span>

<span class="p">```</span><span class="n">nim</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">"["</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line</span><span class="p">.</span><span class="n">endsWith</span><span class="p">(</span><span class="s">"]"</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">readSection</span>
<span class="p">```</span>
<span class="k">if</span> <span class="n">line</span> <span class="n">startswith</span> <span class="p">`</span><span class="o">[</span><span class="p">`</span> <span class="ow">and</span> <span class="n">ends</span> <span class="k">with</span> <span class="p">`</span><span class="o">]</span><span class="p">`</span> <span class="n">then</span> <span class="n">we</span> <span class="kt">set</span> <span class="n">parser</span> <span class="n">state</span> <span class="n">to</span> <span class="p">`</span><span class="n">readSection</span><span class="p">`</span>

<span class="p">```</span><span class="n">nim</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">readSection</span><span class="p">:</span>
            <span class="n">currentSectionName</span> <span class="o">=</span> <span class="n">line</span><span class="o">[</span><span class="mf">1</span><span class="p">..</span><span class="o">&lt;</span><span class="n">line</span><span class="p">.</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
            <span class="n">ini</span><span class="p">.</span><span class="n">setSection</span><span class="p">(</span><span class="n">currentSectionName</span><span class="p">,</span> <span class="n">currentSection</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">readKV</span>
            <span class="k">continue</span>
<span class="p">```</span>
<span class="k">if</span> <span class="n">parser</span> <span class="p">`</span><span class="n">state</span><span class="p">`</span> <span class="ow">is</span> <span class="p">`</span><span class="n">readSection</span><span class="p">`</span>
<span class="o">-</span> <span class="n">extract</span> <span class="n">section</span> <span class="n">name</span> <span class="p">`</span><span class="n">between</span> <span class="o">[</span> <span class="ow">and</span> <span class="o">]</span><span class="p">`</span>
<span class="o">-</span> <span class="n">add</span> <span class="n">section</span> <span class="k">object</span> <span class="n">to</span> <span class="n">the</span> <span class="n">ini</span> <span class="n">under</span> <span class="n">the</span> <span class="n">current</span> <span class="n">section</span> <span class="n">name</span>
<span class="o">-</span> <span class="n">change</span> <span class="p">`</span><span class="n">state</span><span class="p">`</span> <span class="n">to</span> <span class="p">`</span><span class="n">readKV</span><span class="p">`</span> <span class="n">to</span> <span class="n">read</span> <span class="n">key</span> <span class="n">value</span> <span class="n">pairs</span>
<span class="o">-</span> <span class="k">continue</span> <span class="n">the</span> <span class="n">loop</span> <span class="n">on</span> <span class="n">the</span> <span class="n">nextline</span> <span class="k">as</span> <span class="n">we</span><span class="sc">'re done processing the section name.</span>

<span class="p">```</span><span class="n">nim</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">readKV</span><span class="p">:</span>
            <span class="k">let</span> <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">({</span><span class="sc">'='</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">let</span> <span class="n">key</span> <span class="o">=</span> <span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">let</span> <span class="n">val</span> <span class="o">=</span> <span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">ini</span><span class="p">.</span><span class="n">setProperty</span><span class="p">(</span><span class="n">currentSectionName</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<span class="p">```</span>
<span class="k">if</span> <span class="p">`</span><span class="n">state</span><span class="p">`</span> <span class="ow">is</span> <span class="p">`</span><span class="n">readKV</span><span class="p">`</span> 
<span class="o">-</span> <span class="n">extract</span> <span class="p">`</span><span class="n">key</span><span class="p">`</span> <span class="ow">and</span> <span class="p">`</span><span class="n">val</span><span class="p">`</span> <span class="n">by</span> <span class="n">splitting</span> <span class="n">the</span> <span class="n">line</span> <span class="n">on</span> <span class="p">`</span><span class="o">=</span><span class="p">`</span>
<span class="o">-</span> <span class="p">`</span><span class="n">setProperty</span><span class="p">`</span> <span class="n">under</span> <span class="n">the</span> <span class="p">`</span><span class="n">currentSectionName</span><span class="p">`</span> <span class="n">using</span> <span class="p">`</span><span class="n">key</span><span class="p">`</span> <span class="ow">and</span> <span class="p">`</span><span class="n">val</span><span class="p">`</span>
<span class="p">```</span><span class="n">nim</span>
    <span class="k">return</span> <span class="n">ini</span>
<span class="p">```</span>
<span class="n">Here</span> <span class="n">we</span> <span class="k">return</span> <span class="n">the</span> <span class="n">populated</span> <span class="p">`</span><span class="n">ini</span><span class="p">`</span> <span class="k">object</span><span class="p">.</span>


<span class="c"># Thanks </span>
<span class="n">To</span> <span class="n">you</span> <span class="k">for</span> <span class="n">taking</span> <span class="n">the</span> <span class="n">time</span> <span class="n">to</span> <span class="n">read</span> <span class="n">the</span> <span class="n">tutorial</span> <span class="ow">and</span> <span class="n">thanks</span> <span class="n">to</span> <span class="n">everyone</span> <span class="n">at</span> <span class="c">#nim on gitter for their valuable reviews.</span>
<span class="n">Feel</span> <span class="n">free</span> <span class="n">to</span> <span class="n">send</span> <span class="n">me</span> <span class="n">PRs</span> <span class="n">to</span> <span class="n">make</span> <span class="n">this</span> <span class="n">tutorial</span><span class="o">/</span><span class="n">library</span> <span class="n">better</span> <span class="p">:)</span>
</pre></div></div>
</div></div></div>
<div id="cid16" data-tralics-id="cid16" class="chapter" data-number="6"><h1><a href="#cid16" class="heading hyperref"><span class="number">Chapter 6 </span>Day 6: Manage your dotfiles easily with nistow</a></h1>
<p class="noindent">Today we will create a tool to manage our dotfiles easily.</p>
</div>
<div id="cid17" data-tralics-id="cid17" class="section" data-number="6.1"><h2><a href="#cid17" class="heading hyperref"><span class="number">6.1 </span>Dotfiles layout</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span>        i3
        `-- .config
            `-- i3
                `-- config
</pre></div></div>
<p>So we have here a directory named i3 in the very top <code>indicates APP_NAME</code> and under it a tree of config paths.<span class="intersentencespace"></span> Here it means <code>config</code> file is supposed to be linked under <code>.config/i3/config</code> relative to <code>destination directory</code>
&gt; Home directory is the default destination.</p>
</div>
<div id="cid18" data-tralics-id="cid18" class="section" data-number="6.2"><h2><a href="#cid18" class="heading hyperref"><span class="number">6.2 </span>What do we expect?</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span>➜  ~ nistow --help
    Stow 0.1.0
        -h | --help     : show help
        -v | --version  : show version
        --verbose       : verbose messages
        -s | --simulate : simulate stow operation
        -f | --force    : override old links
        -a | --app      : application path to stow
        -d | --dest     : destination to stow to
</pre></div></div>
<p>- <code>–simulate</code> flag used to simulate on the filesystem without actual linking
- <code>–app</code> application directory that’s compatible with the dotfiles layoud described above.<span class="intersentencespace"></span> - <code>–dest</code> destination to symlink files under, defaults to home dir.</p>
<div class="code"><div class="highlight"><pre><span></span>nistow --app=/home/striky/wspace/dotfiles/localdir --dest=/tmp/tmpconf --verbose
</pre></div></div>
</div>
<div id="cid19" data-tralics-id="cid19" class="section" data-number="6.3"><h2><a href="#cid19" class="heading hyperref"><span class="number">6.3 </span>Implementation</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">writeHelp</span><span class="p">()</span> <span class="o">=</span> 
    <span class="n">echo</span> <span class="s">"""</span>
<span class="s">Stow 0.1.0 (Manage your dotfiles easily)</span>

<span class="s">Allowed arguments:</span>
<span class="s">    -h | --help     : show help</span>
<span class="s">    -v | --version  : show version</span>
<span class="s">    --verbose       : verbose messages</span>
<span class="s">    -s | --simulate : simulate stow operation</span>
<span class="s">    -f | --force    : override old links</span>
<span class="s">    -a | --app      : application path to stow</span>
<span class="s">    -d | --dest     : destination to stow to</span>

<span class="s">    """</span>
</pre></div></div>
<p><code>writeHelp</code> is a simple proc to write help string to the stdout</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">writeVersion</span><span class="p">()</span> <span class="o">=</span>
    <span class="n">echo</span> <span class="s">"Stow version 0.1.0"</span>
</pre></div></div>
<p>To write version</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">cli</span><span class="o">*</span><span class="p">()</span> <span class="o">=</span>
</pre></div></div>
<p>Entry point for out commandline application</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="kd">var</span> 
    <span class="n">simulate</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="kp">false</span>
    <span class="n">app</span><span class="p">,</span> <span class="n">dest</span><span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="s">""</span>
</pre></div></div>
<p>Variables represents various options we allow in the application.</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="k">if</span> <span class="n">paramCount</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">writeHelp</span><span class="p">()</span>
    <span class="n">quit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div></div>
<p>If no arguments passed we will write the help string and <code>exit</code> or <code>quit</code> according to nim with <code>exit status</code> 0</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="k">for</span> <span class="n">kind</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">getopt</span><span class="p">():</span>
    <span class="k">case</span> <span class="n">kind</span>
    <span class="k">of</span> <span class="n">cmdLongOption</span><span class="p">,</span> <span class="n">cmdShortOption</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">key</span>
        <span class="k">of</span> <span class="s">"help"</span><span class="p">,</span> <span class="s">"h"</span><span class="p">:</span> 
            <span class="n">writeHelp</span><span class="p">()</span>
            <span class="n">quit</span><span class="p">()</span>
        <span class="k">of</span> <span class="s">"version"</span><span class="p">,</span> <span class="s">"v"</span><span class="p">:</span>
            <span class="n">writeVersion</span><span class="p">()</span>
            <span class="n">quit</span><span class="p">()</span>
        <span class="k">of</span> <span class="s">"simulate"</span><span class="p">,</span> <span class="s">"s"</span><span class="p">:</span> <span class="n">simulate</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="k">of</span> <span class="s">"verbose"</span><span class="p">:</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="k">of</span> <span class="s">"force"</span><span class="p">,</span> <span class="s">"f"</span><span class="p">:</span> <span class="n">force</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="k">of</span> <span class="s">"app"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">:</span> <span class="n">app</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">of</span> <span class="s">"dest"</span><span class="p">,</span> <span class="s">"d"</span><span class="p">:</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">val</span> 
        <span class="k">else</span><span class="p">:</span>
          <span class="k">discard</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">discard</span> 
</pre></div></div>
<p>Here we parse the commandline string using <code>getopt</code>.<span class="intersentencespace"></span> </p><div class="code"><div class="highlight"><pre><span></span>  <span class="k">for</span> <span class="n">kind</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">getopt</span><span class="p">():</span>
    <span class="k">case</span> <span class="n">kind</span>
    <span class="k">of</span> <span class="n">cmdLongOption</span><span class="p">,</span> <span class="n">cmdShortOption</span><span class="p">:</span>
</pre></div></div>
<p>So for <code>–app=/home/striky/dotfiles/i3 -f</code>
kind for <code>–app</code> is <code>cmdLongOption</code> and for <code>-f</code> is <code>cmdShortOption</code>
key for <code>–app</code> is <code>app</code> and for <code>-f</code> is <code>f</code>
val for <code>–app</code> is <code>/home/striky/dotfiles/i3</code>
val for <code>-f</code> we set to <code>true</code> in our parsing, because it’s mainly like a switch <code>boolean</code> if it exists it means we want it set to true.</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="k">if</span> <span class="n">dest</span><span class="p">.</span><span class="n">isNilOrEmpty</span><span class="p">():</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">getHomeDir</span><span class="p">()</span>
</pre></div></div>
<p>Here we set default <code>dest</code> to homeDir
</p><div class="code"><div class="highlight"><pre><span></span>  <span class="k">if</span> <span class="n">app</span><span class="p">.</span><span class="n">isNilOrEmpty</span><span class="p">():</span>
    <span class="n">echo</span> <span class="s">"Make sure to provide --app flags"</span>
    <span class="n">quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div></div>
<p>Here we exit with error <code>exit status</code> 1 if app isn’t set.</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="k">try</span><span class="p">:</span>
    <span class="n">stow</span><span class="p">(</span><span class="n">getLinkableFiles</span><span class="p">(</span><span class="n">appPath</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">dest</span><span class="p">),</span> <span class="n">simulate</span><span class="o">=</span><span class="n">simulate</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
  <span class="k">except</span> <span class="n">ValueError</span><span class="p">:</span>
    <span class="n">echo</span> <span class="s">"Error happened: "</span> <span class="o">&amp;</span> <span class="n">getCurrentExceptionMsg</span><span class="p">()</span>
</pre></div></div>
<p>Here we try to stow all the linkable files in <code>app</code> dir to <code>dest</code> dir and pass all the options we collected from the command line arguments <code>simulate</code>, <code>verbose</code>, <code>force</code>, and wrapped around <code>try/except</code> to show error to the user</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">when</span> <span class="n">isMainModule</span><span class="p">:</span>
  <span class="n">cli</span><span class="p">()</span>
</pre></div></div>
<p>invoke our entry point <code>cli</code> if this module is the main module.</p>
<p>OK! back to stow and getLinkableFiles</p>
<p>We start with <code>getLinkableFiles</code>.<span class="intersentencespace"></span> Remember the dotfiles hierarchy?<span class="intersentencespace"></span> </p><div class="code"><div class="highlight"><pre><span></span>    # appPath: application's dotfiles directory
    #     we expect dir to have the hierarchy.
    #     i3
    #     `-- .config
    #         `-- i3
    #         `-- config
</pre></div></div>
<p>We want to get all the files in there with full path and the link file to each one will be exactly the same except for the <code>appPath</code> name will be changed to <code>dest</code> path</p>
<div class="code"><div class="highlight"><pre><span></span>[/home/striky/wspace/dotfiles/i3]/.config/i3/config -&gt; [/home/striky]/.config/i3/config
__________________appPath________                      _____dest____
</pre></div></div>
<div class="code"><div class="highlight"><pre><span></span><span class="k">type</span>
  <span class="n">LinkInfo</span> <span class="o">=</span> <span class="k">tuple</span><span class="o">[</span><span class="n">original</span><span class="p">:</span><span class="kt">string</span><span class="p">,</span> <span class="n">dest</span><span class="p">:</span><span class="kt">string</span><span class="o">]</span> 
</pre></div></div>
<p>Simple type to represent the original path and where to symlink to</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">getLinkableFiles</span><span class="o">*</span><span class="p">(</span><span class="n">appPath</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">dest</span><span class="p">:</span> <span class="kt">string</span><span class="o">=</span><span class="n">expandTilde</span><span class="p">(</span><span class="s">"~"</span><span class="p">)):</span> <span class="kt">seq</span><span class="o">[</span><span class="n">LinkInfo</span><span class="o">]</span> <span class="o">=</span>

    <span class="c"># collects the linkable files in a certain app.</span>

    <span class="c"># appPath: application's dotfiles directory</span>
    <span class="c">#     we expect dir to have the hierarchy.</span>
    <span class="c">#     i3</span>
    <span class="c">#     `-- .config</span>
    <span class="c">#         `-- i3</span>
    <span class="c">#         `-- config</span>

    <span class="c"># dest: destination of the link files : default is the home of user.</span>
</pre></div></div>
<p><code>getLinkableFiles</code> is a proc takes <code>appPath</code> and <code>dest</code> and returns a <code>seq</code> of LinkInfo contains this transformation for each file.</p>
<div class="code"><div class="highlight"><pre><span></span>[/home/striky/wspace/dotfiles/i3]/A_FILE_PATH -&gt; [/home/striky]A_FILE_PATH
__________________apppath________                _____dest____
</pre></div></div>
<div class="code"><div class="highlight"><pre><span></span>  <span class="kd">var</span> <span class="n">appPath</span> <span class="o">=</span> <span class="n">expandTilde</span><span class="p">(</span><span class="n">appPath</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">dirExists</span><span class="p">(</span><span class="n">appPath</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">newException</span><span class="p">(</span><span class="n">ValueError</span><span class="p">,</span> <span class="n">fmt</span><span class="p">(</span><span class="s">"App path {appPath} doesn't exist."</span><span class="p">))</span>
  <span class="kd">var</span> <span class="n">linkables</span> <span class="o">=</span> <span class="n">newSeq</span><span class="o">[</span><span class="n">LinkInfo</span><span class="o">]</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">walkDirRec</span><span class="p">(</span><span class="n">appPath</span><span class="p">,</span> <span class="n">yieldFilter</span><span class="o">=</span><span class="p">{</span><span class="n">pcFile</span><span class="p">}):</span>
    <span class="k">let</span> <span class="n">linkpath</span> <span class="o">=</span> <span class="n">filepath</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">appPath</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
    <span class="kd">var</span> <span class="n">linkInfo</span> <span class="p">:</span> <span class="n">LinkInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">original</span><span class="p">:</span><span class="n">filepath</span><span class="p">,</span> <span class="n">dest</span><span class="p">:</span><span class="n">linkpath</span><span class="p">)</span>
    <span class="n">linkables</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">linkInfo</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">linkables</span>
</pre></div></div>
<p>Here, we walk over the <code>appPath</code> dir using <code>walkDirRec</code> and specify in <code>yieldFilter</code> argument that we’re interested in <code>pcFile</code> “file path component”, just call it entries of type regular file.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">stow</span><span class="p">(</span><span class="n">linkables</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="n">LinkInfo</span><span class="o">]</span><span class="p">,</span> <span class="n">simulate</span><span class="p">:</span> <span class="kt">bool</span><span class="o">=</span><span class="kp">true</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="kt">bool</span><span class="o">=</span><span class="kp">true</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="kt">bool</span><span class="o">=</span><span class="kp">false</span><span class="p">)</span> <span class="o">=</span> 
    <span class="c"># Creates symoblic links and related directories</span>

    <span class="c"># linkables is a list of tuples (filepath, linkpath) : List[Tuple[file_path, link_path]]</span>
    <span class="c"># simulate does simulation with no effect on the filesystem: bool</span>
    <span class="c"># verbose shows log messages: bool</span>

  <span class="k">for</span> <span class="n">linkinfo</span> <span class="ow">in</span> <span class="n">linkables</span><span class="p">:</span>
    <span class="k">let</span> <span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">linkpath</span><span class="p">)</span> <span class="o">=</span> <span class="n">linkinfo</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
      <span class="n">echo</span><span class="p">(</span><span class="n">fmt</span><span class="p">(</span><span class="s">"Will link {filepath} -&gt; {linkpath}"</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">simulate</span><span class="p">:</span>
      <span class="n">createDir</span><span class="p">(</span><span class="n">parentDir</span><span class="p">(</span><span class="n">linkpath</span><span class="p">))</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">fileExists</span><span class="p">(</span><span class="n">linkpath</span><span class="p">):</span>
        <span class="n">createSymlink</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">linkpath</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
          <span class="n">removeFile</span><span class="p">(</span><span class="n">linkpath</span><span class="p">)</span>
          <span class="n">createSymlink</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">linkpath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">echo</span><span class="p">(</span><span class="n">fmt</span><span class="p">(</span><span class="s">"Skipping linking {filepath} -&gt; {linkpath}"</span><span class="p">))</span>
</pre></div></div>
<p>Stow is pretty easy procedure, it takes in a list of <code>LinksInfo</code> that has all the information (original filename and destination symlink) and does the symlinking based on if it’s not a simulation and prints the messages if verbose is set to true</p>
<p>Feel free to send improvements to this tutorial or nistow :)</p>
</div>
    </div>
  </body>
</html>
