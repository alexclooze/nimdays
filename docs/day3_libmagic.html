<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link href="stylesheets/pygments.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="stylesheets/softcover.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="stylesheets/custom.css" media="screen" rel="stylesheet" type="text/css" />
    
    <title>nimdays</title>
    
      <script type="text/x-mathjax-config">
              MathJax.Hub.Config({
        "HTML-CSS": {
          availableFonts: ["TeX"],
        },
        TeX: {
          extensions: ["AMSmath.js", "AMSsymbols.js", "color.js"],
          equationNumbers: {
            autoNumber: "AMS",
            formatNumber: function (n) { return "3" + '.' + n }
          },
          Macros: {
            PolyTeX:    "Poly{\\TeX}",
            PolyTeXnic: "Poly{\\TeX}nic",
            "softcover": "\\texttt{softcover}",
"unitvec": ["{\\hat #1}", 1]
          }
        },
        showProcessingMessages: false,
        messageStyle: "none",
        imageFont: null,
        "AssistiveMML": { disabled: true }
      });

        if (/PhantomJS/.test(window.navigator.userAgent)) {
          MathJax.Hub.Queue([alert, 'MathJax Done']);
        }
      </script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_SVG"></script>
    
  </head>
  <body>
    
    <div id="book">
      <div id="cid7" data-tralics-id="cid7" class="chapter" data-number="3" data-chapter="day3_libmagic"><h1><a href="day3_libmagic.html#cid7" class="heading hyperref"><span class="number">Chapter 3 </span>Day 3: Talking to C (FFI and libmagic)</a></h1>
<p class="noindent">Libmagic is a magic number recognition library, remember everytime you called <code>file</code> utility on a file to know its type?</p>
<div class="code"><div class="highlight"><pre><span></span>➜  file /usr/bin/rm
/usr/bin/rm: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=cbae26b2a032b1ce3129d56aee2bcf70dd8deeb0, stripped
➜  nim-magic file /
/: directory
➜  file /usr/include/stdio.h
/usr/include/stdio.h: C source, ASCII text
</pre></div></div>
</div>
<div id="cid8" data-tralics-id="cid8" class="section" data-number="3.1"><h2><a href="day3_libmagic.html#cid8" class="heading hyperref"><span class="number">3.1 </span>What to expect?</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">magic</span>

<span class="n">echo</span> <span class="n">magic</span><span class="p">.</span><span class="n">guessFile</span><span class="p">(</span><span class="s">"/usr/bin/rm"</span><span class="p">)</span>
</pre></div></div>
<p>The output should be something like
</p><div class="code"><div class="highlight"><pre><span></span>ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=cbae26b2a032b1ce3129d56aee2bcf70dd8deeb0, stripped
</pre></div></div>
</div>
<div id="cid9" data-tralics-id="cid9" class="section" data-number="3.2"><h2><a href="day3_libmagic.html#cid9" class="heading hyperref"><span class="number">3.2 </span>Implementation</a></h2>
<p class="noindent"><a href="https://livebook.manning.com/#!/book/nim-in-action/chapter-8/1" target="_blank" rel="noopener">FFI Chapter</a> of <a href="https://www.manning.com/books/nim-in-action" target="_blank" rel="noopener">Nim in Action</a> is freely available.</p>
<div id="uid37" data-tralics-id="uid37" class="subsection" data-number="3.2.1"><h3><a href="day3_libmagic.html#uid37" class="heading hyperref"><span class="number">3.2.1 </span>Step 1: Get the library info</a></h3>
<p class="noindent">Well, libmagic has <code>libmagic.so</code> in your library path <code>/usr/lib/libmagic.so</code> and a header file <code>magic.h</code> in <code>/usr/include/magic.h</code>.<span class="intersentencespace"></span> create a constant for the libmagic library name.<span class="intersentencespace"></span> </p><div class="code"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">libName</span><span class="o">*</span> <span class="o">=</span> <span class="s">"libmagic.so"</span>
</pre></div></div>
</div>
<div id="uid38" data-tralics-id="uid38" class="subsection" data-number="3.2.2"><h3><a href="day3_libmagic.html#uid38" class="heading hyperref"><span class="number">3.2.2 </span>Step 2: Extract constants</a></h3>
<p class="noindent">We should extract the constants from the header</p>
<div class="code"><div class="highlight"><pre><span></span><span class="cp">#define MAGIC_NONE              0x0000000 </span><span class="cm">/* No flags */</span><span class="cp"></span>
<span class="cp">#define MAGIC_DEBUG             0x0000001 </span><span class="cm">/* Turn on debugging */</span><span class="cp"></span>
<span class="cp">#define MAGIC_SYMLINK           0x0000002 </span><span class="cm">/* Follow symlinks */</span><span class="cp"></span>
<span class="cp">#define MAGIC_COMPRESS          0x0000004 </span><span class="cm">/* Check inside compressed files */</span><span class="cp"></span>
<span class="cp">#define MAGIC_DEVICES           0x0000008 </span><span class="cm">/* Look at the contents of devices */</span><span class="cp"></span>
<span class="cp">#define MAGIC_MIME_TYPE         0x0000010 </span><span class="cm">/* Return the MIME type */</span><span class="cp"></span>
<span class="cp">#define MAGIC_CONTINUE          0x0000020 </span><span class="cm">/* Return all matches */</span><span class="cp"></span>
<span class="cp">#define MAGIC_CHECK             0x0000040 </span><span class="cm">/* Print warnings to stderr */</span><span class="cp"></span>
<span class="p">....</span>
</pre></div></div>
<p>So in nim It’d be something like this
</p><div class="code"><div class="highlight"><pre><span></span><span class="k">const</span>  <span class="n">MAGIC_NONE</span><span class="o">*</span>  <span class="o">=</span> <span class="mh">0x000000</span>                 <span class="c"># No flags </span>
<span class="k">const</span>  <span class="n">MAGIC_DEBUG</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000001</span>                 <span class="c"># Turn on debugging </span>
<span class="k">const</span>  <span class="n">MAGIC_SYMLINK</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000002</span>                 <span class="c"># Follow symlinks </span>
<span class="k">const</span>  <span class="n">MAGIC_COMPRESS</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000004</span>                <span class="c"># Check inside compressed files </span>
<span class="k">const</span>  <span class="n">MAGIC_DEVICES</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000008</span>                 <span class="c"># Look at the contents of devices </span>
<span class="k">const</span>  <span class="n">MAGIC_MIME_TYPE</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000010</span>            <span class="c"># Return only the MIME type </span>
<span class="k">const</span>  <span class="n">MAGIC_CONTINUE</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000020</span>             <span class="c"># Return all matches </span>
<span class="k">const</span>  <span class="n">MAGIC_CHECK</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000040</span>                 <span class="c"># Print warnings to stderr </span>
<span class="k">const</span>  <span class="n">MAGIC_PRESERVE_ATIME</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000080</span>        <span class="c"># Restore access time on exit </span>
<span class="k">const</span>  <span class="n">MAGIC_RAW</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000100</span>                    <span class="c"># Don't translate unprint chars </span>
<span class="k">const</span>  <span class="n">MAGIC_ERROR</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000200</span>                 <span class="c"># Handle ENOENT etc as real errors </span>
<span class="k">const</span>  <span class="n">MAGIC_MIME_ENCODING</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000400</span>         <span class="c"># Return only the MIME encoding </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_COMPRESS</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x001000</span>     <span class="c"># Don't check for compressed files </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_TAR</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x002000</span>         <span class="c"># Don't check for tar files </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_SOFT</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x004000</span>         <span class="c"># Don't check magic entries </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_APPTYPE</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x008000</span>        <span class="c"># Don't check application type </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_ELF</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x010000</span>            <span class="c"># Don't check for elf details </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_ASCII</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x020000</span>         <span class="c"># Don't check for ascii files </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_TOKENS</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x100000</span>         <span class="c"># Don't check ascii/tokens </span>
</pre></div></div>
</div>
<div id="uid39" data-tralics-id="uid39" class="subsection" data-number="3.2.3"><h3><a href="day3_libmagic.html#uid39" class="heading hyperref"><span class="number">3.2.3 </span>Step 3: Extract the types</a></h3>
<p class="noindent"><code>typedef struct magic_set *magic_t;</code>
so the only type we have is a pointer to some struct (object)</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">Magic</span> <span class="o">=</span> <span class="k">object</span>
<span class="k">type</span> <span class="n">MagicPtr</span><span class="o">*</span> <span class="o">=</span> <span class="k">ptr</span> <span class="n">Magic</span> 
</pre></div></div>
</div>
<div id="uid40" data-tralics-id="uid40" class="subsection" data-number="3.2.4"><h3><a href="day3_libmagic.html#uid40" class="heading hyperref"><span class="number">3.2.4 </span>Step 4: Extract procedures</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="n">magic_t</span> <span class="nf">magic_open</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">magic_close</span><span class="p">(</span><span class="n">magic_t</span><span class="p">);</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">magic_getpath</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">magic_file</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">magic_descriptor</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">magic_buffer</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">magic_error</span><span class="p">(</span><span class="n">magic_t</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_getflags</span><span class="p">(</span><span class="n">magic_t</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_setflags</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">magic_version</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_load</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_load_buffers</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">magic_compile</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_check</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_list</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_errno</span><span class="p">(</span><span class="n">magic_t</span><span class="p">);</span>
</pre></div></div>
<p>we only care about <code>magic_open</code>, <code>magic_load</code>, <code>magic_close</code>, <code>magic_file</code>, <code>magic_error</code></p>
<div class="code"><div class="highlight"><pre><span></span><span class="c"># magic_t magic_open(int);</span>
<span class="k">proc </span><span class="nf">magic_open</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">cint</span><span class="p">)</span> <span class="p">:</span> <span class="n">MagicPtr</span> <span class="p">{.</span><span class="n">importc</span><span class="p">,</span> <span class="n">dynlib</span><span class="p">:</span><span class="n">libName</span><span class="p">.}</span>
</pre></div></div>
<p><code>magic_open</code> is a proc declared in dynamic lib <code>libmagic.so</code>, that is takes a cint “compatible c int” <code>i</code> and returns a <code>MagicPtr</code>.</p>
<p>From the manpage
&gt; The function magic_open() creates a magic cookie pointer and returns it.<span class="intersentencespace"></span> It returns NULL if there was an error allocating the magic cookie.<span class="intersentencespace"></span> The flags argument specifies how the other magic functions should behave</p>
<div class="code"><div class="highlight"><pre><span></span><span class="c"># void magic_close(magic_t);</span>
<span class="k">proc </span><span class="nf">magic_close</span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">MagicPtr</span><span class="p">):</span> <span class="n">void</span> <span class="p">{.</span><span class="n">importc</span><span class="p">,</span>  <span class="n">dynlib</span><span class="p">:</span><span class="n">libName</span><span class="p">.}</span>
</pre></div></div>
<p><code>magic_close</code> is a proc declared in dynlib <code>libmagic.so</code> and takes an argumnet p of type <code>MagicPtr</code> and returns <code>void</code></p>
<p>From the manpage
&gt; The magic_close() function closes the magic(5) database and deallocates any resources used.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="c">#int magic_load(magic_t, const char *);</span>
<span class="k">proc </span><span class="nf">magic_load</span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">MagicPtr</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="n">cstring</span><span class="p">)</span> <span class="p">:</span> <span class="n">cint</span> <span class="p">{.</span><span class="n">importc</span><span class="p">,</span> <span class="n">dynlib</span><span class="p">:</span> <span class="n">libName</span><span class="p">.}</span>
</pre></div></div>
<p><code>magic_load</code> is a proc declared in dynlib <code>libmagic.so</code> takes argument p of type <code>MagicPtr</code> and a <code>cstring</code> “compatible c string” <code>s</code> and returns a <code>cint</code></p>
<p>From manpage:
&gt; The magic_load() function must be used to load the colon separated list of database files passed in as filename, or NULL for the default database
file before any magic queries can performed.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="c">#int magic_errno(magic_t);</span>
<span class="k">proc </span><span class="nf">magic_error</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">MagicPtr</span><span class="p">)</span> <span class="p">:</span> <span class="n">cstring</span>  <span class="p">{.</span><span class="n">importc</span><span class="p">,</span> <span class="n">dynlib</span><span class="p">:</span><span class="n">libName</span><span class="p">.}</span>
</pre></div></div>
<p><code>magic_errno</code> is a proc declared in dynlib <code>libmagic.so</code> and takes argument p of type <code>MagicPtr</code> and returns a <code>cstring</code></p>
<p>From manpage
&gt; The magic_error() function returns a textual explanation of the last error, or NULL if there was no error.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="c">#const char *magic_file(magic_t, const char *);</span>
<span class="k">proc </span><span class="nf">magic_file</span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">MagicPtr</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">cstring</span><span class="p">):</span> <span class="n">cstring</span> <span class="p">{.</span><span class="n">importc</span><span class="p">,</span> <span class="n">dynlib</span><span class="p">:</span> <span class="n">libName</span><span class="p">.}</span> 
</pre></div></div>
<p><code>magic_file</code> is proc declared in dynlib <code>libmagic.so</code> takes argument p of type <code>MagicPtr</code> and a filepath of type <code>cstring</code> and returns a <code>cstring</code></p>
<p>From manpage:
&gt; The magic_file() function returns a textual description of the contents of the filename argument, or NULL if an error occurred.<span class="intersentencespace"></span> If the filename is NULL, then stdin is used.</p>
</div>
<div id="uid41" data-tralics-id="uid41" class="subsection" data-number="3.2.5"><h3><a href="day3_libmagic.html#uid41" class="heading hyperref"><span class="number">3.2.5 </span>Step 5: Friendly API</a></h3>
<p class="noindent">It’d be annoying for people to write C code and take care of pointers and such in a higher level language like nim</p>
<p>So let’s expose a proc <code>guessFile</code> takes a filepath and flags and internally use the functions we exposed through the FFI in the previous step.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">guessFile</span><span class="o">*</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="n">cint</span> <span class="o">=</span> <span class="n">MAGIC_NONE</span><span class="p">):</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">mt</span> <span class="p">:</span> <span class="n">MagicPtr</span>
    <span class="n">mt</span> <span class="o">=</span> <span class="n">magic_open</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
    <span class="k">discard</span> <span class="n">magic_load</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fileExists</span><span class="p">(</span><span class="n">expandFilename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="o">$</span><span class="n">magic_file</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">cstring</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
    <span class="n">magic_close</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
</pre></div></div>
<p>Only one note here to convert from <code>cstring</code> to <code>string</code> we use the <code>toString</code> operator <code>$</code>
</p><div class="code"><div class="highlight"><pre><span></span>        result = $magic_file(mt, cstring(filepath))
</pre></div></div>
</div></div>
    </div>
  </body>
</html>
