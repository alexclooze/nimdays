<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link href="stylesheets/pygments.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="stylesheets/softcover.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="stylesheets/custom.css" media="screen" rel="stylesheet" type="text/css" />
    
    <title>nimdays</title>
    
      <script type="text/x-mathjax-config">
              MathJax.Hub.Config({
        "HTML-CSS": {
          availableFonts: ["TeX"],
        },
        TeX: {
          extensions: ["AMSmath.js", "AMSsymbols.js", "color.js"],
          equationNumbers: {
            autoNumber: "AMS",
            formatNumber: function (n) { return "7" + '.' + n }
          },
          Macros: {
            PolyTeX:    "Poly{\\TeX}",
            PolyTeXnic: "Poly{\\TeX}nic",
            "softcover": "\\texttt{softcover}",
"unitvec": ["{\\hat #1}", 1]
          }
        },
        showProcessingMessages: false,
        messageStyle: "none",
        imageFont: null,
        "AssistiveMML": { disabled: true }
      });

        if (/PhantomJS/.test(window.navigator.userAgent)) {
          MathJax.Hub.Queue([alert, 'MathJax Done']);
        }
      </script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_SVG"></script>
    
  </head>
  <body>
    
    <div id="book">
      <div id="cid20" data-tralics-id="cid20" class="chapter" data-number="7" data-chapter="day7_shorturl"><h1><a href="day7_shorturl.html#cid20" class="heading hyperref"><span class="number">Chapter 7 </span>Day 7: Shorturl service</a></h1>
<p class="noindent">Today, we will develop a url shortening service like <code>bit.ly</code> or something</p>
</div>
<div id="cid21" data-tralics-id="cid21" class="section" data-number="7.1"><h2><a href="day7_shorturl.html#cid21" class="heading hyperref"><span class="number">7.1 </span>imports</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">jester</span><span class="p">,</span> <span class="n">asyncdispatch</span><span class="p">,</span> <span class="n">htmlgen</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">strutils</span><span class="p">,</span> <span class="n">strformat</span><span class="p">,</span> <span class="n">db_sqlite</span>
</pre></div></div>
<ul>
<li>jester: is sinatra like framework
</li>
<li>asyncdispatch: for async/await instructions
</li>
<li>htmlgen: to generate html pages
</li>
<li>json: to parse json string into nim structures and dump json structures to strings
</li>
<li>db_sqlite: to work on sqlite databse behind our application
</li></ul>
</div>
<div id="cid22" data-tralics-id="cid22" class="section" data-number="7.2"><h2><a href="day7_shorturl.html#cid22" class="heading hyperref"><span class="number">7.2 </span>Database connection</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="c"># hostname can be something configurable "http://ni.m:5000"</span>
<span class="k">let</span> <span class="n">hostname</span> <span class="o">=</span> <span class="s">"localhost:5000"</span>
<span class="kd">var</span> <span class="n">theDb</span> <span class="p">:</span> <span class="n">DbConn</span>
</pre></div></div>
<ul>
<li><code>hostname</code> is the basepath for our site to access it, and can be configurable using <code>/etc/hosts</code> file or using even <code>reverse proxy</code> like <code>caddy</code>, or in real world case you will have a dns record for your site.<span class="intersentencespace"></span>
</li>
<li><code>theDb</code> is the connection object to work with <code>sqlite</code> database.<span class="intersentencespace"></span>
</li></ul>
<div class="code"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">fileExists</span><span class="p">(</span><span class="s">"/tmp/mytest.db"</span><span class="p">):</span>
  <span class="n">theDb</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/tmp/mytest.db"</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="n">theDb</span><span class="p">.</span><span class="n">exec</span><span class="p">(</span><span class="n">sql</span><span class="p">(</span><span class="s">"""create table urls (</span>
<span class="s">      id   INTEGER PRIMARY KEY,</span>
<span class="s">      url  VARCHAR(255) NOT NULL</span>
<span class="s">     )"""</span>
  <span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">theDb</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/tmp/mytest.db"</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
</pre></div></div>
<ul>
<li>We check if the database file doesnâ€™t exist <code>/tmp/mytest.db</code> we create a <code>urls</code> table otherwise we just get the connection and do nothing
</li></ul>
</div>
<div id="cid23" data-tralics-id="cid23" class="section" data-number="7.3"><h2><a href="day7_shorturl.html#cid23" class="heading hyperref"><span class="number">7.3 </span>Jester and http endpoints</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="n">routes</span><span class="p">:</span>
</pre></div></div>
<ul>
<li>jester defines a DSL to work on routes
</li></ul>
<div class="code"><div class="highlight"><pre><span></span><span class="k">METHOD</span> <span class="n">ROUTE_PATH</span><span class="p">:</span>
    <span class="sd">##codeblock</span>
</pre></div></div>
<ul>
<li>METHOD can be <code>get</code> <code>post</code> or any <code>http</code> verb
</li>
<li>ROUTE_PATH is the path accessed on the server for instance <code>/users</code>, <code>/user/52</code>, here <code>52</code> is a query parameter when route is defined like this<code>/user/@id</code>
</li></ul>
<div id="uid70" data-tralics-id="uid70" class="subsection" data-number="7.3.1"><h3><a href="day7_shorturl.html#uid70" class="heading hyperref"><span class="number">7.3.1 </span>HOME page</a></h3>
<p class="noindent">Here we handle <code>GET</code> requests on <code>/home</code> path on our server:
</p><div class="code"><div class="highlight"><pre><span></span> <span class="n">get</span> <span class="s">"/home"</span><span class="p">:</span>
  <span class="kd">var</span> <span class="n">htmlout</span> <span class="o">=</span> <span class="s">"""</span>
<span class="s">    &lt;html&gt;</span>
<span class="s">      &lt;title&gt;NIM SHORT&lt;/title&gt;</span>
<span class="s">      &lt;head&gt;</span>
<span class="s">        &lt;script</span>
<span class="s">      src="https://code.jquery.com/jquery-3.3.1.min.js"</span>
<span class="s">      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="</span>
<span class="s">      crossorigin="anonymous"&gt;&lt;/script&gt;</span>

<span class="s">      &lt;script&gt;</span>
<span class="s">        function postData(url, data) {</span>
<span class="s">          // Default options are marked with *</span>
<span class="s">          return fetch(url, {</span>
<span class="s">            body: JSON.stringify(data), // must match 'Content-Type' header</span>
<span class="s">            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached</span>
<span class="s">            credentials: 'same-origin', // include, same-origin, *omit</span>
<span class="s">            headers: {</span>
<span class="s">              'user-agent': 'Mozilla/4.0 MDN Example',</span>
<span class="s">              'content-type': 'application/json'</span>
<span class="s">            },</span>
<span class="s">            method: 'POST', // *GET, POST, PUT, DELETE, etc.</span>
<span class="s">            mode: 'cors', // no-cors, cors, *same-origin</span>
<span class="s">            redirect: 'follow', // manual, *follow, error</span>
<span class="s">            referrer: 'no-referrer', // *client, no-referrer</span>
<span class="s">          })</span>
<span class="s">          .then(resp =&gt; resp.json())</span>
<span class="s">      }</span>

<span class="s">      $(document).ready(function() {</span>
<span class="s">        $('#btnsubmit').on('click', function(e){</span>
<span class="s">          e.preventDefault();</span>
<span class="s">          postData('/shorten', {url: $("#url").val()})</span>
<span class="s">          .then( data =&gt; {</span>
<span class="s">            let id = data["id"]</span>
<span class="s">            $("#output").html(`&lt;a href="%%hostname/${id}"&gt;Shortlink: ${id}&lt;/a&gt;`);</span>
<span class="s">           });</span>
<span class="s">      });</span>
<span class="s">    });</span>
<span class="s">      &lt;/script&gt;</span>
<span class="s">      &lt;/head&gt;</span>
<span class="s">      &lt;body&gt;</span>
<span class="s">          &lt;div&gt;</span>
<span class="s">            &lt;form&gt;</span>
<span class="s">              &lt;label&gt;URL&lt;/label&gt;</span>
<span class="s">              &lt;input type="url" name="url" id="url" /&gt;</span>
<span class="s">              &lt;button id="btnsubmit" type="button"&gt;SHORT!&lt;/button</span>
<span class="s">            &lt;/form&gt;</span>
<span class="s">          &lt;/div&gt;</span>

<span class="s">          &lt;div id="output"&gt;</span>

<span class="s">          &lt;/div&gt;</span>
<span class="s">      &lt;/body&gt;</span>
<span class="s">    &lt;/html&gt;</span>
<span class="s">    """</span>
    <span class="n">htmlout</span> <span class="o">=</span> <span class="n">htmlout</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"%%hostname"</span><span class="p">,</span> <span class="n">hostname</span><span class="p">)</span>
    <span class="n">resp</span>  <span class="n">htmlout</span>
</pre></div></div>
<ul>
<li>Include jquery framework
</li>
<li>Create a form with in <code>div tag with 1 textinput to allow user to enter a url</code>
</li>
<li>override form submission to do an ajax request
</li>
<li>on the button shorturl click event we send a post request to <code>/shorten</code> endpoint in the background using <code>fetch</code> api and whenever we get a result we parse the json data and extract the <code>id</code> from it and put the new url in the <code>output</code> div
</li>
<li><code>resp</code> to return a response to the user and it can return a <code>http status</code> too
</li></ul>
</div>
<div id="uid76" data-tralics-id="uid76" class="subsection" data-number="7.3.2"><h3><a href="day7_shorturl.html#uid76" class="heading hyperref"><span class="number">7.3.2 </span>Shorten endpoint</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span>  <span class="n">post</span> <span class="s">"/shorten"</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">url</span> <span class="o">=</span> <span class="n">parseJson</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">body</span><span class="p">).</span><span class="n">getOrDefault</span><span class="p">(</span><span class="s">"url"</span><span class="p">).</span><span class="n">getStr</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">.</span><span class="n">isNilOrEmpty</span><span class="p">():</span>
      <span class="kd">var</span> <span class="n">id</span> <span class="o">=</span> <span class="n">theDb</span><span class="p">.</span><span class="n">getValue</span><span class="p">(</span><span class="s">sql"SELECT id FROM urls WHERE url=?"</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">id</span><span class="p">.</span><span class="n">isNilOrEmpty</span><span class="p">():</span>
        <span class="n">id</span> <span class="o">=</span> <span class="o">$</span><span class="n">theDb</span><span class="p">.</span><span class="n">tryInsertId</span><span class="p">(</span><span class="s">sql"INSERT INTO urls (url) VALUES (?)"</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
      <span class="kd">var</span> <span class="n">jsonResp</span> <span class="o">=</span> <span class="o">$</span><span class="p">(</span><span class="o">%*</span><span class="p">{</span><span class="s">"id"</span><span class="p">:</span> <span class="n">id</span><span class="p">})</span>
      <span class="n">resp</span> <span class="n">Http200</span><span class="p">,</span> <span class="n">jsonResp</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">resp</span> <span class="n">Http400</span><span class="p">,</span> <span class="s">"please specify url in the posted data."</span>
</pre></div></div>
<p>Here we handle <code>POST</code> requests on <code>/shorten</code> endpoint
- get the url from parsed json post data.<span class="intersentencespace"></span> please note that POST data is <code>available under request.body</code> <code>explained in the previous section</code></p>
<ul>
<li>if url is passed we try to check if itâ€™s there in our <code>urls</code> table, if itâ€™s there we return it, otherwise we insert it in the table.<span class="intersentencespace"></span>
</li>
<li>if the url isnâ€™t passed we return a badrequest <code>400</code> status code.<span class="intersentencespace"></span>
</li>
<li><code>parseJson</code>: loads json from a string and you can get value using <code>getOrDefault</code> and <code>getStr</code> to get string value, thereâ€™s getBool, and so on.<span class="intersentencespace"></span>
</li>
<li><code>getValue</code> to get the id from the result of the select statement <code>returns the first column from the first row in the result set</code>
</li>
<li><code>tryInsertId</code> executes insert statement and returns the id of the new row
</li>
<li>after successfull insertion we would like to return <code>json</code> serialized string to the user <code>$(%*{"id": id})</code>
</li>
<li><code>%*</code> is a macro to convert nim struct into json node and to convert it to string we wrap <code>$</code> around it
</li></ul>
</div>
<div id="uid84" data-tralics-id="uid84" class="subsection" data-number="7.3.3"><h3><a href="day7_shorturl.html#uid84" class="heading hyperref"><span class="number">7.3.3 </span>Shorturls redirect</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span>  <span class="n">get</span> <span class="s">"/@Id"</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">url</span> <span class="o">=</span> <span class="n">theDb</span><span class="p">.</span><span class="n">getValue</span><span class="p">(</span><span class="s">sql"SELECT url FROM urls WHERE id=?"</span><span class="p">,</span> <span class="o">@</span><span class="s">"Id"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">url</span><span class="p">.</span><span class="n">isNilOrEmpty</span><span class="p">():</span>
      <span class="n">resp</span> <span class="n">Http404</span><span class="p">,</span> <span class="s">"Don't know that url"</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">redirect</span> <span class="n">url</span>
</pre></div></div>
<ul>
<li>Here we fetch whatever path <code>@Id</code> the user trying to access <code>except for /home and /shorten</code> and we try to get the long url for that path
</li>
<li>If the path is resolved to a url we <code>redirect</code> the user to to or we show an error message
</li>
<li><code>@"Id"</code> gets the value of <code>@Id</code> query parameter : notice the <code>@</code> position in both situation
</li></ul>
</div></div>
<div id="cid24" data-tralics-id="cid24" class="section" data-number="7.4"><h2><a href="day7_shorturl.html#cid24" class="heading hyperref"><span class="number">7.4 </span>RUN</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="n">runForever</span><span class="p">()</span>
</pre></div></div>
<p>start jester webserver</p>
<p>Code is available here <a href="https://gist.github.com/xmonader/d41a5c9f917eadb90d3025e7b7e748dd" target="_blank" rel="noopener">https://gist.github.com/xmonader/d41a5c9f917eadb90d3025e7b7e748dd</a></p>
</div>
    </div>
  </body>
</html>
