<div id="cid4" data-tralics-id="cid4" class="chapter" data-number="2" data-chapter="day2_bencode"><h1><a href="day2_bencode_fragment.html#cid4" class="heading hyperref"><span class="number">Chapter 2 </span>Day 2: Parsing Bencode</a></h1>
<p class="noindent">nim-bencode is a library to encode/decode torrent files <a href="https://en.wikipedia.org/wiki/Bencode" target="_blank" rel="noopener">Bencode</a></p>
</div><div id="cid5" data-tralics-id="cid5" class="section" data-number="2.1"><h2><a href="day2_bencode_fragment.html#cid5" class="heading hyperref"><span class="number">2.1 </span>What to expect?</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">bencode</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">strformat</span>

<span class="k">let</span> <span class="n">encoder</span> <span class="o">=</span> <span class="n">newEncoder</span><span class="p">()</span>
<span class="k">let</span> <span class="n">decoder</span> <span class="o">=</span> <span class="n">newDecoder</span><span class="p">()</span>

<span class="k">let</span> <span class="n">btListSample1</span> <span class="o">=</span> <span class="o">@[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"hi"</span><span class="p">)</span> <span class="o">]</span>
<span class="kd">var</span> <span class="n">btDictSample1</span> <span class="o">=</span> <span class="n">initOrderedTable</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">,</span> <span class="n">BencodeType</span><span class="o">]</span><span class="p">()</span>
<span class="n">btDictSample1</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"name"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"dmdm"</span><span class="p">)</span>
<span class="n">btDictSample1</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"lang"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"nim"</span><span class="p">)</span>
<span class="n">btDictSample1</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"age"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="mi">50</span><span class="p">)</span>
<span class="n">btDictSample1</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"alist"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btList</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">btListSample1</span><span class="p">)</span>

<span class="kd">var</span> <span class="n">testObjects</span> <span class="o">=</span> <span class="n">initOrderedTable</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">,</span> <span class="kt">string</span><span class="o">]</span><span class="p">()</span>
<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"hello"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"5:hello"</span>
<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"yes"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"3:yes"</span>
<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="mi">55</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"i55e"</span>

<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="mi">12345</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"i12345e"</span>
<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btList</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">btListSample1</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"li1e2:hie"</span>
<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btDict</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span><span class="n">btDictSample1</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"d4:name4:dmdm4:lang3:nim3:agei50e5:alistli1e2:hiee"</span>


<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">testObjects</span><span class="p">.</span><span class="n">pairs</span><span class="p">():</span>
    <span class="n">echo</span> <span class="o">$</span><span class="n">k</span> <span class="o">&amp;</span> <span class="s">" =&gt; "</span> <span class="o">&amp;</span> <span class="o">$</span><span class="n">v</span>
    <span class="n">doAssert</span><span class="p">(</span><span class="n">encoder</span><span class="p">.</span><span class="n">encodeObject</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">doAssert</span><span class="p">(</span><span class="n">decoder</span><span class="p">.</span><span class="n">decodeObject</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
</pre></div></div>
</div><div id="cid6" data-tralics-id="cid6" class="section" data-number="2.2"><h2><a href="day2_bencode_fragment.html#cid6" class="heading hyperref"><span class="number">2.2 </span>Implementation</a></h2>
<p class="noindent">So according to Bencode we have some datatypes
- strings and those are encoded with the string length followed by a colon and the string itself <code>length:string</code>, e.g yes will be encoded into <code>3:yes</code>
- ints those are encoded between <code>i</code>, <code>e</code> letters, e.g 59 will be encoded into <code>i59e</code>
- lists can contain any of the bencode types and itâ€™s encoded with <code>l</code>, <code>e</code>, e.g list of 1, 2 numbers is encoded into <code>li1ei2e</code> or with spaces for verbosity <code>l i1e i2e e</code>
- dicts are mapping from strings to any type and encoded between letters <code>d</code>, <code>e</code>, e.g name =&gt; hi and num =&gt; 3 is encoded into <code>d4:name2:hi3:numi3ee</code> or with spaces for verbosity <code>d 4:name 2:hi 3:num i3e e</code></p>
<div id="uid12" data-tralics-id="uid12" class="subsection" data-number="2.2.1"><h3><a href="day2_bencode_fragment.html#uid12" class="heading hyperref"><span class="number">2.2.1 </span>Imports</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">strformat</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">strutils</span><span class="p">,</span> <span class="n">hashes</span>
</pre></div></div>
<p>As we will be dealing a lot with strings, tables</p>
</div>
<div id="uid13" data-tralics-id="uid13" class="subsection" data-number="2.2.2"><h3><a href="day2_bencode_fragment.html#uid13" class="heading hyperref"><span class="number">2.2.2 </span>Types</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> 
    <span class="n">BencodeKind</span><span class="o">*</span> <span class="o">=</span> <span class="k">enum</span>
        <span class="n">btString</span><span class="p">,</span> <span class="n">btInt</span><span class="p">,</span> <span class="n">btList</span><span class="p">,</span> <span class="n">btDict</span>
</pre></div></div>
<p>So as we mentioned about bencode data types we can define an enum to represents the kinds</p>
<div class="code"><div class="highlight"><pre><span></span>    <span class="n">BencodeType</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span>
        <span class="k">case</span> <span class="n">kind</span><span class="o">*</span><span class="p">:</span> <span class="n">BencodeKind</span> 
        <span class="k">of</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btString</span><span class="p">:</span> <span class="n">s</span><span class="o">*</span> <span class="p">:</span> <span class="kt">string</span> 
        <span class="k">of</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btInt</span><span class="p">:</span> <span class="n">i</span><span class="o">*</span>    <span class="p">:</span> <span class="kt">int</span>
        <span class="k">of</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btList</span><span class="p">:</span> <span class="n">l</span><span class="o">*</span>   <span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="n">BencodeType</span><span class="o">]</span>
        <span class="k">of</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btDict</span><span class="p">:</span> <span class="n">d</span><span class="o">*</span>  <span class="p">:</span> <span class="n">OrderedTable</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">,</span> <span class="n">BencodeType</span><span class="o">]</span>

    <span class="n">Encoder</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span>
    <span class="n">Decoder</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> 
</pre></div></div>
<ul>
<li><code>Encoder</code> a simple class to represent encoding operations
</li>
<li><code>Decoder</code> a simple class to represent decoding operations
</li>
<li>For <code>BencodeType</code> we make use of variant objects <code>case classes</code> in other languages.<span class="intersentencespace"></span> worth noticing variant objects are the same technique used for <code>json</code> module.<span class="intersentencespace"></span>
</li></ul>
<p>So we can use it like this</p>
<div class="code"><div class="highlight"><pre><span></span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"hello"</span><span class="p">)</span>
<span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="mi">55</span><span class="p">)</span>
<span class="k">let</span> <span class="n">btListSample1</span> <span class="o">=</span> <span class="o">@[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"hi"</span><span class="p">)</span> <span class="o">]</span>
<span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btList</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">btListSample1</span><span class="p">)</span>
</pre></div></div>
<p>So general rule for the case classes is you have a kind defined in an enum and a constructor value u create the object with.</p>
<p>If youâ€™re coming from Haskell or a similar language</p>
<div class="code"><div class="highlight"><pre><span></span><span class="kr">data</span> <span class="kt">BValue</span> <span class="ow">=</span> <span class="kt">BInt</span> <span class="kt">Integer</span>
            <span class="o">|</span> <span class="kt">BStr</span> <span class="kt">B</span><span class="o">.</span><span class="kt">ByteString</span>
            <span class="o">|</span> <span class="kt">BList</span> <span class="p">[</span><span class="kt">BValue</span><span class="p">]</span>
            <span class="o">|</span> <span class="kt">BDict</span> <span class="p">(</span><span class="kt">M</span><span class="o">.</span><span class="kt">Map</span> <span class="kt">BValue</span> <span class="kt">BValue</span><span class="p">)</span>
            <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Show</span><span class="p">,</span> <span class="kt">Eq</span><span class="p">,</span> <span class="kt">Ord</span><span class="p">)</span>
</pre></div></div>
<p>Please, note if you define your own variant you should define <code>hash</code>, <code>==</code> procs to be able to compare or hash the values.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">hash</span><span class="o">*</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">BencodeType</span><span class="p">):</span> <span class="n">Hash</span> <span class="o">=</span> 
    <span class="k">case</span> <span class="n">obj</span><span class="p">.</span><span class="n">kind</span>
    <span class="k">of</span> <span class="n">btString</span> <span class="p">:</span> <span class="o">!$</span><span class="p">(</span><span class="n">hash</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">s</span><span class="p">))</span>
    <span class="k">of</span> <span class="n">btInt</span> <span class="p">:</span> <span class="o">!$</span><span class="p">(</span><span class="n">hash</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">i</span><span class="p">))</span>
    <span class="k">of</span> <span class="n">btList</span><span class="p">:</span> <span class="o">!$</span><span class="p">(</span><span class="n">hash</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">l</span><span class="p">))</span>
    <span class="k">of</span> <span class="n">btDict</span><span class="p">:</span> 
        <span class="kd">var</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">pairs</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">hash</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">!&amp;</span> <span class="n">hash</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">!$</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</pre></div></div>
<ul>
<li><code>hash</code> proc returns <code>Hash</code> and depending on the <code>kind</code> we return the hash of the underlying stored objects, strings, ints, lists or calculate a new hash if needed
</li>
<li><code>!&amp;</code> consider it like merging the two hashes together
</li>
<li><code>!$</code> is used to finalize the Hash object
</li></ul>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">`==`</span><span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">BencodeType</span><span class="p">):</span> <span class="kt">bool</span> <span class="o">=</span>
    <span class="sd">## Check two nodes for equality</span>
    <span class="k">if</span> <span class="n">a</span><span class="p">.</span><span class="n">isNil</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">b</span><span class="p">.</span><span class="n">isNil</span><span class="p">:</span> <span class="k">return</span> <span class="kp">true</span>
        <span class="k">return</span> <span class="kp">false</span>
    <span class="k">elif</span> <span class="n">b</span><span class="p">.</span><span class="n">isNil</span> <span class="ow">or</span> <span class="n">a</span><span class="p">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="n">b</span><span class="p">.</span><span class="n">kind</span><span class="p">:</span>
        <span class="k">return</span> <span class="kp">false</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">a</span><span class="p">.</span><span class="n">kind</span>
        <span class="k">of</span> <span class="n">btString</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">s</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="n">s</span>
        <span class="k">of</span> <span class="n">btInt</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">i</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="n">i</span>
        <span class="k">of</span> <span class="n">btList</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">l</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="n">l</span>
        <span class="k">of</span> <span class="n">btDict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">len</span> <span class="o">!=</span> <span class="n">b</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">len</span><span class="p">:</span> <span class="k">return</span> <span class="kp">false</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">a</span><span class="p">.</span><span class="n">d</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">hasKey</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="k">return</span> <span class="kp">false</span>
                <span class="k">if</span> <span class="n">b</span><span class="p">.</span><span class="n">d</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span> <span class="k">return</span> <span class="kp">false</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kp">true</span>
</pre></div></div>
<p>define equality operator on BencodeTypes to determine when theyâ€™re equal by defining proc for operator <code>==</code></p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">`$`</span><span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">BencodeType</span><span class="p">):</span> <span class="kt">string</span> <span class="o">=</span> 
    <span class="k">case</span> <span class="n">a</span><span class="p">.</span><span class="n">kind</span>
    <span class="k">of</span> <span class="n">btString</span><span class="p">:</span>  <span class="n">fmt</span><span class="p">(</span><span class="s">"&lt;Bencode {a.s}&gt;"</span><span class="p">)</span>
    <span class="k">of</span> <span class="n">btInt</span><span class="p">:</span> <span class="n">fmt</span><span class="p">(</span><span class="s">"&lt;Bencode {a.i}&gt;"</span><span class="p">)</span>
    <span class="k">of</span> <span class="n">btList</span><span class="p">:</span> <span class="n">fmt</span><span class="p">(</span><span class="s">"&lt;Bencode {a.l}&gt;"</span><span class="p">)</span>
    <span class="k">of</span> <span class="n">btDict</span><span class="p">:</span> <span class="n">fmt</span><span class="p">(</span><span class="s">"&lt;Bencode {a.d}"</span><span class="p">)</span>
</pre></div></div>
<p>Define a simple <code>toString</code> proc using the <code>$</code> operator.</p>
</div>
<div id="uid20" data-tralics-id="uid20" class="subsection" data-number="2.2.3"><h3><a href="day2_bencode_fragment.html#uid20" class="heading hyperref"><span class="number">2.2.3 </span>Encoding</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">encode</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">,</span>  <span class="n">obj</span><span class="p">:</span> <span class="n">BencodeType</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span>
</pre></div></div>
<p>we add forward declarating to encode proc because to encode a list we might encode another values <code>strings</code>, or even <code>lists</code> so we will recursively call encode if needed, feel free to skip to the next part.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">encode_s</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span><span class="o">=</span>
    <span class="c"># TODO: check len</span>
    <span class="k">return</span> <span class="o">$</span><span class="n">s</span><span class="p">.</span><span class="n">len</span> <span class="o">&amp;</span> <span class="s">":"</span> <span class="o">&amp;</span> <span class="n">s</span>
</pre></div></div>
<p>To encode a string we said we will put encoded with its length + <code>:</code> + string itself</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">encode_i</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="kt">int</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span><span class="o">=</span>
    <span class="c"># TODO: check len</span>
    <span class="k">return</span> <span class="n">fmt</span><span class="p">(</span><span class="s">"i{i}e"</span><span class="p">)</span> 
</pre></div></div>
<p>To encode an int we put it between <code>i</code>, <code>e</code> chars</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">encode_l</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="n">BencodeType</span><span class="o">]</span><span class="p">):</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">encoded</span> <span class="o">=</span> <span class="s">"l"</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="n">encoded</span> <span class="o">&amp;=</span> <span class="n">this</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
    <span class="n">encoded</span> <span class="o">&amp;=</span> <span class="s">"e"</span>
    <span class="k">return</span> <span class="n">encoded</span>
</pre></div></div>
<p>- To encode a list of elements of type <code>BencodeType</code> we put their encoded values between <code>l</code>, <code>e</code> chars
- Notice the call to <code>this.encode</code> thatâ€™s why we needed the forward declaration.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">encode_d</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="n">OrderedTable</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">,</span> <span class="n">BencodeType</span><span class="o">]</span><span class="p">):</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">encoded</span> <span class="o">=</span> <span class="s">"d"</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="p">.</span><span class="n">pairs</span><span class="p">():</span>
        <span class="n">assert</span> <span class="n">k</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btString</span>
        <span class="n">encoded</span> <span class="o">&amp;=</span> <span class="n">this</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">this</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="n">encoded</span> <span class="o">&amp;=</span> <span class="s">"e"</span>
    <span class="k">return</span> <span class="n">encoded</span>
</pre></div></div>
<p>- To encode a dict we enclose the encoded value of the pairs between <code>d</code>, <code>e</code>
- Notice the recursive call to <code>this.encode</code> to the keys and values
- Notice the assertion the kind of the keys <code>must</code> be a <code>btString</code> according to <code>Bencode</code> specs.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">encode</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">,</span>  <span class="n">obj</span><span class="p">:</span> <span class="n">BencodeType</span><span class="p">)</span> <span class="p">:</span>  <span class="kt">string</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">obj</span><span class="p">.</span><span class="n">kind</span>
    <span class="k">of</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btString</span><span class="p">:</span>  <span class="n">result</span> <span class="o">=</span><span class="n">this</span><span class="p">.</span><span class="n">encode_s</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">s</span><span class="p">)</span>
    <span class="k">of</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btInt</span> <span class="p">:</span>  <span class="n">result</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">encode_i</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">i</span><span class="p">)</span>
    <span class="k">of</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btList</span> <span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">encode_l</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">l</span><span class="p">)</span>
    <span class="k">of</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btDict</span> <span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">encode_d</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">d</span><span class="p">)</span>
</pre></div></div>
<p>Simple proxy to encode <code>obj</code> of <code>BencodeType</code></p>
</div>
<div id="uid21" data-tralics-id="uid21" class="subsection" data-number="2.2.4"><h3><a href="day2_bencode_fragment.html#uid21" class="heading hyperref"><span class="number">2.2.4 </span>Decoding</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">decode</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">,</span>  <span class="n">source</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span>
</pre></div></div>
<p>Forward declaration for <code>decode</code> same as <code>decode</code></p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">decode_s</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">lengthpart</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">":"</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    <span class="k">let</span> <span class="n">sizelength</span> <span class="o">=</span> <span class="n">lengthpart</span><span class="p">.</span><span class="n">len</span>
    <span class="k">let</span> <span class="n">strlen</span> <span class="o">=</span> <span class="n">parseInt</span><span class="p">(</span><span class="n">lengthpart</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">[</span><span class="n">sizelength</span><span class="o">+</span><span class="mf">1</span><span class="p">..</span><span class="n">strlen</span><span class="o">+</span><span class="mi">1</span><span class="o">]</span><span class="p">),</span> <span class="n">sizelength</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">strlen</span><span class="p">)</span>
</pre></div></div>
<p>Create a BencodeType of after decoding a string <code>reverse operation of encode_s</code>
Basically and read string of length <code>sizelength</code> after the <code>colon</code> and construct a <code>BencodeType</code> of kind <code>btString</code> out of it</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">decode_i</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">epos</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="sc">'e'</span><span class="p">)</span>
    <span class="k">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">parseInt</span><span class="p">(</span><span class="n">s</span><span class="o">[</span><span class="mf">1</span><span class="p">..</span><span class="o">&lt;</span><span class="n">epos</span><span class="o">]</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">),</span> <span class="n">epos</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</pre></div></div>
<p>Extract the number between <code>i</code>, <code>e</code> chars and construct <code>BencodeType</code> of kind <code>btInt</code> out of it</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">decode_l</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="kt">string</span><span class="p">):</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span>
    <span class="c"># l ... e</span>
    <span class="kd">var</span> <span class="n">els</span> <span class="o">=</span> <span class="n">newSeq</span><span class="o">[</span><span class="n">BencodeType</span><span class="o">]</span><span class="p">()</span>
    <span class="kd">var</span> <span class="n">curchar</span> <span class="o">=</span> <span class="n">s</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
    <span class="kd">var</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">len</span><span class="p">:</span>
        <span class="n">curchar</span> <span class="o">=</span> <span class="n">s</span><span class="o">[</span><span class="n">idx</span><span class="o">]</span>
        <span class="k">if</span> <span class="n">curchar</span> <span class="o">==</span> <span class="sc">'e'</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">break</span>
    
        <span class="k">let</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">s</span><span class="o">[</span><span class="n">idx</span><span class="p">..</span><span class="o">&lt;</span><span class="n">s</span><span class="p">.</span><span class="n">len</span><span class="o">]</span><span class="p">)</span>
        <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
        <span class="k">let</span> <span class="n">nextobjpos</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> 
        <span class="n">els</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="n">nextobjpos</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btList</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">els</span><span class="p">),</span> <span class="n">idx</span><span class="p">)</span>
</pre></div></div>
<p>Decoding the list can be bit tricky
- Its elements are between <code>l</code>, <code>e</code> chars
- So we start trying to decode objects starting from the first letter <code>after</code> the <code>l</code> until we reach the final <code>e</code>
e.g
</p><div class="code"><div class="highlight"><pre><span></span>li1ei2ee
</pre></div></div>
<p>will be parsed like the following
</p><div class="code"><div class="highlight"><pre><span></span>li120ei492ee
 $   $
</pre></div></div>
<ul>
<li>will consume the object <code>i120e</code> and set the cursor to the beginning of the second object <code>i492e</code>
</li>
<li>after all the objects are consumed we consume the end character <code>e</code> and we are done
</li>
<li>Thatâ€™s why all decode procs return <code>int</code> value to let us now how much characters to skip
</li></ul>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">decode_d</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="kt">string</span><span class="p">):</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">d</span> <span class="o">=</span> <span class="n">initOrderedTable</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">,</span> <span class="n">BencodeType</span><span class="o">]</span><span class="p">()</span>
    <span class="kd">var</span> <span class="n">curchar</span> <span class="o">=</span> <span class="n">s</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
    <span class="kd">var</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="kd">var</span> <span class="n">readingKey</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="kd">var</span> <span class="n">curKey</span><span class="p">:</span> <span class="n">BencodeType</span>
    <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">len</span><span class="p">:</span>
        <span class="n">curchar</span> <span class="o">=</span> <span class="n">s</span><span class="o">[</span><span class="n">idx</span><span class="o">]</span>
        <span class="k">if</span> <span class="n">curchar</span> <span class="o">==</span> <span class="sc">'e'</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">let</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">s</span><span class="o">[</span><span class="n">idx</span><span class="p">..</span><span class="o">&lt;</span><span class="n">s</span><span class="p">.</span><span class="n">len</span><span class="o">]</span><span class="p">)</span>
        <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
        <span class="k">let</span> <span class="n">nextobjpos</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
        <span class="k">if</span> <span class="n">readingKey</span> <span class="o">==</span> <span class="kp">true</span><span class="p">:</span>
            <span class="n">curKey</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="n">readingKey</span> <span class="o">=</span> <span class="kp">false</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span><span class="o">[</span><span class="n">curKey</span><span class="o">]</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="n">readingKey</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="n">nextobjpos</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btDict</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">),</span> <span class="n">idx</span><span class="p">)</span>
</pre></div></div>
<ul>
<li>Same technique as above
</li>
<li>Basically we read one object if we donâ€™t have a current key then we set it as the current key
</li>
<li>If we have a current key object then the object we read is the value, so we set the currentKey to that value and <code>change</code> mode to readingKey again.<span class="intersentencespace"></span>
</li></ul>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">decode</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">,</span>  <span class="n">source</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">curchar</span> <span class="o">=</span> <span class="n">source</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    <span class="kd">var</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">source</span><span class="p">.</span><span class="n">len</span><span class="p">:</span>
        <span class="n">curchar</span> <span class="o">=</span> <span class="n">source</span><span class="o">[</span><span class="n">idx</span><span class="o">]</span>
        <span class="k">case</span> <span class="n">curchar</span>
        <span class="k">of</span> <span class="sc">'i'</span><span class="p">:</span>
            <span class="k">let</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">decode_i</span><span class="p">(</span><span class="n">source</span><span class="o">[</span><span class="n">idx</span><span class="p">..</span><span class="n">source</span><span class="p">.</span><span class="n">len</span><span class="o">]</span><span class="p">)</span>
            <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
            <span class="k">let</span> <span class="n">nextobjpos</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> 
            <span class="n">idx</span> <span class="o">+=</span> <span class="n">nextobjpos</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">of</span> <span class="sc">'l'</span><span class="p">:</span>
            <span class="k">let</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">decode_l</span><span class="p">(</span><span class="n">source</span><span class="o">[</span><span class="n">idx</span><span class="p">..</span><span class="n">source</span><span class="p">.</span><span class="n">len</span><span class="o">]</span><span class="p">)</span>
            <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
            <span class="k">let</span> <span class="n">nextobjpos</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> 
            <span class="n">idx</span> <span class="o">+=</span> <span class="n">nextobjpos</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">of</span> <span class="sc">'d'</span><span class="p">:</span>
            <span class="k">let</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">decode_d</span><span class="p">(</span><span class="n">source</span><span class="o">[</span><span class="n">idx</span><span class="p">..</span><span class="n">source</span><span class="p">.</span><span class="n">len</span><span class="o">]</span><span class="p">)</span>
            <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
            <span class="k">let</span> <span class="n">nextobjpos</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> 
            <span class="n">idx</span> <span class="o">+=</span> <span class="n">nextobjpos</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">let</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">decode_s</span><span class="p">(</span><span class="n">source</span><span class="o">[</span><span class="n">idx</span><span class="p">..</span><span class="n">source</span><span class="p">.</span><span class="n">len</span><span class="o">]</span><span class="p">)</span>
            <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
            <span class="k">let</span> <span class="n">nextobjpos</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> 
            <span class="n">idx</span> <span class="o">+=</span> <span class="n">nextobjpos</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</pre></div></div>
<p>Starts decoding based on the beginning of character encoding object <code>i</code> for int, <code>l</code> for lists, <code>d</code> for dicts and otherwise tries to parse string</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">newEncoder</span><span class="o">*</span><span class="p">():</span> <span class="n">Encoder</span> <span class="o">=</span>
    <span class="n">new</span> <span class="n">Encoder</span>

<span class="k">proc </span><span class="nf">newDecoder</span><span class="o">*</span><span class="p">():</span> <span class="n">Decoder</span> <span class="o">=</span> 
    <span class="n">new</span> <span class="n">Decoder</span>
</pre></div></div>
<p>Simple constructor procs for newEncoder, newDecoder</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">encodeObject</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">BencodeType</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div></div>
<p><code>encodeObject</code> dispatch the call to <code>encode</code> proc.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">decodeObject</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span><span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="n">BencodeType</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">p</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</pre></div></div>
<p><code>decodeObject</code> provides a friendlier API to return the BencodeType from decode instead of <code>BencodeType</code>, <code>how many to read</code> int</p>
</div></div>