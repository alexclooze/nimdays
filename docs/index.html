<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link href="stylesheets/pygments.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="stylesheets/softcover.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="stylesheets/custom.css" media="screen" rel="stylesheet" type="text/css" />
    
    <title>nimdays</title>
    
      <script type="text/x-mathjax-config">
              MathJax.Hub.Config({
        "HTML-CSS": {
          availableFonts: ["TeX"],
        },
        TeX: {
          extensions: ["AMSmath.js", "AMSsymbols.js", "color.js"],
          equationNumbers: {
            autoNumber: "AMS",
            
          },
          Macros: {
            PolyTeX:    "Poly{\\TeX}",
            PolyTeXnic: "Poly{\\TeX}nic",
            "softcover": "\\texttt{softcover}",
"unitvec": ["{\\hat #1}", 1]
          }
        },
        showProcessingMessages: false,
        messageStyle: "none",
        imageFont: null,
        "AssistiveMML": { disabled: true }
      });

        if (/PhantomJS/.test(window.navigator.userAgent)) {
          MathJax.Hub.Queue([alert, 'MathJax Done']);
        }
      </script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_SVG"></script>
    
  </head>
  <body>
    
    <div id="book">
      <div id="frontmatter" data-number="0"><div id="title_page"><h1 class="title">Nim Days</h1><h1 class="subtitle">My Nim diary</h1><h2 class="author">Ahmed T. Youssef</h2></div>
<h1 class="contents">Contents</h1><div id="table_of_contents"><ul><li class="chapter-star"><a href="#preface" class="heading hyperref">Preface</a></li><li class="chapter"><a href="#cid1" class="heading hyperref"><span class="number">Chapter 1 </span>Day 1: Parsing DMIDecode output</a></li><li><ul><li class="section"><a href="#cid2" class="heading hyperref"><span class="number">1.1 </span>What to expect ?</a></li><li class="section"><a href="#cid3" class="heading hyperref"><span class="number">1.2 </span>Implementation</a></li><li><ul><li class="subsection"><a href="#uid1" class="heading hyperref"><span class="number">1.2.1 </span>nimble ready!</a></li><li class="subsection"><a href="#uid2" class="heading hyperref"><span class="number">1.2.2 </span>So how does dmidecode output look like?</a></li><li class="subsection"><a href="#uid12" class="heading hyperref"><span class="number">1.2.3 </span>Mapping DMI to nim structures</a></li><li class="subsection"><a href="#uid13" class="heading hyperref"><span class="number">1.2.4 </span>Parsing DMI source into nim structures</a></li></ul></li></ul></li><li class="chapter"><a href="#cid4" class="heading hyperref"><span class="number">Chapter 2 </span>Day 2: Parsing Bencode</a></li><li><ul><li class="section"><a href="#cid5" class="heading hyperref"><span class="number">2.1 </span>What to expect?</a></li><li class="section"><a href="#cid6" class="heading hyperref"><span class="number">2.2 </span>Implementation</a></li><li><ul><li class="subsection"><a href="#uid21" class="heading hyperref"><span class="number">2.2.1 </span>Imports</a></li><li class="subsection"><a href="#uid22" class="heading hyperref"><span class="number">2.2.2 </span>Types</a></li><li class="subsection"><a href="#uid29" class="heading hyperref"><span class="number">2.2.3 </span>Encoding</a></li><li class="subsection"><a href="#uid30" class="heading hyperref"><span class="number">2.2.4 </span>Decoding</a></li></ul></li></ul></li><li class="chapter"><a href="#cid7" class="heading hyperref"><span class="number">Chapter 3 </span>Day 3: Talking to C (FFI and libmagic)</a></li><li><ul><li class="section"><a href="#cid8" class="heading hyperref"><span class="number">3.1 </span>What to expect?</a></li><li class="section"><a href="#cid9" class="heading hyperref"><span class="number">3.2 </span>Implementation</a></li><li><ul><li class="subsection"><a href="#uid37" class="heading hyperref"><span class="number">3.2.1 </span>Step 1: Get the library info</a></li><li class="subsection"><a href="#uid38" class="heading hyperref"><span class="number">3.2.2 </span>Step 2: Extract constants</a></li><li class="subsection"><a href="#uid39" class="heading hyperref"><span class="number">3.2.3 </span>Step 3: Extract the types</a></li><li class="subsection"><a href="#uid40" class="heading hyperref"><span class="number">3.2.4 </span>Step 4: Extract procedures</a></li><li class="subsection"><a href="#uid41" class="heading hyperref"><span class="number">3.2.5 </span>Step 5: Friendly API</a></li></ul></li></ul></li><li class="chapter"><a href="#cid10" class="heading hyperref"><span class="number">Chapter 4 </span>Day 4: LinksChecker</a></li><li><ul><li class="section"><a href="#cid11" class="heading hyperref"><span class="number">4.1 </span>What to expect ?</a></li><li class="section"><a href="#cid12" class="heading hyperref"><span class="number">4.2 </span>Implementation</a></li><li><ul><li class="subsection"><a href="#uid42" class="heading hyperref"><span class="number">4.2.1 </span>Step 0: Imports</a></li><li class="subsection"><a href="#uid43" class="heading hyperref"><span class="number">4.2.2 </span>Step 1: Data types</a></li><li class="subsection"><a href="#uid44" class="heading hyperref"><span class="number">4.2.3 </span>Step 2: GO Sequential!</a></li><li class="subsection"><a href="#uid45" class="heading hyperref"><span class="number">4.2.4 </span>Step 3: GO ASYNC!</a></li><li class="subsection"><a href="#uid46" class="heading hyperref"><span class="number">4.2.5 </span>Step 4 simple cli</a></li><li class="subsection"><a href="#uid47" class="heading hyperref"><span class="number">4.2.6 </span>Extra, threading</a></li></ul></li></ul></li><li class="chapter"><a href="#cid13" class="heading hyperref"><span class="number">Chapter 5 </span>Day 5: Creating INI Parser</a></li><li><ul><li class="section"><a href="#cid14" class="heading hyperref"><span class="number">5.1 </span>What to expect ?</a></li><li class="section"><a href="#cid15" class="heading hyperref"><span class="number">5.2 </span>Implementation</a></li><li><ul><li class="subsection"><a href="#uid48" class="heading hyperref"><span class="number">5.2.1 </span>Ini sample</a></li><li class="subsection"><a href="#uid49" class="heading hyperref"><span class="number">5.2.2 </span>Define your data types</a></li><li class="subsection"><a href="#uid50" class="heading hyperref"><span class="number">5.2.3 </span>Define API</a></li><li class="subsection"><a href="#uid51" class="heading hyperref"><span class="number">5.2.4 </span>Parse!</a></li></ul></li></ul></li><li class="chapter"><a href="#cid16" class="heading hyperref"><span class="number">Chapter 6 </span>Day 6: Manage your dotfiles easily with nistow</a></li><li><ul><li class="section"><a href="#cid17" class="heading hyperref"><span class="number">6.1 </span>Dotfiles layout</a></li><li class="section"><a href="#cid18" class="heading hyperref"><span class="number">6.2 </span>What do we expect?</a></li><li class="section"><a href="#cid19" class="heading hyperref"><span class="number">6.3 </span>Implementation</a></li></ul></li><li class="chapter"><a href="#cid20" class="heading hyperref"><span class="number">Chapter 7 </span>Day 7: Shorturl service</a></li><li><ul><li class="section"><a href="#cid21" class="heading hyperref"><span class="number">7.1 </span>imports</a></li><li class="section"><a href="#cid22" class="heading hyperref"><span class="number">7.2 </span>Database connection</a></li><li class="section"><a href="#cid23" class="heading hyperref"><span class="number">7.3 </span>Jester and http endpoints</a></li><li><ul><li class="subsection"><a href="#uid70" class="heading hyperref"><span class="number">7.3.1 </span>HOME page</a></li><li class="subsection"><a href="#uid76" class="heading hyperref"><span class="number">7.3.2 </span>Shorten endpoint</a></li><li class="subsection"><a href="#uid84" class="heading hyperref"><span class="number">7.3.3 </span>Shorturls redirect</a></li></ul></li><li class="section"><a href="#cid24" class="heading hyperref"><span class="number">7.4 </span>RUN</a></li></ul></li><li class="chapter"><a href="#cid25" class="heading hyperref"><span class="number">Chapter 8 </span>Day 8: minitest</a></li><li><ul><li class="section"><a href="#cid26" class="heading hyperref"><span class="number">8.1 </span>So what’s up?</a></li><li class="section"><a href="#cid27" class="heading hyperref"><span class="number">8.2 </span>What to expect?</a></li><li class="section"><a href="#cid28" class="heading hyperref"><span class="number">8.3 </span>Implementation</a></li><li><ul><li class="subsection"><a href="#uid88" class="heading hyperref"><span class="number">8.3.1 </span>templates</a></li><li class="subsection"><a href="#uid92" class="heading hyperref"><span class="number">8.3.2 </span>Macros</a></li></ul></li></ul></li><li class="chapter"><a href="#cid29" class="heading hyperref"><span class="number">Chapter 9 </span>Day 9: Tic tac toe</a></li><li><ul><li class="section"><a href="#cid30" class="heading hyperref"><span class="number">9.1 </span>What to expect</a></li><li class="section"><a href="#cid31" class="heading hyperref"><span class="number">9.2 </span>Implementation</a></li><li><ul><li class="subsection"><a href="#uid100" class="heading hyperref"><span class="number">9.2.1 </span>imports</a></li><li class="subsection"><a href="#uid101" class="heading hyperref"><span class="number">9.2.2 </span>Constraints and objects</a></li><li class="subsection"><a href="#uid107" class="heading hyperref"><span class="number">9.2.3 </span>Minmax and AI support</a></li><li class="subsection"><a href="#uid112" class="heading hyperref"><span class="number">9.2.4 </span>CLI entry</a></li></ul></li></ul></li><li class="chapter"><a href="#cid32" class="heading hyperref"><span class="number">Chapter 10 </span>Day 10: Tic tac toe with GUI!!</a></li><li><ul><li class="section"><a href="#cid33" class="heading hyperref"><span class="number">10.1 </span>Expectation</a></li><li class="section"><a href="#cid34" class="heading hyperref"><span class="number">10.2 </span>Implementation</a></li><li><ul><li class="subsection"><a href="#uid113" class="heading hyperref"><span class="number">10.2.1 </span>minimal ui application</a></li><li class="subsection"><a href="#uid114" class="heading hyperref"><span class="number">10.2.2 </span>TicTacToe GUI</a></li></ul></li></ul></li></ul></div>
<div class="chapter-star" id="preface"><h1><a href="#preface" class="heading hyperref">Preface</a></h1>
<p class="noindent">Documenting my days with The Nim Programming language.</p>
</div></div>

<div id="cid1" data-tralics-id="cid1" class="chapter" data-number="1"><h1><a href="#cid1" class="heading hyperref"><span class="number">Chapter 1 </span>Day 1: Parsing DMIDecode output</a></h1>
<p class="noindent">In our first day we will write a <a href="https://man.cx/?page=dmidecode(8)" target="_blank" rel="noopener">dmidecode</a> parser in nim</p>
</div>
<div id="cid2" data-tralics-id="cid2" class="section" data-number="1.1"><h2><a href="#cid2" class="heading hyperref"><span class="number">1.1 </span>What to expect ?</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">sample1</span> <span class="o">=</span> <span class="s">"""</span>
<span class="s"># dmidecode 3.1</span>
<span class="s">Getting SMBIOS data from sysfs.</span>
<span class="s">SMBIOS 2.6 present.</span>

<span class="s">Handle 0x0001, DMI type 1, 27 bytes</span>
<span class="s">System Information</span>
<span class="s">        Manufacturer: LENOVO</span>
<span class="s">        Product Name: 20042</span>
<span class="s">        Version: Lenovo G560</span>
<span class="s">        Serial Number: 2677240001087</span>
<span class="s">        UUID: CB3E6A50-A77B-E011-88E9-B870F4165734</span>
<span class="s">        Wake-up Type: Power Switch</span>
<span class="s">        SKU Number: Calpella_CRB</span>
<span class="s">        Family: Intel_Mobile</span>
<span class="s">"""</span>

<span class="kn">import</span> <span class="n">dmidecode</span><span class="p">,</span> <span class="n">tables</span>

<span class="kd">var</span> <span class="n">obj</span> <span class="p">:</span> <span class="n">Table</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="n">dmidecode</span><span class="p">.</span><span class="n">Section</span><span class="o">]</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">parseDMI</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
<span class="k">for</span> <span class="n">secname</span><span class="p">,</span> <span class="n">sec</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
    <span class="n">echo</span> <span class="n">secname</span> <span class="o">&amp;</span> <span class="s">" with "</span> <span class="o">&amp;</span> <span class="o">$</span><span class="n">len</span><span class="p">(</span><span class="n">sec</span><span class="p">.</span><span class="n">props</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sec</span><span class="p">.</span><span class="n">props</span><span class="p">:</span>
        <span class="n">echo</span> <span class="s">"k : "</span> <span class="o">&amp;</span> <span class="n">k</span> <span class="o">&amp;</span> <span class="s">" =&gt; "</span> <span class="o">&amp;</span> <span class="n">p</span><span class="p">.</span><span class="n">val</span> 
        <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">items</span><span class="p">:</span>
                <span class="n">echo</span> <span class="s">"</span><span class="se">\t\t</span><span class="s"> I: "</span><span class="p">,</span> <span class="n">i</span>
</pre></div></div>
</div>
<div id="cid3" data-tralics-id="cid3" class="section" data-number="1.2"><h2><a href="#cid3" class="heading hyperref"><span class="number">1.2 </span>Implementation</a></h2>
<p class="noindent">a while ago at work (https://github.com/zero-os/0-core) we needed to parse some dmidecode output, and it sounds like an good problem with enough concepts to get my feet wet in nim.</p>
<div id="uid1" data-tralics-id="uid1" class="subsection" data-number="1.2.1"><h3><a href="#uid1" class="heading hyperref"><span class="number">1.2.1 </span>nimble ready!</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span>mkdir dmidecode
nimble init
</pre></div></div>
</div>
<div id="uid2" data-tralics-id="uid2" class="subsection" data-number="1.2.2"><h3><a href="#uid2" class="heading hyperref"><span class="number">1.2.2 </span>So how does dmidecode output look like?</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span># dmidecode 3.1
Getting SMBIOS data from sysfs.
SMBIOS 2.6 present.

Handle 0x0001, DMI type 1, 27 bytes
System Information
        Manufacturer: LENOVO
        Product Name: 20042
        Version: Lenovo G560
        Serial Number: 2677240001087
        UUID: CB3E6A50-A77B-E011-88E9-B870F4165734
        Wake-up Type: Power Switch
        SKU Number: Calpella_CRB
        Family: Intel_Mobile
</pre></div></div>
<p>or</p>
<div class="code"><div class="highlight"><pre><span></span>Getting SMBIOS data from sysfs.
SMBIOS 2.6 present.

Handle 0x0000, DMI type 0, 24 bytes
BIOS Information
        Vendor: LENOVO
        Version: 29CN40WW(V2.17)
        Release Date: 04/13/2011
        ROM Size: 2048 kB
        Characteristics:
                PCI is supported
                BIOS is upgradeable
                BIOS shadowing is allowed
                Boot from CD is supported
                Selectable boot is supported
                EDD is supported
                Japanese floppy for NEC 9800 1.2 MB is supported (int 13h)
                Japanese floppy for Toshiba 1.2 MB is supported (int 13h)
                5.25"/360 kB floppy services are supported (int 13h)
                5.25"/1.2 MB floppy services are supported (int 13h)
                3.5"/720 kB floppy services are supported (int 13h)
                3.5"/2.88 MB floppy services are supported (int 13h)
                8042 keyboard services are supported (int 9h)
                CGA/mono video services are supported (int 10h)
                ACPI is supported
                USB legacy is supported
                BIOS boot specification is supported
                Targeted content distribution is supported
        BIOS Revision: 1.40
</pre></div></div>
<ul>
<li>DMIDecode output is some meta like comments, versions and one or more sections
</li>
<li>Section: consists of a
<ul>
<li>handle line
</li>
<li>title line
</li>
<li>one or more indented properties
</li></ul>
</li>
<li>Property: consists of
<ul>
<li>key
</li>
<li>optional value
</li>
<li>optional list of indented items
</li></ul>
</li></ul>
</div>
<div id="uid12" data-tralics-id="uid12" class="subsection" data-number="1.2.3"><h3><a href="#uid12" class="heading hyperref"><span class="number">1.2.3 </span>Mapping DMI to nim structures</a></h3>
<p class="noindent">So ourplan is to have an api like
</p><div class="code"><div class="highlight"><pre><span></span><span class="n">dmifile</span> <span class="o">=</span> <span class="n">parseDMI</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="n">dmifile</span><span class="o">[</span><span class="s">"section1"</span><span class="o">][</span><span class="s">"property1].value</span>
</pre></div></div>
<p>Let’s describe the document structure we have
</p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span>  <span class="n">sequtils</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">strutils</span>

<span class="k">type</span> 
    <span class="n">Property</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span>
        <span class="n">val</span><span class="o">*</span><span class="p">:</span> <span class="kt">string</span>
        <span class="n">items</span><span class="o">*</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="kt">string</span><span class="o">]</span>
<span class="k">type</span>
    <span class="n">Section</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span>
        <span class="n">handleLine</span><span class="o">*</span><span class="p">,</span> <span class="n">title</span><span class="o">*</span><span class="p">:</span> <span class="kt">string</span>
        <span class="n">props</span><span class="o">*</span> <span class="p">:</span> <span class="n">Table</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="n">Property</span><span class="o">]</span>

<span class="k">method</span> <span class="n">addItem</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Property</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">this</span><span class="p">.</span><span class="n">items</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div></div>
<p>As our parsing will depend on the indentation level we can use this handy function to get the indentation level of a line (number of spaces before the first asciiLetter)</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">getIndentLevel</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="kt">int</span> <span class="o">=</span> 
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">.</span><span class="n">isSpaceAscii</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">i</span>
    <span class="k">return</span> <span class="mi">0</span>
</pre></div></div>
<p>It’d have been nicer to use <code>takewhile</code>, but it’s not available in nim stdlib
</p><div class="code"><div class="highlight"><pre><span></span>    <span class="n">getindentlevel</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span>  <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">takewhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">isspace</span><span class="p">(),</span> <span class="n">l</span><span class="p">)))</span>
</pre></div></div>
</div>
<div id="uid13" data-tralics-id="uid13" class="subsection" data-number="1.2.4"><h3><a href="#uid13" class="heading hyperref"><span class="number">1.2.4 </span>Parsing DMI source into nim structures</a></h3>
<p class="noindent">There’re many ways to parse the DMI (e.g using regex which would be fairly simple “feel free to implement it” and kindly send me a PR to update this tutorial)
</p><div class="code"><div class="highlight"><pre><span></span>proc parseDMI* (source: string) : Table[string, Section]=
</pre></div></div>
<p>In plain english for output like this
</p><div class="code"><div class="highlight"><pre><span></span>Getting SMBIOS data from sysfs.
SMBIOS 2.6 present.

Handle 0x0000, DMI type 0, 24 bytes
BIOS Information
        Vendor: LENOVO
        Version: 29CN40WW(V2.17)
        Release Date: 04/13/2011
        ROM Size: 2048 kB
        Characteristics:
                PCI is supported
                BIOS is upgradeable
                BIOS shadowing is allowed
                Boot from CD is supported
                Selectable boot is supported
                EDD is supported
                Japanese floppy for NEC 9800 1.2 MB is supported (int 13h)
                Japanese floppy for Toshiba 1.2 MB is supported (int 13h)
                5.25"/360 kB floppy services are supported (int 13h)
                5.25"/1.2 MB floppy services are supported (int 13h)
                3.5"/720 kB floppy services are supported (int 13h)
                3.5"/2.88 MB floppy services are supported (int 13h)
                8042 keyboard services are supported (int 9h)
                CGA/mono video services are supported (int 10h)
                ACPI is supported
                USB legacy is supported
                BIOS boot specification is supported
                Targeted content distribution is supported
        BIOS Revision: 1.40
</pre></div></div>
<p>we have couple of states
</p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> 
    <span class="n">ParserState</span> <span class="o">=</span> <span class="k">enum</span>
        <span class="n">noOp</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">,</span> <span class="n">readKeyValue</span><span class="p">,</span> <span class="n">readList</span>
</pre></div></div>
<ul>
<li>noOp: no action yet
</li>
<li>sectionName: read sectionName
</li>
<li>readKeyValue: read a line has colon <code>:</code> in it into a key value pair
</li>
<li>readList: when the next line has greater indentation level than the property line
</li></ul>
<p>so our state is noOp until we reach line
<code>Handle 0x0000, DMI type 0, 24 bytes</code>
then moves to sectionName</p>
<p>for line <code>BIOS Information</code> then state changes to reading properties
</p><div class="code"><div class="highlight"><pre><span></span>        Vendor: LENOVO
        Version: 29CN40WW(V2.17)
        Release Date: 04/13/2011
        ROM Size: 2048 kB
        Characteristics:
</pre></div></div>
<p>then we notice the indentation on the next line is greater than the one on the current line
</p><div class="code"><div class="highlight"><pre><span></span>                PCI is supported
        Characteristics:
</pre></div></div>
<p>so state moves into readList to read the items related to property <code>Characterstics</code>
</p><div class="code"><div class="highlight"><pre><span></span>                PCI is supported
                BIOS is upgradeable
                BIOS shadowing is allowed
                Boot from CD is supported
                Selectable boot is supported
                EDD is supported
                Japanese floppy for NEC 9800 1.2 MB is supported (int 13h)
                Japanese floppy for Toshiba 1.2 MB is supported (int 13h)
                5.25"/360 kB floppy services are supported (int 13h)
                5.25"/1.2 MB floppy services are supported (int 13h)
                3.5"/720 kB floppy services are supported (int 13h)
                3.5"/2.88 MB floppy services are supported (int 13h)
                8042 keyboard services are supported (int 9h)
                CGA/mono video services are supported (int 10h)
                ACPI is supported
                USB legacy is supported
                BIOS boot specification is supported
                Targeted content distribution is supported
</pre></div></div>
<p>and again it notices the indentation is of the next line is less than the current line
</p><div class="code"><div class="highlight"><pre><span></span>        BIOS Revision: 1.40
                Targeted content distribution is supported
</pre></div></div>
<p>so state switches again into <code>readKeyValue</code></p>
<ul>
<li>if we encounter an empty line:
<ul>
<li>if not in parsing state then it’s a noOp we ignore meta and empty lines
</li>
<li>if in parsing state <code>current Section isn’t nil</code> we finish parsing the section object
</li></ul>
</li></ul>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">parseDMI</span><span class="o">*</span> <span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="n">Table</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="n">Section</span><span class="o">]=</span>
    
    <span class="kd">var</span>
        <span class="n">state</span> <span class="p">:</span> <span class="n">ParserState</span> <span class="o">=</span> <span class="n">noOp</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">strutils</span><span class="p">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">sects</span> <span class="o">=</span> <span class="n">initTable</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="n">Section</span><span class="o">]</span><span class="p">()</span>
        
        <span class="n">p</span><span class="p">:</span> <span class="n">Property</span> <span class="o">=</span> <span class="kp">nil</span>
        <span class="n">s</span><span class="p">:</span> <span class="n">Section</span> <span class="o">=</span> <span class="kp">nil</span> 
        <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="kt">string</span>
</pre></div></div>
<p>Here we define the current state, code lines, initialize a table <code>sects</code> from <code>sectionName</code> to <code>Section Object</code> and variables p <code>current property</code>, s <code>current section</code>, k, v <code>current property key, value</code></p>
<div class="code"><div class="highlight"><pre><span></span>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
</pre></div></div>
<p>Start looping on index, line using <code>pairs</code>
&gt; pairs is kinda like enumerate in python</p>
<div class="code"><div class="highlight"><pre><span></span>        <span class="k">if</span> <span class="n">l</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">"Handle"</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Section</span>
            <span class="n">s</span><span class="p">.</span><span class="n">props</span> <span class="o">=</span> <span class="n">initTable</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="n">Property</span><span class="o">]</span><span class="p">()</span>
            <span class="n">s</span><span class="p">.</span><span class="n">handleline</span> <span class="o">=</span> <span class="n">l</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">sectionName</span>
            <span class="k">continue</span> 
</pre></div></div>
<p>If we encounter the string <code>Handle</code>
- create new section object and initialize it’s props table
- keep track of the handle line
- switch state to reading sectionName
- continue the loop to move to the title line</p>
<div class="code"><div class="highlight"><pre><span></span>        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="s">""</span><span class="p">:</span> <span class="c"># can be just new line before reading any sections. </span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
                <span class="n">sects</span><span class="o">[</span><span class="n">s</span><span class="p">.</span><span class="n">title</span><span class="o">]</span> <span class="o">=</span> <span class="n">s</span>
            <span class="k">continue</span>
</pre></div></div>
<p>if line is empty and we have a section object <code>not nil</code> we finish the section and continue</p>
<div class="code"><div class="highlight"><pre><span></span>        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">sectionName</span><span class="p">:</span>  <span class="c"># current line is the title line</span>
            <span class="n">s</span><span class="p">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">l</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">readKeyValue</span>  <span class="c"># change state into reading key value pairs</span>
</pre></div></div>
<p>If state is sectionName:
- this line is a title line
- change state for the upcoming to readKeyValue</p>
<div class="code"><div class="highlight"><pre><span></span>        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">readKeyValue</span><span class="p">:</span>
            <span class="k">let</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">l</span><span class="p">.</span><span class="n">split</span><span class="p">({</span><span class="sc">':'</span><span class="p">})</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>                 <span class="c"># value can be empty</span>
                <span class="n">v</span> <span class="o">=</span> <span class="s">""</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Property</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">p</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">newSeq</span><span class="o">[</span><span class="kt">string</span><span class="o">]</span><span class="p">()</span>
            <span class="n">p</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">v</span>
</pre></div></div>
<p>If state is readKeyValue
- split the line on colon <code>:</code> to get key, value pair and set v to “” if not present
- make current Property <code>p</code> and initialize its related fields <code>items</code>, <code>val</code></p>
<div class="code"><div class="highlight"><pre><span></span>            <span class="c"># current line indentation is &lt;  nextline indentation =&gt; change state to readList</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">getIndentlevel</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">getIndentlevel</span><span class="p">(</span><span class="n">lines</span><span class="o">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">]</span><span class="p">))</span> <span class="p">:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">readList</span>
</pre></div></div>
<p>If the next line indentation is greater this means we’re should be reading list of items regarding the current property <code>p</code></p>
<div class="code"><div class="highlight"><pre><span></span>            <span class="k">else</span><span class="p">:</span>
                <span class="c"># add key/value pair directly</span>
                <span class="n">s</span><span class="p">.</span><span class="n">props</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">p</span>
</pre></div></div>
<p>If not finish the property</p>
<div class="code"><div class="highlight"><pre><span></span>        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">readList</span><span class="p">:</span>
            <span class="c"># keep adding the current line to current property items and if dedented =&gt; change state to readKeyValue</span>
            <span class="n">p</span><span class="p">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">getindentlevel</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">getindentlevel</span><span class="p">(</span><span class="n">lines</span><span class="o">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">]</span><span class="p">):</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">readKeyValue</span> 
                <span class="n">s</span><span class="p">.</span><span class="n">props</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">p</span>
</pre></div></div>
<p>if state is <code>readList</code>
- keep adding items to current property <code>p</code>
- if the indentation level decreased change state to <code>readKeyValue</code> and finish property
</p><div class="code"><div class="highlight"><pre><span></span>    return sects
</pre></div></div>
</div></div>
<div id="cid4" data-tralics-id="cid4" class="chapter" data-number="2"><h1><a href="#cid4" class="heading hyperref"><span class="number">Chapter 2 </span>Day 2: Parsing Bencode</a></h1>
<p class="noindent">nim-bencode is a library to encode/decode torrent files <a href="https://en.wikipedia.org/wiki/Bencode" target="_blank" rel="noopener">Bencode</a></p>
</div>
<div id="cid5" data-tralics-id="cid5" class="section" data-number="2.1"><h2><a href="#cid5" class="heading hyperref"><span class="number">2.1 </span>What to expect?</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">bencode</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">strformat</span>

<span class="k">let</span> <span class="n">encoder</span> <span class="o">=</span> <span class="n">newEncoder</span><span class="p">()</span>
<span class="k">let</span> <span class="n">decoder</span> <span class="o">=</span> <span class="n">newDecoder</span><span class="p">()</span>

<span class="k">let</span> <span class="n">btListSample1</span> <span class="o">=</span> <span class="o">@[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"hi"</span><span class="p">)</span> <span class="o">]</span>
<span class="kd">var</span> <span class="n">btDictSample1</span> <span class="o">=</span> <span class="n">initOrderedTable</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">,</span> <span class="n">BencodeType</span><span class="o">]</span><span class="p">()</span>
<span class="n">btDictSample1</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"name"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"dmdm"</span><span class="p">)</span>
<span class="n">btDictSample1</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"lang"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"nim"</span><span class="p">)</span>
<span class="n">btDictSample1</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"age"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="mi">50</span><span class="p">)</span>
<span class="n">btDictSample1</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"alist"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btList</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">btListSample1</span><span class="p">)</span>

<span class="kd">var</span> <span class="n">testObjects</span> <span class="o">=</span> <span class="n">initOrderedTable</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">,</span> <span class="kt">string</span><span class="o">]</span><span class="p">()</span>
<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"hello"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"5:hello"</span>
<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"yes"</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"3:yes"</span>
<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="mi">55</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"i55e"</span>

<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="mi">12345</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"i12345e"</span>
<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btList</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">btListSample1</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"li1e2:hie"</span>
<span class="n">testObjects</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btDict</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span><span class="n">btDictSample1</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="s">"d4:name4:dmdm4:lang3:nim3:agei50e5:alistli1e2:hiee"</span>


<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">testObjects</span><span class="p">.</span><span class="n">pairs</span><span class="p">():</span>
    <span class="n">echo</span> <span class="o">$</span><span class="n">k</span> <span class="o">&amp;</span> <span class="s">" =&gt; "</span> <span class="o">&amp;</span> <span class="o">$</span><span class="n">v</span>
    <span class="n">doAssert</span><span class="p">(</span><span class="n">encoder</span><span class="p">.</span><span class="n">encodeObject</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">doAssert</span><span class="p">(</span><span class="n">decoder</span><span class="p">.</span><span class="n">decodeObject</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
</pre></div></div>
</div>
<div id="cid6" data-tralics-id="cid6" class="section" data-number="2.2"><h2><a href="#cid6" class="heading hyperref"><span class="number">2.2 </span>Implementation</a></h2>
<p class="noindent">So according to Bencode we have some datatypes
- strings and those are encoded with the string length followed by a colon and the string itself <code>length:string</code>, e.g yes will be encoded into <code>3:yes</code>
- ints those are encoded between <code>i</code>, <code>e</code> letters, e.g 59 will be encoded into <code>i59e</code>
- lists can contain any of the bencode types and it’s encoded with <code>l</code>, <code>e</code>, e.g list of 1, 2 numbers is encoded into <code>li1ei2e</code> or with spaces for verbosity <code>l i1e i2e e</code>
- dicts are mapping from strings to any type and encoded between letters <code>d</code>, <code>e</code>, e.g name =&gt; hi and num =&gt; 3 is encoded into <code>d4:name2:hi3:numi3ee</code> or with spaces for verbosity <code>d 4:name 2:hi 3:num i3e e</code></p>
<div id="uid21" data-tralics-id="uid21" class="subsection" data-number="2.2.1"><h3><a href="#uid21" class="heading hyperref"><span class="number">2.2.1 </span>Imports</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">strformat</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">strutils</span><span class="p">,</span> <span class="n">hashes</span>
</pre></div></div>
<p>As we will be dealing a lot with strings, tables</p>
</div>
<div id="uid22" data-tralics-id="uid22" class="subsection" data-number="2.2.2"><h3><a href="#uid22" class="heading hyperref"><span class="number">2.2.2 </span>Types</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> 
    <span class="n">BencodeKind</span><span class="o">*</span> <span class="o">=</span> <span class="k">enum</span>
        <span class="n">btString</span><span class="p">,</span> <span class="n">btInt</span><span class="p">,</span> <span class="n">btList</span><span class="p">,</span> <span class="n">btDict</span>
</pre></div></div>
<p>So as we mentioned about bencode data types we can define an enum to represents the kinds</p>
<div class="code"><div class="highlight"><pre><span></span>    <span class="n">BencodeType</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span>
        <span class="k">case</span> <span class="n">kind</span><span class="o">*</span><span class="p">:</span> <span class="n">BencodeKind</span> 
        <span class="k">of</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btString</span><span class="p">:</span> <span class="n">s</span><span class="o">*</span> <span class="p">:</span> <span class="kt">string</span> 
        <span class="k">of</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btInt</span><span class="p">:</span> <span class="n">i</span><span class="o">*</span>    <span class="p">:</span> <span class="kt">int</span>
        <span class="k">of</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btList</span><span class="p">:</span> <span class="n">l</span><span class="o">*</span>   <span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="n">BencodeType</span><span class="o">]</span>
        <span class="k">of</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btDict</span><span class="p">:</span> <span class="n">d</span><span class="o">*</span>  <span class="p">:</span> <span class="n">OrderedTable</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">,</span> <span class="n">BencodeType</span><span class="o">]</span>

    <span class="n">Encoder</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span>
    <span class="n">Decoder</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> 
</pre></div></div>
<ul>
<li><code>Encoder</code> a simple class to represent encoding operations
</li>
<li><code>Decoder</code> a simple class to represent decoding operations
</li>
<li>For <code>BencodeType</code> we make use of variant objects <code>case classes</code> in other languages.<span class="intersentencespace"></span> worth noticing variant objects are the same technique used for <code>json</code> module.<span class="intersentencespace"></span>
</li></ul>
<p>So we can use it like this</p>
<div class="code"><div class="highlight"><pre><span></span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"hello"</span><span class="p">)</span>
<span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="mi">55</span><span class="p">)</span>
<span class="k">let</span> <span class="n">btListSample1</span> <span class="o">=</span> <span class="o">@[</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="s">"hi"</span><span class="p">)</span> <span class="o">]</span>
<span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">btList</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">btListSample1</span><span class="p">)</span>
</pre></div></div>
<p>So general rule for the case classes is you have a kind defined in an enum and a constructor value u create the object with.</p>
<p>If you’re coming from Haskell or a similar language</p>
<div class="code"><div class="highlight"><pre><span></span><span class="kr">data</span> <span class="kt">BValue</span> <span class="ow">=</span> <span class="kt">BInt</span> <span class="kt">Integer</span>
            <span class="o">|</span> <span class="kt">BStr</span> <span class="kt">B</span><span class="o">.</span><span class="kt">ByteString</span>
            <span class="o">|</span> <span class="kt">BList</span> <span class="p">[</span><span class="kt">BValue</span><span class="p">]</span>
            <span class="o">|</span> <span class="kt">BDict</span> <span class="p">(</span><span class="kt">M</span><span class="o">.</span><span class="kt">Map</span> <span class="kt">BValue</span> <span class="kt">BValue</span><span class="p">)</span>
            <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Show</span><span class="p">,</span> <span class="kt">Eq</span><span class="p">,</span> <span class="kt">Ord</span><span class="p">)</span>
</pre></div></div>
<p>Please, note if you define your own variant you should define <code>hash</code>, <code>==</code> procs to be able to compare or hash the values.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">hash</span><span class="o">*</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">BencodeType</span><span class="p">):</span> <span class="n">Hash</span> <span class="o">=</span> 
    <span class="k">case</span> <span class="n">obj</span><span class="p">.</span><span class="n">kind</span>
    <span class="k">of</span> <span class="n">btString</span> <span class="p">:</span> <span class="o">!$</span><span class="p">(</span><span class="n">hash</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">s</span><span class="p">))</span>
    <span class="k">of</span> <span class="n">btInt</span> <span class="p">:</span> <span class="o">!$</span><span class="p">(</span><span class="n">hash</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">i</span><span class="p">))</span>
    <span class="k">of</span> <span class="n">btList</span><span class="p">:</span> <span class="o">!$</span><span class="p">(</span><span class="n">hash</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">l</span><span class="p">))</span>
    <span class="k">of</span> <span class="n">btDict</span><span class="p">:</span> 
        <span class="kd">var</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">pairs</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">hash</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">!&amp;</span> <span class="n">hash</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">!$</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</pre></div></div>
<ul>
<li><code>hash</code> proc returns <code>Hash</code> and depending on the <code>kind</code> we return the hash of the underlying stored objects, strings, ints, lists or calculate a new hash if needed
</li>
<li><code>!&amp;</code> consider it like merging the two hashes together
</li>
<li><code>!$</code> is used to finalize the Hash object
</li></ul>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">`==`</span><span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">BencodeType</span><span class="p">):</span> <span class="kt">bool</span> <span class="o">=</span>
    <span class="sd">## Check two nodes for equality</span>
    <span class="k">if</span> <span class="n">a</span><span class="p">.</span><span class="n">isNil</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">b</span><span class="p">.</span><span class="n">isNil</span><span class="p">:</span> <span class="k">return</span> <span class="kp">true</span>
        <span class="k">return</span> <span class="kp">false</span>
    <span class="k">elif</span> <span class="n">b</span><span class="p">.</span><span class="n">isNil</span> <span class="ow">or</span> <span class="n">a</span><span class="p">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="n">b</span><span class="p">.</span><span class="n">kind</span><span class="p">:</span>
        <span class="k">return</span> <span class="kp">false</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">a</span><span class="p">.</span><span class="n">kind</span>
        <span class="k">of</span> <span class="n">btString</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">s</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="n">s</span>
        <span class="k">of</span> <span class="n">btInt</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">i</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="n">i</span>
        <span class="k">of</span> <span class="n">btList</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">l</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="n">l</span>
        <span class="k">of</span> <span class="n">btDict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">len</span> <span class="o">!=</span> <span class="n">b</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">len</span><span class="p">:</span> <span class="k">return</span> <span class="kp">false</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">a</span><span class="p">.</span><span class="n">d</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">hasKey</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="k">return</span> <span class="kp">false</span>
                <span class="k">if</span> <span class="n">b</span><span class="p">.</span><span class="n">d</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span> <span class="k">return</span> <span class="kp">false</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kp">true</span>
</pre></div></div>
<p>define equality operator on BencodeTypes to determine when they’re equal by defining proc for operator <code>==</code></p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">`$`</span><span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">BencodeType</span><span class="p">):</span> <span class="kt">string</span> <span class="o">=</span> 
    <span class="k">case</span> <span class="n">a</span><span class="p">.</span><span class="n">kind</span>
    <span class="k">of</span> <span class="n">btString</span><span class="p">:</span>  <span class="n">fmt</span><span class="p">(</span><span class="s">"&lt;Bencode {a.s}&gt;"</span><span class="p">)</span>
    <span class="k">of</span> <span class="n">btInt</span><span class="p">:</span> <span class="n">fmt</span><span class="p">(</span><span class="s">"&lt;Bencode {a.i}&gt;"</span><span class="p">)</span>
    <span class="k">of</span> <span class="n">btList</span><span class="p">:</span> <span class="n">fmt</span><span class="p">(</span><span class="s">"&lt;Bencode {a.l}&gt;"</span><span class="p">)</span>
    <span class="k">of</span> <span class="n">btDict</span><span class="p">:</span> <span class="n">fmt</span><span class="p">(</span><span class="s">"&lt;Bencode {a.d}"</span><span class="p">)</span>
</pre></div></div>
<p>Define a simple <code>toString</code> proc using the <code>$</code> operator.</p>
</div>
<div id="uid29" data-tralics-id="uid29" class="subsection" data-number="2.2.3"><h3><a href="#uid29" class="heading hyperref"><span class="number">2.2.3 </span>Encoding</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">encode</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">,</span>  <span class="n">obj</span><span class="p">:</span> <span class="n">BencodeType</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span>
</pre></div></div>
<p>we add forward declarating to encode proc because to encode a list we might encode another values <code>strings</code>, or even <code>lists</code> so we will recursively call encode if needed, feel free to skip to the next part.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">encode_s</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span><span class="o">=</span>
    <span class="c"># TODO: check len</span>
    <span class="k">return</span> <span class="o">$</span><span class="n">s</span><span class="p">.</span><span class="n">len</span> <span class="o">&amp;</span> <span class="s">":"</span> <span class="o">&amp;</span> <span class="n">s</span>
</pre></div></div>
<p>To encode a string we said we will put encoded with its length + <code>:</code> + string itself</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">encode_i</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="kt">int</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span><span class="o">=</span>
    <span class="c"># TODO: check len</span>
    <span class="k">return</span> <span class="n">fmt</span><span class="p">(</span><span class="s">"i{i}e"</span><span class="p">)</span> 
</pre></div></div>
<p>To encode an int we put it between <code>i</code>, <code>e</code> chars</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">encode_l</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="n">BencodeType</span><span class="o">]</span><span class="p">):</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">encoded</span> <span class="o">=</span> <span class="s">"l"</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="n">encoded</span> <span class="o">&amp;=</span> <span class="n">this</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
    <span class="n">encoded</span> <span class="o">&amp;=</span> <span class="s">"e"</span>
    <span class="k">return</span> <span class="n">encoded</span>
</pre></div></div>
<p>- To encode a list of elements of type <code>BencodeType</code> we put their encoded values between <code>l</code>, <code>e</code> chars
- Notice the call to <code>this.encode</code> that’s why we needed the forward declaration.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">encode_d</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="n">OrderedTable</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">,</span> <span class="n">BencodeType</span><span class="o">]</span><span class="p">):</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">encoded</span> <span class="o">=</span> <span class="s">"d"</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="p">.</span><span class="n">pairs</span><span class="p">():</span>
        <span class="n">assert</span> <span class="n">k</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btString</span>
        <span class="n">encoded</span> <span class="o">&amp;=</span> <span class="n">this</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">this</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="n">encoded</span> <span class="o">&amp;=</span> <span class="s">"e"</span>
    <span class="k">return</span> <span class="n">encoded</span>
</pre></div></div>
<p>- To encode a dict we enclose the encoded value of the pairs between <code>d</code>, <code>e</code>
- Notice the recursive call to <code>this.encode</code> to the keys and values
- Notice the assertion the kind of the keys <code>must</code> be a <code>btString</code> according to <code>Bencode</code> specs.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">encode</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">,</span>  <span class="n">obj</span><span class="p">:</span> <span class="n">BencodeType</span><span class="p">)</span> <span class="p">:</span>  <span class="kt">string</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">obj</span><span class="p">.</span><span class="n">kind</span>
    <span class="k">of</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btString</span><span class="p">:</span>  <span class="n">result</span> <span class="o">=</span><span class="n">this</span><span class="p">.</span><span class="n">encode_s</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">s</span><span class="p">)</span>
    <span class="k">of</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btInt</span> <span class="p">:</span>  <span class="n">result</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">encode_i</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">i</span><span class="p">)</span>
    <span class="k">of</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btList</span> <span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">encode_l</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">l</span><span class="p">)</span>
    <span class="k">of</span> <span class="n">BencodeKind</span><span class="p">.</span><span class="n">btDict</span> <span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">encode_d</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">d</span><span class="p">)</span>
</pre></div></div>
<p>Simple proxy to encode <code>obj</code> of <code>BencodeType</code></p>
</div>
<div id="uid30" data-tralics-id="uid30" class="subsection" data-number="2.2.4"><h3><a href="#uid30" class="heading hyperref"><span class="number">2.2.4 </span>Decoding</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">decode</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">,</span>  <span class="n">source</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span>
</pre></div></div>
<p>Forward declaration for <code>decode</code> same as <code>decode</code></p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">decode_s</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">lengthpart</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">":"</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    <span class="k">let</span> <span class="n">sizelength</span> <span class="o">=</span> <span class="n">lengthpart</span><span class="p">.</span><span class="n">len</span>
    <span class="k">let</span> <span class="n">strlen</span> <span class="o">=</span> <span class="n">parseInt</span><span class="p">(</span><span class="n">lengthpart</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btString</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">[</span><span class="n">sizelength</span><span class="o">+</span><span class="mf">1</span><span class="p">..</span><span class="n">strlen</span><span class="o">+</span><span class="mi">1</span><span class="o">]</span><span class="p">),</span> <span class="n">sizelength</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">strlen</span><span class="p">)</span>
</pre></div></div>
<p>Create a BencodeType of after decoding a string <code>reverse operation of encode_s</code>
Basically and read string of length <code>sizelength</code> after the <code>colon</code> and construct a <code>BencodeType</code> of kind <code>btString</code> out of it</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">decode_i</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">epos</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="sc">'e'</span><span class="p">)</span>
    <span class="k">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">parseInt</span><span class="p">(</span><span class="n">s</span><span class="o">[</span><span class="mf">1</span><span class="p">..</span><span class="o">&lt;</span><span class="n">epos</span><span class="o">]</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btInt</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">),</span> <span class="n">epos</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</pre></div></div>
<p>Extract the number between <code>i</code>, <code>e</code> chars and construct <code>BencodeType</code> of kind <code>btInt</code> out of it</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">decode_l</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="kt">string</span><span class="p">):</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span>
    <span class="c"># l ... e</span>
    <span class="kd">var</span> <span class="n">els</span> <span class="o">=</span> <span class="n">newSeq</span><span class="o">[</span><span class="n">BencodeType</span><span class="o">]</span><span class="p">()</span>
    <span class="kd">var</span> <span class="n">curchar</span> <span class="o">=</span> <span class="n">s</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
    <span class="kd">var</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">len</span><span class="p">:</span>
        <span class="n">curchar</span> <span class="o">=</span> <span class="n">s</span><span class="o">[</span><span class="n">idx</span><span class="o">]</span>
        <span class="k">if</span> <span class="n">curchar</span> <span class="o">==</span> <span class="sc">'e'</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">break</span>
    
        <span class="k">let</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">s</span><span class="o">[</span><span class="n">idx</span><span class="p">..</span><span class="o">&lt;</span><span class="n">s</span><span class="p">.</span><span class="n">len</span><span class="o">]</span><span class="p">)</span>
        <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
        <span class="k">let</span> <span class="n">nextobjpos</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> 
        <span class="n">els</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="n">nextobjpos</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btList</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span><span class="n">els</span><span class="p">),</span> <span class="n">idx</span><span class="p">)</span>
</pre></div></div>
<p>Decoding the list can be bit tricky
- Its elements are between <code>l</code>, <code>e</code> chars
- So we start trying to decode objects starting from the first letter <code>after</code> the <code>l</code> until we reach the final <code>e</code>
e.g
</p><div class="code"><div class="highlight"><pre><span></span>li1ei2ee
</pre></div></div>
<p>will be parsed like the following
</p><div class="code"><div class="highlight"><pre><span></span>li120ei492ee
 $   $
</pre></div></div>
<ul>
<li>will consume the object <code>i120e</code> and set the cursor to the beginning of the second object <code>i492e</code>
</li>
<li>after all the objects are consumed we consume the end character <code>e</code> and we are done
</li>
<li>That’s why all decode procs return <code>int</code> value to let us now how much characters to skip
</li></ul>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">decode_d</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="kt">string</span><span class="p">):</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">d</span> <span class="o">=</span> <span class="n">initOrderedTable</span><span class="o">[</span><span class="n">BencodeType</span><span class="p">,</span> <span class="n">BencodeType</span><span class="o">]</span><span class="p">()</span>
    <span class="kd">var</span> <span class="n">curchar</span> <span class="o">=</span> <span class="n">s</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
    <span class="kd">var</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="kd">var</span> <span class="n">readingKey</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="kd">var</span> <span class="n">curKey</span><span class="p">:</span> <span class="n">BencodeType</span>
    <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">len</span><span class="p">:</span>
        <span class="n">curchar</span> <span class="o">=</span> <span class="n">s</span><span class="o">[</span><span class="n">idx</span><span class="o">]</span>
        <span class="k">if</span> <span class="n">curchar</span> <span class="o">==</span> <span class="sc">'e'</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">let</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">s</span><span class="o">[</span><span class="n">idx</span><span class="p">..</span><span class="o">&lt;</span><span class="n">s</span><span class="p">.</span><span class="n">len</span><span class="o">]</span><span class="p">)</span>
        <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
        <span class="k">let</span> <span class="n">nextobjpos</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
        <span class="k">if</span> <span class="n">readingKey</span> <span class="o">==</span> <span class="kp">true</span><span class="p">:</span>
            <span class="n">curKey</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="n">readingKey</span> <span class="o">=</span> <span class="kp">false</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span><span class="o">[</span><span class="n">curKey</span><span class="o">]</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="n">readingKey</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="n">nextobjpos</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span><span class="n">btDict</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">),</span> <span class="n">idx</span><span class="p">)</span>
</pre></div></div>
<ul>
<li>Same technique as above
</li>
<li>Basically we read one object if we don’t have a current key then we set it as the current key
</li>
<li>If we have a current key object then the object we read is the value, so we set the currentKey to that value and <code>change</code> mode to readingKey again.<span class="intersentencespace"></span>
</li></ul>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">decode</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">,</span>  <span class="n">source</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">BencodeType</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">curchar</span> <span class="o">=</span> <span class="n">source</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    <span class="kd">var</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">source</span><span class="p">.</span><span class="n">len</span><span class="p">:</span>
        <span class="n">curchar</span> <span class="o">=</span> <span class="n">source</span><span class="o">[</span><span class="n">idx</span><span class="o">]</span>
        <span class="k">case</span> <span class="n">curchar</span>
        <span class="k">of</span> <span class="sc">'i'</span><span class="p">:</span>
            <span class="k">let</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">decode_i</span><span class="p">(</span><span class="n">source</span><span class="o">[</span><span class="n">idx</span><span class="p">..</span><span class="n">source</span><span class="p">.</span><span class="n">len</span><span class="o">]</span><span class="p">)</span>
            <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
            <span class="k">let</span> <span class="n">nextobjpos</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> 
            <span class="n">idx</span> <span class="o">+=</span> <span class="n">nextobjpos</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">of</span> <span class="sc">'l'</span><span class="p">:</span>
            <span class="k">let</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">decode_l</span><span class="p">(</span><span class="n">source</span><span class="o">[</span><span class="n">idx</span><span class="p">..</span><span class="n">source</span><span class="p">.</span><span class="n">len</span><span class="o">]</span><span class="p">)</span>
            <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
            <span class="k">let</span> <span class="n">nextobjpos</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> 
            <span class="n">idx</span> <span class="o">+=</span> <span class="n">nextobjpos</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">of</span> <span class="sc">'d'</span><span class="p">:</span>
            <span class="k">let</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">decode_d</span><span class="p">(</span><span class="n">source</span><span class="o">[</span><span class="n">idx</span><span class="p">..</span><span class="n">source</span><span class="p">.</span><span class="n">len</span><span class="o">]</span><span class="p">)</span>
            <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
            <span class="k">let</span> <span class="n">nextobjpos</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> 
            <span class="n">idx</span> <span class="o">+=</span> <span class="n">nextobjpos</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">let</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">decode_s</span><span class="p">(</span><span class="n">source</span><span class="o">[</span><span class="n">idx</span><span class="p">..</span><span class="n">source</span><span class="p">.</span><span class="n">len</span><span class="o">]</span><span class="p">)</span>
            <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
            <span class="k">let</span> <span class="n">nextobjpos</span> <span class="o">=</span> <span class="n">pair</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> 
            <span class="n">idx</span> <span class="o">+=</span> <span class="n">nextobjpos</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</pre></div></div>
<p>Starts decoding based on the beginning of character encoding object <code>i</code> for int, <code>l</code> for lists, <code>d</code> for dicts and otherwise tries to parse string</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">newEncoder</span><span class="o">*</span><span class="p">():</span> <span class="n">Encoder</span> <span class="o">=</span>
    <span class="n">new</span> <span class="n">Encoder</span>

<span class="k">proc </span><span class="nf">newDecoder</span><span class="o">*</span><span class="p">():</span> <span class="n">Decoder</span> <span class="o">=</span> 
    <span class="n">new</span> <span class="n">Decoder</span>
</pre></div></div>
<p>Simple constructor procs for newEncoder, newDecoder</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">encodeObject</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">BencodeType</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div></div>
<p><code>encodeObject</code> dispatch the call to <code>encode</code> proc.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">decodeObject</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span><span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="n">BencodeType</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">p</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</pre></div></div>
<p><code>decodeObject</code> provides a friendlier API to return the BencodeType from decode instead of <code>BencodeType</code>, <code>how many to read</code> int</p>
</div></div>
<div id="cid7" data-tralics-id="cid7" class="chapter" data-number="3"><h1><a href="#cid7" class="heading hyperref"><span class="number">Chapter 3 </span>Day 3: Talking to C (FFI and libmagic)</a></h1>
<p class="noindent">Libmagic is a magic number recognition library, remember everytime you called <code>file</code> utility on a file to know its type?</p>
<div class="code"><div class="highlight"><pre><span></span>➜  file /usr/bin/rm
/usr/bin/rm: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=cbae26b2a032b1ce3129d56aee2bcf70dd8deeb0, stripped
➜  nim-magic file /
/: directory
➜  file /usr/include/stdio.h
/usr/include/stdio.h: C source, ASCII text
</pre></div></div>
</div>
<div id="cid8" data-tralics-id="cid8" class="section" data-number="3.1"><h2><a href="#cid8" class="heading hyperref"><span class="number">3.1 </span>What to expect?</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">magic</span>

<span class="n">echo</span> <span class="n">magic</span><span class="p">.</span><span class="n">guessFile</span><span class="p">(</span><span class="s">"/usr/bin/rm"</span><span class="p">)</span>
</pre></div></div>
<p>The output should be something like
</p><div class="code"><div class="highlight"><pre><span></span>ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=cbae26b2a032b1ce3129d56aee2bcf70dd8deeb0, stripped
</pre></div></div>
</div>
<div id="cid9" data-tralics-id="cid9" class="section" data-number="3.2"><h2><a href="#cid9" class="heading hyperref"><span class="number">3.2 </span>Implementation</a></h2>
<p class="noindent"><a href="https://livebook.manning.com/#!/book/nim-in-action/chapter-8/1" target="_blank" rel="noopener">FFI Chapter</a> of <a href="https://www.manning.com/books/nim-in-action" target="_blank" rel="noopener">Nim in Action</a> is freely available.</p>
<div id="uid37" data-tralics-id="uid37" class="subsection" data-number="3.2.1"><h3><a href="#uid37" class="heading hyperref"><span class="number">3.2.1 </span>Step 1: Get the library info</a></h3>
<p class="noindent">Well, libmagic has <code>libmagic.so</code> in your library path <code>/usr/lib/libmagic.so</code> and a header file <code>magic.h</code> in <code>/usr/include/magic.h</code>.<span class="intersentencespace"></span> create a constant for the libmagic library name.<span class="intersentencespace"></span> </p><div class="code"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">libName</span><span class="o">*</span> <span class="o">=</span> <span class="s">"libmagic.so"</span>
</pre></div></div>
</div>
<div id="uid38" data-tralics-id="uid38" class="subsection" data-number="3.2.2"><h3><a href="#uid38" class="heading hyperref"><span class="number">3.2.2 </span>Step 2: Extract constants</a></h3>
<p class="noindent">We should extract the constants from the header</p>
<div class="code"><div class="highlight"><pre><span></span><span class="cp">#define MAGIC_NONE              0x0000000 </span><span class="cm">/* No flags */</span><span class="cp"></span>
<span class="cp">#define MAGIC_DEBUG             0x0000001 </span><span class="cm">/* Turn on debugging */</span><span class="cp"></span>
<span class="cp">#define MAGIC_SYMLINK           0x0000002 </span><span class="cm">/* Follow symlinks */</span><span class="cp"></span>
<span class="cp">#define MAGIC_COMPRESS          0x0000004 </span><span class="cm">/* Check inside compressed files */</span><span class="cp"></span>
<span class="cp">#define MAGIC_DEVICES           0x0000008 </span><span class="cm">/* Look at the contents of devices */</span><span class="cp"></span>
<span class="cp">#define MAGIC_MIME_TYPE         0x0000010 </span><span class="cm">/* Return the MIME type */</span><span class="cp"></span>
<span class="cp">#define MAGIC_CONTINUE          0x0000020 </span><span class="cm">/* Return all matches */</span><span class="cp"></span>
<span class="cp">#define MAGIC_CHECK             0x0000040 </span><span class="cm">/* Print warnings to stderr */</span><span class="cp"></span>
<span class="p">....</span>
</pre></div></div>
<p>So in nim It’d be something like this
</p><div class="code"><div class="highlight"><pre><span></span><span class="k">const</span>  <span class="n">MAGIC_NONE</span><span class="o">*</span>  <span class="o">=</span> <span class="mh">0x000000</span>                 <span class="c"># No flags </span>
<span class="k">const</span>  <span class="n">MAGIC_DEBUG</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000001</span>                 <span class="c"># Turn on debugging </span>
<span class="k">const</span>  <span class="n">MAGIC_SYMLINK</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000002</span>                 <span class="c"># Follow symlinks </span>
<span class="k">const</span>  <span class="n">MAGIC_COMPRESS</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000004</span>                <span class="c"># Check inside compressed files </span>
<span class="k">const</span>  <span class="n">MAGIC_DEVICES</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000008</span>                 <span class="c"># Look at the contents of devices </span>
<span class="k">const</span>  <span class="n">MAGIC_MIME_TYPE</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000010</span>            <span class="c"># Return only the MIME type </span>
<span class="k">const</span>  <span class="n">MAGIC_CONTINUE</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000020</span>             <span class="c"># Return all matches </span>
<span class="k">const</span>  <span class="n">MAGIC_CHECK</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000040</span>                 <span class="c"># Print warnings to stderr </span>
<span class="k">const</span>  <span class="n">MAGIC_PRESERVE_ATIME</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000080</span>        <span class="c"># Restore access time on exit </span>
<span class="k">const</span>  <span class="n">MAGIC_RAW</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000100</span>                    <span class="c"># Don't translate unprint chars </span>
<span class="k">const</span>  <span class="n">MAGIC_ERROR</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000200</span>                 <span class="c"># Handle ENOENT etc as real errors </span>
<span class="k">const</span>  <span class="n">MAGIC_MIME_ENCODING</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x000400</span>         <span class="c"># Return only the MIME encoding </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_COMPRESS</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x001000</span>     <span class="c"># Don't check for compressed files </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_TAR</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x002000</span>         <span class="c"># Don't check for tar files </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_SOFT</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x004000</span>         <span class="c"># Don't check magic entries </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_APPTYPE</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x008000</span>        <span class="c"># Don't check application type </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_ELF</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x010000</span>            <span class="c"># Don't check for elf details </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_ASCII</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x020000</span>         <span class="c"># Don't check for ascii files </span>
<span class="k">const</span>  <span class="n">MAGIC_NO_CHECK_TOKENS</span><span class="o">*</span> <span class="o">=</span> <span class="mh">0x100000</span>         <span class="c"># Don't check ascii/tokens </span>
</pre></div></div>
</div>
<div id="uid39" data-tralics-id="uid39" class="subsection" data-number="3.2.3"><h3><a href="#uid39" class="heading hyperref"><span class="number">3.2.3 </span>Step 3: Extract the types</a></h3>
<p class="noindent"><code>typedef struct magic_set *magic_t;</code>
so the only type we have is a pointer to some struct (object)</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">Magic</span> <span class="o">=</span> <span class="k">object</span>
<span class="k">type</span> <span class="n">MagicPtr</span><span class="o">*</span> <span class="o">=</span> <span class="k">ptr</span> <span class="n">Magic</span> 
</pre></div></div>
</div>
<div id="uid40" data-tralics-id="uid40" class="subsection" data-number="3.2.4"><h3><a href="#uid40" class="heading hyperref"><span class="number">3.2.4 </span>Step 4: Extract procedures</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="n">magic_t</span> <span class="nf">magic_open</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">magic_close</span><span class="p">(</span><span class="n">magic_t</span><span class="p">);</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">magic_getpath</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">magic_file</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">magic_descriptor</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">magic_buffer</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">magic_error</span><span class="p">(</span><span class="n">magic_t</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_getflags</span><span class="p">(</span><span class="n">magic_t</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_setflags</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">magic_version</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_load</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_load_buffers</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">magic_compile</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_check</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_list</span><span class="p">(</span><span class="n">magic_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">magic_errno</span><span class="p">(</span><span class="n">magic_t</span><span class="p">);</span>
</pre></div></div>
<p>we only care about <code>magic_open</code>, <code>magic_load</code>, <code>magic_close</code>, <code>magic_file</code>, <code>magic_error</code></p>
<div class="code"><div class="highlight"><pre><span></span><span class="c"># magic_t magic_open(int);</span>
<span class="k">proc </span><span class="nf">magic_open</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">cint</span><span class="p">)</span> <span class="p">:</span> <span class="n">MagicPtr</span> <span class="p">{.</span><span class="n">importc</span><span class="p">,</span> <span class="n">dynlib</span><span class="p">:</span><span class="n">libName</span><span class="p">.}</span>
</pre></div></div>
<p><code>magic_open</code> is a proc declared in dynamic lib <code>libmagic.so</code>, that is takes a cint “compatible c int” <code>i</code> and returns a <code>MagicPtr</code>.</p>
<p>From the manpage
&gt; The function magic_open() creates a magic cookie pointer and returns it.<span class="intersentencespace"></span> It returns NULL if there was an error allocating the magic cookie.<span class="intersentencespace"></span> The flags argument specifies how the other magic functions should behave</p>
<div class="code"><div class="highlight"><pre><span></span><span class="c"># void magic_close(magic_t);</span>
<span class="k">proc </span><span class="nf">magic_close</span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">MagicPtr</span><span class="p">):</span> <span class="n">void</span> <span class="p">{.</span><span class="n">importc</span><span class="p">,</span>  <span class="n">dynlib</span><span class="p">:</span><span class="n">libName</span><span class="p">.}</span>
</pre></div></div>
<p><code>magic_close</code> is a proc declared in dynlib <code>libmagic.so</code> and takes an argumnet p of type <code>MagicPtr</code> and returns <code>void</code></p>
<p>From the manpage
&gt; The magic_close() function closes the magic(5) database and deallocates any resources used.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="c">#int magic_load(magic_t, const char *);</span>
<span class="k">proc </span><span class="nf">magic_load</span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">MagicPtr</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span><span class="n">cstring</span><span class="p">)</span> <span class="p">:</span> <span class="n">cint</span> <span class="p">{.</span><span class="n">importc</span><span class="p">,</span> <span class="n">dynlib</span><span class="p">:</span> <span class="n">libName</span><span class="p">.}</span>
</pre></div></div>
<p><code>magic_load</code> is a proc declared in dynlib <code>libmagic.so</code> takes argument p of type <code>MagicPtr</code> and a <code>cstring</code> “compatible c string” <code>s</code> and returns a <code>cint</code></p>
<p>From manpage:
&gt; The magic_load() function must be used to load the colon separated list of database files passed in as filename, or NULL for the default database
file before any magic queries can performed.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="c">#int magic_errno(magic_t);</span>
<span class="k">proc </span><span class="nf">magic_error</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">MagicPtr</span><span class="p">)</span> <span class="p">:</span> <span class="n">cstring</span>  <span class="p">{.</span><span class="n">importc</span><span class="p">,</span> <span class="n">dynlib</span><span class="p">:</span><span class="n">libName</span><span class="p">.}</span>
</pre></div></div>
<p><code>magic_errno</code> is a proc declared in dynlib <code>libmagic.so</code> and takes argument p of type <code>MagicPtr</code> and returns a <code>cstring</code></p>
<p>From manpage
&gt; The magic_error() function returns a textual explanation of the last error, or NULL if there was no error.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="c">#const char *magic_file(magic_t, const char *);</span>
<span class="k">proc </span><span class="nf">magic_file</span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="n">MagicPtr</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">cstring</span><span class="p">):</span> <span class="n">cstring</span> <span class="p">{.</span><span class="n">importc</span><span class="p">,</span> <span class="n">dynlib</span><span class="p">:</span> <span class="n">libName</span><span class="p">.}</span> 
</pre></div></div>
<p><code>magic_file</code> is proc declared in dynlib <code>libmagic.so</code> takes argument p of type <code>MagicPtr</code> and a filepath of type <code>cstring</code> and returns a <code>cstring</code></p>
<p>From manpage:
&gt; The magic_file() function returns a textual description of the contents of the filename argument, or NULL if an error occurred.<span class="intersentencespace"></span> If the filename is NULL, then stdin is used.</p>
</div>
<div id="uid41" data-tralics-id="uid41" class="subsection" data-number="3.2.5"><h3><a href="#uid41" class="heading hyperref"><span class="number">3.2.5 </span>Step 5: Friendly API</a></h3>
<p class="noindent">It’d be annoying for people to write C code and take care of pointers and such in a higher level language like nim</p>
<p>So let’s expose a proc <code>guessFile</code> takes a filepath and flags and internally use the functions we exposed through the FFI in the previous step.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">guessFile</span><span class="o">*</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="n">cint</span> <span class="o">=</span> <span class="n">MAGIC_NONE</span><span class="p">):</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">mt</span> <span class="p">:</span> <span class="n">MagicPtr</span>
    <span class="n">mt</span> <span class="o">=</span> <span class="n">magic_open</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
    <span class="k">discard</span> <span class="n">magic_load</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fileExists</span><span class="p">(</span><span class="n">expandFilename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="o">$</span><span class="n">magic_file</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">cstring</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
    <span class="n">magic_close</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
</pre></div></div>
<p>Only one note here to convert from <code>cstring</code> to <code>string</code> we use the <code>toString</code> operator <code>$</code>
</p><div class="code"><div class="highlight"><pre><span></span>        result = $magic_file(mt, cstring(filepath))
</pre></div></div>
</div></div>
<div id="cid10" data-tralics-id="cid10" class="chapter" data-number="4"><h1><a href="#cid10" class="heading hyperref"><span class="number">Chapter 4 </span>Day 4: LinksChecker</a></h1>
</div>
<div id="cid11" data-tralics-id="cid11" class="section" data-number="4.1"><h2><a href="#cid11" class="heading hyperref"><span class="number">4.1 </span>What to expect ?</a></h2>
<p class="noindent">We will be writing a simple linkschecker in both <code>sequential</code> and <code>asynchronous</code> style in nim</p>
</div>
<div id="cid12" data-tralics-id="cid12" class="section" data-number="4.2"><h2><a href="#cid12" class="heading hyperref"><span class="number">4.2 </span>Implementation</a></h2>
<div id="uid42" data-tralics-id="uid42" class="subsection" data-number="4.2.1"><h3><a href="#uid42" class="heading hyperref"><span class="number">4.2.1 </span>Step 0: Imports</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span>  <span class="n">os</span><span class="p">,</span> <span class="n">httpclient</span>
<span class="kn">import</span> <span class="n">strutils</span>
<span class="kn">import</span> <span class="n">times</span>
<span class="kn">import</span> <span class="n">asyncdispatch</span>
</pre></div></div>
</div>
<div id="uid43" data-tralics-id="uid43" class="subsection" data-number="4.2.2"><h3><a href="#uid43" class="heading hyperref"><span class="number">4.2.2 </span>Step 1: Data types</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span>
    <span class="n">LinkCheckResult</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> 
        <span class="n">link</span><span class="p">:</span> <span class="kt">string</span>
        <span class="n">state</span><span class="p">:</span> <span class="kt">bool</span>
</pre></div></div>
<p>LinkCheckResult is a simple representation for a link and its state</p>
</div>
<div id="uid44" data-tralics-id="uid44" class="subsection" data-number="4.2.3"><h3><a href="#uid44" class="heading hyperref"><span class="number">4.2.3 </span>Step 2: GO Sequential!</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">checkLink</span><span class="p">(</span><span class="n">link</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="n">LinkCheckResult</span>  <span class="o">=</span>
    <span class="kd">var</span> <span class="n">client</span> <span class="o">=</span> <span class="n">newHttpClient</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">link</span><span class="p">).</span><span class="n">code</span> <span class="o">==</span> <span class="n">Http200</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>
</pre></div></div>
<p>Here, we have a proc <code>checkLink</code> takes a link and returns <code>LinkCheckResult</code>
- <code>newHttpClient()</code> to create a new client
- <code>client.get</code> to send a get request to a link and it returns a response
- <code>response.code</code> gives us the HTTP status code, and we consider a link is valid if its status == 200
- <code>client.get</code> raises error for invalid structured links that’s why we wrapped it a <code>try/except</code> block</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">sequentialLinksChecker</span><span class="p">(</span><span class="n">links</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="kt">string</span><span class="o">]</span><span class="p">):</span> <span class="n">void</span> <span class="o">=</span> 
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">link</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s">""</span><span class="p">:</span>
            <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">checkLink</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
            <span class="n">echo</span> <span class="n">result</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="s">" is "</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">state</span>
</pre></div></div>
<p>Here, <code>sequentialLinksChecker</code> proc takes sequence of <code>links</code> and executes <code>checkLink</code> on them <code>sequentially</code></p>
<div class="code"><div class="highlight"><pre><span></span>LINKS: @["https://www.google.com.eg", "https://yahoo.com", "https://reddit.com", "https://none.nonadasdet", "https://github.com", ""]
SEQUENTIAL::
https://www.google.com.eg is true
https://yahoo.com is true
https://reddit.com is true
https://none.nonadasdet is false
https://github.com is true
7.716497898101807
</pre></div></div>
<p>On my lousy internet it took 7.7 seconds to finish :(</p>
</div>
<div id="uid45" data-tralics-id="uid45" class="subsection" data-number="4.2.4"><h3><a href="#uid45" class="heading hyperref"><span class="number">4.2.4 </span>Step 3: GO ASYNC!</a></h3>
<p class="noindent">We can do better than waiting on IO requests to finish</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">checkLinkAsync</span><span class="p">(</span><span class="n">link</span><span class="p">:</span> <span class="kt">string</span><span class="p">):</span> <span class="n">Future</span><span class="o">[</span><span class="n">LinkCheckResult</span><span class="o">]</span> <span class="p">{.</span><span class="n">async</span><span class="p">.}</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">client</span> <span class="o">=</span> <span class="n">newAsyncHttpClient</span><span class="p">()</span>

    <span class="k">let</span> <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">future</span>
    <span class="k">if</span> <span class="n">future</span><span class="p">.</span><span class="n">failed</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">let</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">future</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">resp</span><span class="p">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">Http200</span><span class="p">)</span> 
</pre></div></div>
<p>Here, we define a <code>checkLinkAsync</code> proc
- to declare a proc as async we use <code>async</code> pragma
- notice the client is of type <code>newAsyncHttpClient</code> that doesn’t block on <code>.get</code> calls
- <code>client.get</code> returns immediately a future that can either fail, and we can infer know that from <code>future.failed</code> or succeed
- <code>yield future</code> means okay i’m done for now dear <code>event loop</code> you can schedule other tasks and continue my execution when you have more update on my fancy <code>future</code>
when the eventloop comes back because the future now has some updates
- clearly, if the <code>future</code> failed we return the link with a <code>false</code> state
- otherwise, we get the <code>response</code> object that’s enclosed in the future by calling <code>read</code></p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">asyncLinksChecker</span><span class="p">(</span><span class="n">links</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="kt">string</span><span class="o">]</span><span class="p">)</span> <span class="p">{.</span><span class="n">async</span><span class="p">.}</span> <span class="o">=</span> 
    <span class="c"># client.maxRedirects = 0</span>
    <span class="kd">var</span> <span class="n">futures</span> <span class="o">=</span> <span class="n">newSeq</span><span class="o">[</span><span class="n">Future</span><span class="o">[</span><span class="n">LinkCheckResult</span><span class="o">]]</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">link</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s">""</span><span class="p">:</span>
            <span class="n">futures</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">checkLinkAsync</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
    
    <span class="c"># waitFor -&gt; call async proc from sync proc, await -&gt; call async proc from async proc</span>
    <span class="k">let</span> <span class="n">done</span> <span class="o">=</span> <span class="n">await</span> <span class="n">all</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
        <span class="n">echo</span> <span class="n">x</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="s">" is "</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">state</span>
</pre></div></div>
<p>Here, we have another async procedure <code>asyncLinksChecker</code> that will take a sequence of <code>links</code> and create futures for all of them and wait when they finish and give us some results
- <code>futures</code> is a sequence for the future results of all the <code>LinkCheckResults</code> for all the links passed to <code>asyncLinksChecker</code> proc
- we loop on the links and get <code>future</code> for the execution of <code>checkLinkAsync</code> and add it to the <code>futures</code> sequence.<span class="intersentencespace"></span> - we now ask to force to block until we get all of the results out of the futures into <code>done</code> variable
- then we print all the results
- Please notice <code>await</code> is used only to call <code>async</code> proc from another <code>async</code> proc, and <code>waitFor</code> is used to call <code>async</code> proc from <code>sync</code> proc</p>
<div class="code"><div class="highlight"><pre><span></span>ASYNC::
https://www.google.com.eg is true
https://yahoo.com is true
https://reddit.com is true
https://none.nonadasdet is false
https://github.com is true
 is false
3.601503849029541
</pre></div></div>
</div>
<div id="uid46" data-tralics-id="uid46" class="subsection" data-number="4.2.5"><h3><a href="#uid46" class="heading hyperref"><span class="number">4.2.5 </span>Step 4 simple cli</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">main</span><span class="p">()</span><span class="o">=</span>
    <span class="n">echo</span> <span class="s">"Param count: "</span><span class="p">,</span> <span class="n">paramCount</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">paramCount</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">let</span> <span class="n">linksfile</span> <span class="o">=</span> <span class="n">paramStr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="kd">var</span> <span class="n">f</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">linksfile</span><span class="p">,</span> <span class="n">fmRead</span><span class="p">)</span>
        <span class="k">let</span> <span class="n">links</span> <span class="o">=</span> <span class="n">readAll</span><span class="p">(</span><span class="n">f</span><span class="p">).</span><span class="n">splitLines</span><span class="p">()</span>
        <span class="n">echo</span> <span class="s">"LINKS: "</span> <span class="o">&amp;</span> <span class="o">$</span><span class="n">links</span>
        <span class="n">echo</span> <span class="s">"SEQUENTIAL:: "</span>
        <span class="kd">var</span> <span class="n">t</span> <span class="o">=</span> <span class="n">epochTime</span><span class="p">()</span>
        <span class="n">sequentialLinksChecker</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
        <span class="n">echo</span> <span class="n">epochTime</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>
        <span class="n">echo</span> <span class="s">"ASYNC:: "</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">epochTime</span><span class="p">()</span>
        <span class="n">waitFor</span> <span class="n">asyncLinksChecker</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
        <span class="n">echo</span> <span class="n">epochTime</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">echo</span> <span class="s">"Please provide linksfile"</span>
<span class="n">main</span><span class="p">()</span>
</pre></div></div>
<p>the only interesting part is <code>waitFor asyncLinksChecker(links)</code> as we said to call <code>async</code> proc from <code>sync</code> proc like this main proc you will need to use <code>waitFor</code></p>
</div>
<div id="uid47" data-tralics-id="uid47" class="subsection" data-number="4.2.6"><h3><a href="#uid47" class="heading hyperref"><span class="number">4.2.6 </span>Extra, threading</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">threadpool</span>
<span class="k">proc </span><span class="nf">checkLinkParallel</span><span class="p">(</span><span class="n">link</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="n">LinkCheckResult</span> <span class="p">{.</span><span class="n">thread</span><span class="p">.}</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">client</span> <span class="o">=</span> <span class="n">newHttpClient</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">link</span><span class="p">).</span><span class="n">code</span> <span class="o">==</span> <span class="n">Http200</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>
</pre></div></div>
<p>Same as before, only <code>thread</code> pragma i used to note that proc will be executed within a thread</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">threadsLinksChecker</span><span class="p">(</span><span class="n">links</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="kt">string</span><span class="o">]</span><span class="p">):</span> <span class="n">void</span> <span class="o">=</span> 
    <span class="kd">var</span> <span class="n">LinkCheckResults</span> <span class="o">=</span> <span class="n">newSeq</span><span class="o">[</span><span class="n">FlowVar</span><span class="o">[</span><span class="n">LinkCheckResult</span><span class="o">]]</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
        <span class="n">LinkCheckResults</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">spawn</span> <span class="n">checkLinkParallel</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>  
    
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">LinkCheckResults</span><span class="p">:</span>
        <span class="k">let</span> <span class="n">res</span> <span class="o">=</span> <span class="p">^</span><span class="n">x</span>
        <span class="n">echo</span> <span class="n">res</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="s">" is "</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">state</span>
</pre></div></div>
<p>- spawned <code>tasks</code> or <code>threads</code> returns a value of type <code>FlowVar[T]</code>, where <code>T</code> is the return value of the spawned <code>proc</code>
- To get the value of a <code>FlowVar</code> we use <code></code> operator.</p>
<blockquote class="quotation"><p class="quote">Note: you should use <code>nim.cfg</code> with flags <code>-d:ssl</code> to allow working with https</p>
</blockquote></div></div>
<div id="cid13" data-tralics-id="cid13" class="chapter" data-number="5"><h1><a href="#cid13" class="heading hyperref"><span class="number">Chapter 5 </span>Day 5: Creating INI Parser</a></h1>
<p class="noindent">this is a pure <a href="https://en.wikipedia.org/wiki/Ini_file" target="_blank" rel="noopener">Ini</a> parser for nim</p>
<blockquote class="quotation"><p class="quote">Nim has advanced <a href="https://nim-lang.org/docs/parsecfg.html" target="_blank" rel="noopener">parsecfg</a></p>
</blockquote></div>
<div id="cid14" data-tralics-id="cid14" class="section" data-number="5.1"><h2><a href="#cid14" class="heading hyperref"><span class="number">5.1 </span>What to expect ?</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">sample1</span> <span class="o">=</span> <span class="s">"""</span>

<span class="s">[general]</span>
<span class="s">appname = configparser</span>
<span class="s">version = 0.1</span>

<span class="s">[author]</span>
<span class="s">name = xmonader</span>
<span class="s">email = notxmonader@gmail.com</span>


<span class="s">"""</span>

<span class="kd">var</span> <span class="n">d</span> <span class="o">=</span> <span class="n">parseIni</span><span class="p">(</span><span class="n">sample1</span><span class="p">)</span>

<span class="c"># doAssert(d.sectionsCount() == 2)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">"general"</span><span class="p">,</span> <span class="s">"appname"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"configparser"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">"general"</span><span class="p">,</span><span class="s">"version"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"0.1"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span><span class="s">"name"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"xmonader"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span><span class="s">"email"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"notxmonader@gmail.com"</span><span class="p">)</span>

<span class="n">d</span><span class="p">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span> <span class="s">"email"</span><span class="p">,</span> <span class="s">"alsonotxmonader@gmail.com"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span><span class="s">"email"</span><span class="p">)</span> <span class="o">==</span> <span class="s">"alsonotxmonader@gmail.com"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">hasSection</span><span class="p">(</span><span class="s">"general"</span><span class="p">)</span> <span class="o">==</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">hasSection</span><span class="p">(</span><span class="s">"author"</span><span class="p">)</span> <span class="o">==</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">hasProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span> <span class="s">"name"</span><span class="p">)</span> <span class="o">==</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">d</span><span class="p">.</span><span class="n">deleteProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span> <span class="s">"name"</span><span class="p">)</span>
<span class="n">doAssert</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">hasProperty</span><span class="p">(</span><span class="s">"author"</span><span class="p">,</span> <span class="s">"name"</span><span class="p">)</span> <span class="o">==</span> <span class="kp">false</span><span class="p">)</span>

<span class="n">echo</span> <span class="n">d</span><span class="p">.</span><span class="n">toIniString</span><span class="p">()</span>
<span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">getSection</span><span class="p">(</span><span class="s">"author"</span><span class="p">)</span>
<span class="n">echo</span> <span class="o">$</span><span class="n">s</span>
</pre></div></div>
</div>
<div id="cid15" data-tralics-id="cid15" class="section" data-number="5.2"><h2><a href="#cid15" class="heading hyperref"><span class="number">5.2 </span>Implementation</a></h2>
<p class="noindent">You can certainly use regular expressions, like pythons configparser, but we will go for a simpler approach here, also we want to keep it pure so we don’t depend on <code>pcre</code></p>
<div id="uid48" data-tralics-id="uid48" class="subsection" data-number="5.2.1"><h3><a href="#uid48" class="heading hyperref"><span class="number">5.2.1 </span>Ini sample</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">[general]</span>
<span class="na">appname</span> <span class="o">=</span> <span class="s">configparser</span>
<span class="na">version</span> <span class="o">=</span> <span class="s">0.1</span>

<span class="k">[author]</span>
<span class="na">name</span> <span class="o">=</span> <span class="s">xmonader</span>
<span class="na">email</span> <span class="o">=</span> <span class="s">notxmonader@gmail.com</span>
</pre></div></div>
<p>Ini file consists of one or more sections and each section consists of one or more key value pairs separated by <code>=</code></p>
</div>
<div id="uid49" data-tralics-id="uid49" class="subsection" data-number="5.2.2"><h3><a href="#uid49" class="heading hyperref"><span class="number">5.2.2 </span>Define your data types</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">tables</span><span class="p">,</span> <span class="n">strutils</span>
</pre></div></div>
<p>We will use tables extensively
</p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">Section</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">Table</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="o">]</span>
</pre></div></div>
<p><code>Section</code> type contains <code>properties</code> table represents key value pairs</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">setProperty</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Section</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">this</span><span class="p">.</span><span class="n">properties</span><span class="o">[</span><span class="n">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
</pre></div></div>
<p>To set property in the underlying <code>properties</code> table</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">newSection</span><span class="o">*</span><span class="p">()</span> <span class="p">:</span> <span class="n">Section</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">s</span> <span class="o">=</span> <span class="n">Section</span><span class="p">()</span>
    <span class="n">s</span><span class="p">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">initTable</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="o">]</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">s</span>
</pre></div></div>
<p>To create new Section object</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">`$`</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Section</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="k">return</span> <span class="s">"&lt;Section"</span> <span class="o">&amp;</span> <span class="o">$</span><span class="n">this</span><span class="p">.</span><span class="n">properties</span> <span class="o">&amp;</span> <span class="s">" &gt;"</span>
</pre></div></div>
<p>Simple <code>toString</code> proc using <code>$</code> operator
</p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">Ini</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span>
    <span class="n">sections</span><span class="p">:</span> <span class="n">Table</span><span class="o">[</span><span class="kt">string</span><span class="p">,</span> <span class="n">Section</span><span class="o">]</span>
</pre></div></div>
<p><code>Ini</code> type represents the whole document and contains a table <code>section</code> from <code>sectionName</code> to <code>Section</code> object.</p>
<div class="code"><div class="highlight"><pre><span></span>proc newIni*() : Ini = 
    var ini = Ini()
    ini.sections = initTable[string, Section]()
    return ini
</pre></div></div>
<p>To create new Ini object
</p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">`$`</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> 
    <span class="k">return</span> <span class="s">"&lt;Ini "</span> <span class="o">&amp;</span> <span class="o">$</span><span class="n">this</span><span class="p">.</span><span class="n">sections</span> <span class="o">&amp;</span> <span class="s">" &gt;"</span>
</pre></div></div>
<p>define friendly <code>toString</code> proc using <code>$</code> operator</p>
</div>
<div id="uid50" data-tralics-id="uid50" class="subsection" data-number="5.2.3"><h3><a href="#uid50" class="heading hyperref"><span class="number">5.2.3 </span>Define API</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span>proc setSection*(this: Ini, name: string, section: Section) =
    this.sections[name] = section

proc getSection*(this: Ini, name: string): Section =
    return this.sections.getOrDefault(name)

proc hasSection*(this: Ini, name: string): bool =
    return this.sections.contains(name)

proc deleteSection*(this: Ini, name:string) =
    this.sections.del(name)

proc sectionsCount*(this: Ini) : int = 
    echo $this.sections
    return len(this.sections)
</pre></div></div>
<p>Some helper procs around Ini objects for manipulating sections.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">hasProperty</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="kt">string</span><span class="p">):</span> <span class="kt">bool</span><span class="o">=</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sectionName</span><span class="p">)</span> <span class="ow">and</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="o">[</span><span class="n">sectionName</span><span class="o">]</span><span class="p">.</span><span class="n">properties</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">proc </span><span class="nf">setProperty</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span><span class="kt">string</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">echo</span> <span class="o">$</span><span class="n">this</span><span class="p">.</span><span class="n">sections</span>
    <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sectionName</span><span class="p">):</span>
        <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="o">[</span><span class="n">sectionName</span><span class="o">]</span><span class="p">.</span><span class="n">setProperty</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">newException</span><span class="p">(</span><span class="n">ValueError</span><span class="p">,</span> <span class="s">"Ini doesn't have section "</span> <span class="o">&amp;</span> <span class="n">sectionName</span><span class="p">)</span>

<span class="k">proc </span><span class="nf">getProperty</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sectionName</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="o">[</span><span class="n">sectionName</span><span class="o">]</span><span class="p">.</span><span class="n">properties</span><span class="p">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">newException</span><span class="p">(</span><span class="n">ValueError</span><span class="p">,</span> <span class="s">"Ini doesn't have section "</span> <span class="o">&amp;</span> <span class="n">sectionName</span><span class="p">)</span>


<span class="k">proc </span><span class="nf">deleteProperty</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">,</span> <span class="n">sectionName</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sectionName</span><span class="p">)</span> <span class="ow">and</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="o">[</span><span class="n">sectionName</span><span class="o">]</span><span class="p">.</span><span class="n">properties</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="o">[</span><span class="n">sectionName</span><span class="o">]</span><span class="p">.</span><span class="n">properties</span><span class="p">.</span><span class="n">del</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">newException</span><span class="p">(</span><span class="n">ValueError</span><span class="p">,</span> <span class="s">"Ini doesn't have section "</span> <span class="o">&amp;</span> <span class="n">sectionName</span><span class="p">)</span>
</pre></div></div>
<p>More helpers around properties in the section objects managed by <code>Ini</code> object</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">toIniString</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Ini</span><span class="p">,</span> <span class="n">sep</span><span class="p">:</span><span class="kt">char</span><span class="o">=</span><span class="sc">'='</span><span class="p">)</span> <span class="p">:</span> <span class="kt">string</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">output</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">sectName</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">this</span><span class="p">.</span><span class="n">sections</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">&amp;=</span> <span class="s">"["</span> <span class="o">&amp;</span> <span class="n">sectName</span> <span class="o">&amp;</span> <span class="s">"]"</span> <span class="o">&amp;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">section</span><span class="p">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">&amp;=</span> <span class="n">k</span> <span class="o">&amp;</span> <span class="n">sep</span> <span class="o">&amp;</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span> 
        <span class="n">output</span> <span class="o">&amp;=</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
    <span class="k">return</span> <span class="n">output</span>
</pre></div></div>
<p>Simple proc <code>toIniString</code> to convert the nim structures into Ini text string</p>
</div>
<div id="uid51" data-tralics-id="uid51" class="subsection" data-number="5.2.4"><h3><a href="#uid51" class="heading hyperref"><span class="number">5.2.4 </span>Parse!</a></h3>
<p class="noindent">OK, here comes the cool part</p>
<div id="uid52" data-tralics-id="uid52" class="subsubsection" data-number="5.2.4.1"><h4><a href="#uid52" class="heading">Parser states</a></h4>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="n">ParserState</span> <span class="o">=</span> <span class="k">enum</span>
    <span class="n">readSection</span><span class="p">,</span> <span class="n">readKV</span>
</pre></div></div>
<p>Here we have two states
- readSection: when we are supposed to extract section name from the current line
- readKV: when we are supposed to read the line in key value pair mode</p>
</div>
<div id="uid53" data-tralics-id="uid53" class="subsubsection" data-number="5.2.4.2"><h4><a href="#uid53" class="heading">ParseIni proc</a></h4>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">parseIni</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="n">Ini</span> <span class="o">=</span> 
</pre></div></div>
<p>Here we define a proc <code>parseIni</code> that takes a string <code>s</code> and creates an <code>Ini</code> object</p>
<div class="code"><div class="highlight"><pre><span></span>    <span class="kd">var</span> <span class="n">ini</span> <span class="o">=</span> <span class="n">newIni</span><span class="p">()</span>
    <span class="kd">var</span> <span class="n">state</span><span class="p">:</span> <span class="n">ParserState</span> <span class="o">=</span> <span class="n">readSection</span>
    <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">splitLines</span>
    
    <span class="kd">var</span> <span class="n">currentSectionName</span><span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="s">""</span>
    <span class="kd">var</span> <span class="n">currentSection</span> <span class="o">=</span> <span class="n">newSection</span><span class="p">()</span>
</pre></div></div>
<ul>
<li><code>ini</code> is the object to be returned after parsing
</li>
<li><code>state</code> the current parser state (weather it’s <code>readSection</code> or <code>readKV</code>)
</li>
<li><code>lines</code> input string splitted into lines <code>as we are a lines based parser</code>
</li>
<li><code>currentSectionName</code> to keep track of what section we are currently in
</li>
<li><code>currentSection</code> to populate <code>ini.sections</code> with <code>Section</code> object using <code>setSection</code> proc
</li></ul>
<div class="code"><div class="highlight"><pre><span></span>   <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</pre></div></div>
<p>for each line
</p><div class="code"><div class="highlight"><pre><span></span>         <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">""</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">";"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">"#"</span><span class="p">):</span>
            <span class="k">continue</span>
</pre></div></div>
<p>We continue if line is safe to igore <code>empty line</code> or starts with <code>;</code> or <code>#</code></p>
<div class="code"><div class="highlight"><pre><span></span>        <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">"["</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line</span><span class="p">.</span><span class="n">endsWith</span><span class="p">(</span><span class="s">"]"</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">readSection</span>
</pre></div></div>
<p>if line startswith <code>[</code> and ends with <code>]</code> then we set parser state to <code>readSection</code></p>
<div class="code"><div class="highlight"><pre><span></span>        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">readSection</span><span class="p">:</span>
            <span class="n">currentSectionName</span> <span class="o">=</span> <span class="n">line</span><span class="o">[</span><span class="mf">1</span><span class="p">..</span><span class="o">&lt;</span><span class="n">line</span><span class="p">.</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
            <span class="n">ini</span><span class="p">.</span><span class="n">setSection</span><span class="p">(</span><span class="n">currentSectionName</span><span class="p">,</span> <span class="n">currentSection</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">readKV</span>
            <span class="k">continue</span>
</pre></div></div>
<p>if parser <code>state</code> is <code>readSection</code>
- extract section name <code>between [ and ]</code>
- add section object to the ini under the current section name
- change <code>state</code> to <code>readKV</code> to read key value pairs
- continue the loop on the nextline as we’re done processing the section name.</p>
<div class="code"><div class="highlight"><pre><span></span>        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">readKV</span><span class="p">:</span>
            <span class="k">let</span> <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">({</span><span class="sc">'='</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">let</span> <span class="n">key</span> <span class="o">=</span> <span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">let</span> <span class="n">val</span> <span class="o">=</span> <span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">ini</span><span class="p">.</span><span class="n">setProperty</span><span class="p">(</span><span class="n">currentSectionName</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</pre></div></div>
<p>if <code>state</code> is <code>readKV</code>
- extract <code>key</code> and <code>val</code> by splitting the line on <code>=</code>
- <code>setProperty</code> under the <code>currentSectionName</code> using <code>key</code> and <code>val</code>
</p><div class="code"><div class="highlight"><pre><span></span>    <span class="k">return</span> <span class="n">ini</span>
</pre></div></div>
<p>Here we return the populated <code>ini</code> object.</p>
</div></div></div>
<div id="cid16" data-tralics-id="cid16" class="chapter" data-number="6"><h1><a href="#cid16" class="heading hyperref"><span class="number">Chapter 6 </span>Day 6: Manage your dotfiles easily with nistow</a></h1>
<p class="noindent">Today we will create a tool to manage our dotfiles easily.</p>
</div>
<div id="cid17" data-tralics-id="cid17" class="section" data-number="6.1"><h2><a href="#cid17" class="heading hyperref"><span class="number">6.1 </span>Dotfiles layout</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span>        i3
        `-- .config
            `-- i3
                `-- config
</pre></div></div>
<p>So we have here a directory named i3 in the very top <code>indicates APP_NAME</code> and under it a tree of config paths.<span class="intersentencespace"></span> Here it means <code>config</code> file is supposed to be linked under <code>.config/i3/config</code> relative to <code>destination directory</code>
&gt; Home directory is the default destination.</p>
</div>
<div id="cid18" data-tralics-id="cid18" class="section" data-number="6.2"><h2><a href="#cid18" class="heading hyperref"><span class="number">6.2 </span>What do we expect?</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span>➜  ~ nistow --help
    Stow 0.1.0
        -h | --help     : show help
        -v | --version  : show version
        --verbose       : verbose messages
        -s | --simulate : simulate stow operation
        -f | --force    : override old links
        -a | --app      : application path to stow
        -d | --dest     : destination to stow to
</pre></div></div>
<p>- <code>–simulate</code> flag used to simulate on the filesystem without actual linking
- <code>–app</code> application directory that’s compatible with the dotfiles layoud described above.<span class="intersentencespace"></span> - <code>–dest</code> destination to symlink files under, defaults to home dir.</p>
<div class="code"><div class="highlight"><pre><span></span>nistow --app=/home/striky/wspace/dotfiles/localdir --dest=/tmp/tmpconf --verbose
</pre></div></div>
</div>
<div id="cid19" data-tralics-id="cid19" class="section" data-number="6.3"><h2><a href="#cid19" class="heading hyperref"><span class="number">6.3 </span>Implementation</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">writeHelp</span><span class="p">()</span> <span class="o">=</span> 
    <span class="n">echo</span> <span class="s">"""</span>
<span class="s">Stow 0.1.0 (Manage your dotfiles easily)</span>

<span class="s">Allowed arguments:</span>
<span class="s">    -h | --help     : show help</span>
<span class="s">    -v | --version  : show version</span>
<span class="s">    --verbose       : verbose messages</span>
<span class="s">    -s | --simulate : simulate stow operation</span>
<span class="s">    -f | --force    : override old links</span>
<span class="s">    -a | --app      : application path to stow</span>
<span class="s">    -d | --dest     : destination to stow to</span>

<span class="s">    """</span>
</pre></div></div>
<p><code>writeHelp</code> is a simple proc to write help string to the stdout</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">writeVersion</span><span class="p">()</span> <span class="o">=</span>
    <span class="n">echo</span> <span class="s">"Stow version 0.1.0"</span>
</pre></div></div>
<p>To write version</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">cli</span><span class="o">*</span><span class="p">()</span> <span class="o">=</span>
</pre></div></div>
<p>Entry point for out commandline application</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="kd">var</span> 
    <span class="n">simulate</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="kp">false</span>
    <span class="n">app</span><span class="p">,</span> <span class="n">dest</span><span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="s">""</span>
</pre></div></div>
<p>Variables represents various options we allow in the application.</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="k">if</span> <span class="n">paramCount</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">writeHelp</span><span class="p">()</span>
    <span class="n">quit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div></div>
<p>If no arguments passed we will write the help string and <code>exit</code> or <code>quit</code> according to nim with <code>exit status</code> 0</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="k">for</span> <span class="n">kind</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">getopt</span><span class="p">():</span>
    <span class="k">case</span> <span class="n">kind</span>
    <span class="k">of</span> <span class="n">cmdLongOption</span><span class="p">,</span> <span class="n">cmdShortOption</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">key</span>
        <span class="k">of</span> <span class="s">"help"</span><span class="p">,</span> <span class="s">"h"</span><span class="p">:</span> 
            <span class="n">writeHelp</span><span class="p">()</span>
            <span class="n">quit</span><span class="p">()</span>
        <span class="k">of</span> <span class="s">"version"</span><span class="p">,</span> <span class="s">"v"</span><span class="p">:</span>
            <span class="n">writeVersion</span><span class="p">()</span>
            <span class="n">quit</span><span class="p">()</span>
        <span class="k">of</span> <span class="s">"simulate"</span><span class="p">,</span> <span class="s">"s"</span><span class="p">:</span> <span class="n">simulate</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="k">of</span> <span class="s">"verbose"</span><span class="p">:</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="k">of</span> <span class="s">"force"</span><span class="p">,</span> <span class="s">"f"</span><span class="p">:</span> <span class="n">force</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="k">of</span> <span class="s">"app"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">:</span> <span class="n">app</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">of</span> <span class="s">"dest"</span><span class="p">,</span> <span class="s">"d"</span><span class="p">:</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">val</span> 
        <span class="k">else</span><span class="p">:</span>
          <span class="k">discard</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">discard</span> 
</pre></div></div>
<p>Here we parse the commandline string using <code>getopt</code>.<span class="intersentencespace"></span> </p><div class="code"><div class="highlight"><pre><span></span>  <span class="k">for</span> <span class="n">kind</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">getopt</span><span class="p">():</span>
    <span class="k">case</span> <span class="n">kind</span>
    <span class="k">of</span> <span class="n">cmdLongOption</span><span class="p">,</span> <span class="n">cmdShortOption</span><span class="p">:</span>
</pre></div></div>
<p>So for <code>–app=/home/striky/dotfiles/i3 -f</code>
kind for <code>–app</code> is <code>cmdLongOption</code> and for <code>-f</code> is <code>cmdShortOption</code>
key for <code>–app</code> is <code>app</code> and for <code>-f</code> is <code>f</code>
val for <code>–app</code> is <code>/home/striky/dotfiles/i3</code>
val for <code>-f</code> we set to <code>true</code> in our parsing, because it’s mainly like a switch <code>boolean</code> if it exists it means we want it set to true.</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="k">if</span> <span class="n">dest</span><span class="p">.</span><span class="n">isNilOrEmpty</span><span class="p">():</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">getHomeDir</span><span class="p">()</span>
</pre></div></div>
<p>Here we set default <code>dest</code> to homeDir
</p><div class="code"><div class="highlight"><pre><span></span>  <span class="k">if</span> <span class="n">app</span><span class="p">.</span><span class="n">isNilOrEmpty</span><span class="p">():</span>
    <span class="n">echo</span> <span class="s">"Make sure to provide --app flags"</span>
    <span class="n">quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div></div>
<p>Here we exit with error <code>exit status</code> 1 if app isn’t set.</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="k">try</span><span class="p">:</span>
    <span class="n">stow</span><span class="p">(</span><span class="n">getLinkableFiles</span><span class="p">(</span><span class="n">appPath</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">dest</span><span class="p">),</span> <span class="n">simulate</span><span class="o">=</span><span class="n">simulate</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
  <span class="k">except</span> <span class="n">ValueError</span><span class="p">:</span>
    <span class="n">echo</span> <span class="s">"Error happened: "</span> <span class="o">&amp;</span> <span class="n">getCurrentExceptionMsg</span><span class="p">()</span>
</pre></div></div>
<p>Here we try to stow all the linkable files in <code>app</code> dir to <code>dest</code> dir and pass all the options we collected from the command line arguments <code>simulate</code>, <code>verbose</code>, <code>force</code>, and wrapped around <code>try/except</code> to show error to the user</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">when</span> <span class="n">isMainModule</span><span class="p">:</span>
  <span class="n">cli</span><span class="p">()</span>
</pre></div></div>
<p>invoke our entry point <code>cli</code> if this module is the main module.</p>
<p>OK! back to stow and getLinkableFiles</p>
<p>We start with <code>getLinkableFiles</code>.<span class="intersentencespace"></span> Remember the dotfiles hierarchy?<span class="intersentencespace"></span> </p><div class="code"><div class="highlight"><pre><span></span>    # appPath: application's dotfiles directory
    #     we expect dir to have the hierarchy.
    #     i3
    #     `-- .config
    #         `-- i3
    #         `-- config
</pre></div></div>
<p>We want to get all the files in there with full path and the link file to each one will be exactly the same except for the <code>appPath</code> name will be changed to <code>dest</code> path</p>
<div class="code"><div class="highlight"><pre><span></span>[/home/striky/wspace/dotfiles/i3]/.config/i3/config -&gt; [/home/striky]/.config/i3/config
__________________appPath________                      _____dest____
</pre></div></div>
<div class="code"><div class="highlight"><pre><span></span><span class="k">type</span>
  <span class="n">LinkInfo</span> <span class="o">=</span> <span class="k">tuple</span><span class="o">[</span><span class="n">original</span><span class="p">:</span><span class="kt">string</span><span class="p">,</span> <span class="n">dest</span><span class="p">:</span><span class="kt">string</span><span class="o">]</span> 
</pre></div></div>
<p>Simple type to represent the original path and where to symlink to</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">getLinkableFiles</span><span class="o">*</span><span class="p">(</span><span class="n">appPath</span><span class="p">:</span> <span class="kt">string</span><span class="p">,</span> <span class="n">dest</span><span class="p">:</span> <span class="kt">string</span><span class="o">=</span><span class="n">expandTilde</span><span class="p">(</span><span class="s">"~"</span><span class="p">)):</span> <span class="kt">seq</span><span class="o">[</span><span class="n">LinkInfo</span><span class="o">]</span> <span class="o">=</span>

    <span class="c"># collects the linkable files in a certain app.</span>

    <span class="c"># appPath: application's dotfiles directory</span>
    <span class="c">#     we expect dir to have the hierarchy.</span>
    <span class="c">#     i3</span>
    <span class="c">#     `-- .config</span>
    <span class="c">#         `-- i3</span>
    <span class="c">#         `-- config</span>

    <span class="c"># dest: destination of the link files : default is the home of user.</span>
</pre></div></div>
<p><code>getLinkableFiles</code> is a proc takes <code>appPath</code> and <code>dest</code> and returns a <code>seq</code> of LinkInfo contains this transformation for each file.</p>
<div class="code"><div class="highlight"><pre><span></span>[/home/striky/wspace/dotfiles/i3]/A_FILE_PATH -&gt; [/home/striky]A_FILE_PATH
__________________apppath________                _____dest____
</pre></div></div>
<div class="code"><div class="highlight"><pre><span></span>  <span class="kd">var</span> <span class="n">appPath</span> <span class="o">=</span> <span class="n">expandTilde</span><span class="p">(</span><span class="n">appPath</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">dirExists</span><span class="p">(</span><span class="n">appPath</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">newException</span><span class="p">(</span><span class="n">ValueError</span><span class="p">,</span> <span class="n">fmt</span><span class="p">(</span><span class="s">"App path {appPath} doesn't exist."</span><span class="p">))</span>
  <span class="kd">var</span> <span class="n">linkables</span> <span class="o">=</span> <span class="n">newSeq</span><span class="o">[</span><span class="n">LinkInfo</span><span class="o">]</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">walkDirRec</span><span class="p">(</span><span class="n">appPath</span><span class="p">,</span> <span class="n">yieldFilter</span><span class="o">=</span><span class="p">{</span><span class="n">pcFile</span><span class="p">}):</span>
    <span class="k">let</span> <span class="n">linkpath</span> <span class="o">=</span> <span class="n">filepath</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">appPath</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
    <span class="kd">var</span> <span class="n">linkInfo</span> <span class="p">:</span> <span class="n">LinkInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">original</span><span class="p">:</span><span class="n">filepath</span><span class="p">,</span> <span class="n">dest</span><span class="p">:</span><span class="n">linkpath</span><span class="p">)</span>
    <span class="n">linkables</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">linkInfo</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">linkables</span>
</pre></div></div>
<p>Here, we walk over the <code>appPath</code> dir using <code>walkDirRec</code> and specify in <code>yieldFilter</code> argument that we’re interested in <code>pcFile</code> “file path component”, just call it entries of type regular file.</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">stow</span><span class="p">(</span><span class="n">linkables</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="n">LinkInfo</span><span class="o">]</span><span class="p">,</span> <span class="n">simulate</span><span class="p">:</span> <span class="kt">bool</span><span class="o">=</span><span class="kp">true</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="kt">bool</span><span class="o">=</span><span class="kp">true</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="kt">bool</span><span class="o">=</span><span class="kp">false</span><span class="p">)</span> <span class="o">=</span> 
    <span class="c"># Creates symoblic links and related directories</span>

    <span class="c"># linkables is a list of tuples (filepath, linkpath) : List[Tuple[file_path, link_path]]</span>
    <span class="c"># simulate does simulation with no effect on the filesystem: bool</span>
    <span class="c"># verbose shows log messages: bool</span>

  <span class="k">for</span> <span class="n">linkinfo</span> <span class="ow">in</span> <span class="n">linkables</span><span class="p">:</span>
    <span class="k">let</span> <span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">linkpath</span><span class="p">)</span> <span class="o">=</span> <span class="n">linkinfo</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
      <span class="n">echo</span><span class="p">(</span><span class="n">fmt</span><span class="p">(</span><span class="s">"Will link {filepath} -&gt; {linkpath}"</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">simulate</span><span class="p">:</span>
      <span class="n">createDir</span><span class="p">(</span><span class="n">parentDir</span><span class="p">(</span><span class="n">linkpath</span><span class="p">))</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">fileExists</span><span class="p">(</span><span class="n">linkpath</span><span class="p">):</span>
        <span class="n">createSymlink</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">linkpath</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
          <span class="n">removeFile</span><span class="p">(</span><span class="n">linkpath</span><span class="p">)</span>
          <span class="n">createSymlink</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">linkpath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">echo</span><span class="p">(</span><span class="n">fmt</span><span class="p">(</span><span class="s">"Skipping linking {filepath} -&gt; {linkpath}"</span><span class="p">))</span>
</pre></div></div>
<p>Stow is pretty easy procedure, it takes in a list of <code>LinksInfo</code> that has all the information (original filename and destination symlink) and does the symlinking based on if it’s not a simulation and prints the messages if verbose is set to true</p>
<p>Feel free to send improvements to this tutorial or nistow :)</p>
</div>
<div id="cid20" data-tralics-id="cid20" class="chapter" data-number="7"><h1><a href="#cid20" class="heading hyperref"><span class="number">Chapter 7 </span>Day 7: Shorturl service</a></h1>
<p class="noindent">Today, we will develop a url shortening service like <code>bit.ly</code> or something</p>
</div>
<div id="cid21" data-tralics-id="cid21" class="section" data-number="7.1"><h2><a href="#cid21" class="heading hyperref"><span class="number">7.1 </span>imports</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">jester</span><span class="p">,</span> <span class="n">asyncdispatch</span><span class="p">,</span> <span class="n">htmlgen</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">strutils</span><span class="p">,</span> <span class="n">strformat</span><span class="p">,</span> <span class="n">db_sqlite</span>
</pre></div></div>
<ul>
<li>jester: is sinatra like framework
</li>
<li>asyncdispatch: for async/await instructions
</li>
<li>htmlgen: to generate html pages
</li>
<li>json: to parse json string into nim structures and dump json structures to strings
</li>
<li>db_sqlite: to work on sqlite databse behind our application
</li></ul>
</div>
<div id="cid22" data-tralics-id="cid22" class="section" data-number="7.2"><h2><a href="#cid22" class="heading hyperref"><span class="number">7.2 </span>Database connection</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="c"># hostname can be something configurable "http://ni.m:5000"</span>
<span class="k">let</span> <span class="n">hostname</span> <span class="o">=</span> <span class="s">"localhost:5000"</span>
<span class="kd">var</span> <span class="n">theDb</span> <span class="p">:</span> <span class="n">DbConn</span>
</pre></div></div>
<ul>
<li><code>hostname</code> is the basepath for our site to access it, and can be configurable using <code>/etc/hosts</code> file or using even <code>reverse proxy</code> like <code>caddy</code>, or in real world case you will have a dns record for your site.<span class="intersentencespace"></span>
</li>
<li><code>theDb</code> is the connection object to work with <code>sqlite</code> database.<span class="intersentencespace"></span>
</li></ul>
<div class="code"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">fileExists</span><span class="p">(</span><span class="s">"/tmp/mytest.db"</span><span class="p">):</span>
  <span class="n">theDb</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/tmp/mytest.db"</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="n">theDb</span><span class="p">.</span><span class="n">exec</span><span class="p">(</span><span class="n">sql</span><span class="p">(</span><span class="s">"""create table urls (</span>
<span class="s">      id   INTEGER PRIMARY KEY,</span>
<span class="s">      url  VARCHAR(255) NOT NULL</span>
<span class="s">     )"""</span>
  <span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">theDb</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/tmp/mytest.db"</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
</pre></div></div>
<ul>
<li>We check if the database file doesn’t exist <code>/tmp/mytest.db</code> we create a <code>urls</code> table otherwise we just get the connection and do nothing
</li></ul>
</div>
<div id="cid23" data-tralics-id="cid23" class="section" data-number="7.3"><h2><a href="#cid23" class="heading hyperref"><span class="number">7.3 </span>Jester and http endpoints</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="n">routes</span><span class="p">:</span>
</pre></div></div>
<ul>
<li>jester defines a DSL to work on routes
</li></ul>
<div class="code"><div class="highlight"><pre><span></span><span class="k">METHOD</span> <span class="n">ROUTE_PATH</span><span class="p">:</span>
    <span class="sd">##codeblock</span>
</pre></div></div>
<ul>
<li>METHOD can be <code>get</code> <code>post</code> or any <code>http</code> verb
</li>
<li>ROUTE_PATH is the path accessed on the server for instance <code>/users</code>, <code>/user/52</code>, here <code>52</code> is a query parameter when route is defined like this<code>/user/@id</code>
</li></ul>
<div id="uid70" data-tralics-id="uid70" class="subsection" data-number="7.3.1"><h3><a href="#uid70" class="heading hyperref"><span class="number">7.3.1 </span>HOME page</a></h3>
<p class="noindent">Here we handle <code>GET</code> requests on <code>/home</code> path on our server:
</p><div class="code"><div class="highlight"><pre><span></span> <span class="n">get</span> <span class="s">"/home"</span><span class="p">:</span>
  <span class="kd">var</span> <span class="n">htmlout</span> <span class="o">=</span> <span class="s">"""</span>
<span class="s">    &lt;html&gt;</span>
<span class="s">      &lt;title&gt;NIM SHORT&lt;/title&gt;</span>
<span class="s">      &lt;head&gt;</span>
<span class="s">        &lt;script</span>
<span class="s">      src="https://code.jquery.com/jquery-3.3.1.min.js"</span>
<span class="s">      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="</span>
<span class="s">      crossorigin="anonymous"&gt;&lt;/script&gt;</span>

<span class="s">      &lt;script&gt;</span>
<span class="s">        function postData(url, data) {</span>
<span class="s">          // Default options are marked with *</span>
<span class="s">          return fetch(url, {</span>
<span class="s">            body: JSON.stringify(data), // must match 'Content-Type' header</span>
<span class="s">            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached</span>
<span class="s">            credentials: 'same-origin', // include, same-origin, *omit</span>
<span class="s">            headers: {</span>
<span class="s">              'user-agent': 'Mozilla/4.0 MDN Example',</span>
<span class="s">              'content-type': 'application/json'</span>
<span class="s">            },</span>
<span class="s">            method: 'POST', // *GET, POST, PUT, DELETE, etc.</span>
<span class="s">            mode: 'cors', // no-cors, cors, *same-origin</span>
<span class="s">            redirect: 'follow', // manual, *follow, error</span>
<span class="s">            referrer: 'no-referrer', // *client, no-referrer</span>
<span class="s">          })</span>
<span class="s">          .then(resp =&gt; resp.json())</span>
<span class="s">      }</span>

<span class="s">      $(document).ready(function() {</span>
<span class="s">        $('#btnsubmit').on('click', function(e){</span>
<span class="s">          e.preventDefault();</span>
<span class="s">          postData('/shorten', {url: $("#url").val()})</span>
<span class="s">          .then( data =&gt; {</span>
<span class="s">            let id = data["id"]</span>
<span class="s">            $("#output").html(`&lt;a href="%%hostname/${id}"&gt;Shortlink: ${id}&lt;/a&gt;`);</span>
<span class="s">           });</span>
<span class="s">      });</span>
<span class="s">    });</span>
<span class="s">      &lt;/script&gt;</span>
<span class="s">      &lt;/head&gt;</span>
<span class="s">      &lt;body&gt;</span>
<span class="s">          &lt;div&gt;</span>
<span class="s">            &lt;form&gt;</span>
<span class="s">              &lt;label&gt;URL&lt;/label&gt;</span>
<span class="s">              &lt;input type="url" name="url" id="url" /&gt;</span>
<span class="s">              &lt;button id="btnsubmit" type="button"&gt;SHORT!&lt;/button</span>
<span class="s">            &lt;/form&gt;</span>
<span class="s">          &lt;/div&gt;</span>

<span class="s">          &lt;div id="output"&gt;</span>

<span class="s">          &lt;/div&gt;</span>
<span class="s">      &lt;/body&gt;</span>
<span class="s">    &lt;/html&gt;</span>
<span class="s">    """</span>
    <span class="n">htmlout</span> <span class="o">=</span> <span class="n">htmlout</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"%%hostname"</span><span class="p">,</span> <span class="n">hostname</span><span class="p">)</span>
    <span class="n">resp</span>  <span class="n">htmlout</span>
</pre></div></div>
<ul>
<li>Include jquery framework
</li>
<li>Create a form with in <code>div tag with 1 textinput to allow user to enter a url</code>
</li>
<li>override form submission to do an ajax request
</li>
<li>on the button shorturl click event we send a post request to <code>/shorten</code> endpoint in the background using <code>fetch</code> api and whenever we get a result we parse the json data and extract the <code>id</code> from it and put the new url in the <code>output</code> div
</li>
<li><code>resp</code> to return a response to the user and it can return a <code>http status</code> too
</li></ul>
</div>
<div id="uid76" data-tralics-id="uid76" class="subsection" data-number="7.3.2"><h3><a href="#uid76" class="heading hyperref"><span class="number">7.3.2 </span>Shorten endpoint</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span>  <span class="n">post</span> <span class="s">"/shorten"</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">url</span> <span class="o">=</span> <span class="n">parseJson</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">body</span><span class="p">).</span><span class="n">getOrDefault</span><span class="p">(</span><span class="s">"url"</span><span class="p">).</span><span class="n">getStr</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">.</span><span class="n">isNilOrEmpty</span><span class="p">():</span>
      <span class="kd">var</span> <span class="n">id</span> <span class="o">=</span> <span class="n">theDb</span><span class="p">.</span><span class="n">getValue</span><span class="p">(</span><span class="s">sql"SELECT id FROM urls WHERE url=?"</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">id</span><span class="p">.</span><span class="n">isNilOrEmpty</span><span class="p">():</span>
        <span class="n">id</span> <span class="o">=</span> <span class="o">$</span><span class="n">theDb</span><span class="p">.</span><span class="n">tryInsertId</span><span class="p">(</span><span class="s">sql"INSERT INTO urls (url) VALUES (?)"</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
      <span class="kd">var</span> <span class="n">jsonResp</span> <span class="o">=</span> <span class="o">$</span><span class="p">(</span><span class="o">%*</span><span class="p">{</span><span class="s">"id"</span><span class="p">:</span> <span class="n">id</span><span class="p">})</span>
      <span class="n">resp</span> <span class="n">Http200</span><span class="p">,</span> <span class="n">jsonResp</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">resp</span> <span class="n">Http400</span><span class="p">,</span> <span class="s">"please specify url in the posted data."</span>
</pre></div></div>
<p>Here we handle <code>POST</code> requests on <code>/shorten</code> endpoint
- get the url from parsed json post data.<span class="intersentencespace"></span> please note that POST data is <code>available under request.body</code> <code>explained in the previous section</code></p>
<ul>
<li>if url is passed we try to check if it’s there in our <code>urls</code> table, if it’s there we return it, otherwise we insert it in the table.<span class="intersentencespace"></span>
</li>
<li>if the url isn’t passed we return a badrequest <code>400</code> status code.<span class="intersentencespace"></span>
</li>
<li><code>parseJson</code>: loads json from a string and you can get value using <code>getOrDefault</code> and <code>getStr</code> to get string value, there’s getBool, and so on.<span class="intersentencespace"></span>
</li>
<li><code>getValue</code> to get the id from the result of the select statement <code>returns the first column from the first row in the result set</code>
</li>
<li><code>tryInsertId</code> executes insert statement and returns the id of the new row
</li>
<li>after successfull insertion we would like to return <code>json</code> serialized string to the user <code>$(%*{"id": id})</code>
</li>
<li><code>%*</code> is a macro to convert nim struct into json node and to convert it to string we wrap <code>$</code> around it
</li></ul>
</div>
<div id="uid84" data-tralics-id="uid84" class="subsection" data-number="7.3.3"><h3><a href="#uid84" class="heading hyperref"><span class="number">7.3.3 </span>Shorturls redirect</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span>  <span class="n">get</span> <span class="s">"/@Id"</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">url</span> <span class="o">=</span> <span class="n">theDb</span><span class="p">.</span><span class="n">getValue</span><span class="p">(</span><span class="s">sql"SELECT url FROM urls WHERE id=?"</span><span class="p">,</span> <span class="o">@</span><span class="s">"Id"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">url</span><span class="p">.</span><span class="n">isNilOrEmpty</span><span class="p">():</span>
      <span class="n">resp</span> <span class="n">Http404</span><span class="p">,</span> <span class="s">"Don't know that url"</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">redirect</span> <span class="n">url</span>
</pre></div></div>
<ul>
<li>Here we fetch whatever path <code>@Id</code> the user trying to access <code>except for /home and /shorten</code> and we try to get the long url for that path
</li>
<li>If the path is resolved to a url we <code>redirect</code> the user to to or we show an error message
</li>
<li><code>@"Id"</code> gets the value of <code>@Id</code> query parameter : notice the <code>@</code> position in both situation
</li></ul>
</div></div>
<div id="cid24" data-tralics-id="cid24" class="section" data-number="7.4"><h2><a href="#cid24" class="heading hyperref"><span class="number">7.4 </span>RUN</a></h2>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="n">runForever</span><span class="p">()</span>
</pre></div></div>
<p>start jester webserver</p>
<p>Code is available here <a href="https://gist.github.com/xmonader/d41a5c9f917eadb90d3025e7b7e748dd" target="_blank" rel="noopener">https://gist.github.com/xmonader/d41a5c9f917eadb90d3025e7b7e748dd</a></p>
</div>
<div id="cid25" data-tralics-id="cid25" class="chapter" data-number="8"><h1><a href="#cid25" class="heading hyperref"><span class="number">Chapter 8 </span>Day 8: minitest</a></h1>
<p class="noindent">I’m a big fan of <a href="http://www.gigamonkeys.com/book/" target="_blank" rel="noopener">Practical Common Lisp</a> and It has a chapter on <a href="http://www.gigamonkeys.com/book/practical-building-a-unit-test-framework.html" target="_blank" rel="noopener">building a unittest framework using macros</a> and I didn’t get the chance to tinker with nim macros just yet, So today we will be building almost the same thing in nim.</p>
</div>
<div id="cid26" data-tralics-id="cid26" class="section" data-number="8.1"><h2><a href="#cid26" class="heading hyperref"><span class="number">8.1 </span>So what’s up?</a></h2>
<p class="noindent">Imagine you want to check for some expression and print a specific message donating the expression
</p><div class="code"><div class="highlight"><pre><span></span>  <span class="n">doAssert</span><span class="p">(</span><span class="mi">1</span><span class="o">==</span><span class="mi">2</span><span class="p">,</span> <span class="s">"1 == 2 failed"</span><span class="p">)</span>
</pre></div></div>
<p>Here we want to assure that 1==2 or show a message with <code>1==2 failed</code> and it goes on for whatever we want to check for</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="n">doAssert</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">==</span><span class="mi">3</span><span class="p">,</span> <span class="s">"1+2 == 3 failed"</span><span class="p">)</span>
  <span class="n">doAssert</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="mi">2</span><span class="o">==</span><span class="mi">10</span><span class="p">,</span> <span class="s">"5*2 == 10 failed"</span><span class="p">)</span>
</pre></div></div>
<p>We can already see the boilerplate here, repeating the expression twice one for the check and one for the message itself.</p>
</div>
<div id="cid27" data-tralics-id="cid27" class="section" data-number="8.2"><h2><a href="#cid27" class="heading hyperref"><span class="number">8.2 </span>What to expect?</a></h2>
<p class="noindent">We expect having a DSL to remove the boilerplate we’re suffering from in the prev.<span class="intersentencespace"></span> section.</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="n">check</span><span class="p">(</span><span class="mi">3</span><span class="o">==</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
  <span class="n">check</span><span class="p">(</span><span class="mi">6</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
</pre></div></div>
<p>And this will print
</p><div class="code"><div class="highlight"><pre><span></span>3 == 1 + 2 .. passed
6 + 5 * 2 == 16 .. passed
</pre></div></div>
<p>And it should evolve to allow grouping of test checks</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="n">check</span><span class="p">(</span><span class="mi">3</span><span class="o">==</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
  <span class="n">check</span><span class="p">(</span><span class="mi">6</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
  
  <span class="n">suite</span> <span class="s">"Arith"</span><span class="p">:</span>
    <span class="n">check</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">check</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="o">==</span><span class="mi">5</span><span class="p">)</span>

  <span class="n">suite</span> <span class="s">"Strs"</span><span class="p">:</span>
    <span class="n">check</span><span class="p">(</span><span class="s">"HELLO"</span><span class="p">.</span><span class="n">toLowerAscii</span><span class="p">()</span> <span class="o">==</span> <span class="s">"hello"</span><span class="p">)</span>
    <span class="n">check</span><span class="p">(</span><span class="s">""</span><span class="p">.</span><span class="n">isNilOrEmpty</span><span class="p">()</span> <span class="o">==</span> <span class="kp">true</span><span class="p">)</span>
</pre></div></div>
<p>Resulting something like this
</p><div class="code"><div class="highlight"><pre><span></span>3 == 1 + 2 .. passed
6 + 5 * 2 == 16 .. passed
==================================================
Arith
==================================================
 1 + 2 == 3 .. passed
 3 + 2 == 5 .. passed
==================================================
Strs
==================================================
 "HELLO".toLowerAscii() == "hello" .. passed
 "".isNilOrEmpty() == true .. passed
</pre></div></div>
</div>
<div id="cid28" data-tralics-id="cid28" class="section" data-number="8.3"><h2><a href="#cid28" class="heading hyperref"><span class="number">8.3 </span>Implementation</a></h2>
<p class="noindent">So nim has two way to do macros</p>
<div id="uid88" data-tralics-id="uid88" class="subsection" data-number="8.3.1"><h3><a href="#uid88" class="heading hyperref"><span class="number">8.3.1 </span>templates</a></h3>
<p class="noindent">Which are like functions that called in compilation time like <code>preprocessor</code></p>
<p>From the nim manual
</p><div class="code"><div class="highlight"><pre><span></span><span class="k">template</span> <span class="p">`</span><span class="o">!=</span><span class="p">`</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">untyped</span><span class="p">):</span> <span class="n">untyped</span> <span class="o">=</span>
  <span class="c"># this definition exists in the System module</span>
  <span class="ow">not</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span>

<span class="n">assert</span><span class="p">(</span><span class="mi">5</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span> <span class="c"># the compiler rewrites that to: assert(not (5 == 6))</span>
</pre></div></div>
<p>so in compile time <code>5 != 6</code> will be converted into <code>not ( 5 == 6)</code> and the whole expression will be <code>assert(not ( 5== 6))</code></p>
<p>So what’re we gonna do is check for the passed expression to convert it to a string to be printed in the terminal output and if the expression fails we append <code>failed</code> message or any other custom failure message</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">template</span> <span class="n">check</span><span class="o">*</span><span class="p">(</span><span class="n">exp</span><span class="p">:</span><span class="n">untyped</span><span class="p">,</span> <span class="n">failureMsg</span><span class="p">:</span><span class="kt">string</span><span class="o">=</span><span class="s">"failed"</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span><span class="n">uint</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="n">void</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">indentationStr</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="sc">' '</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span> 
  <span class="k">let</span> <span class="n">expStr</span><span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="n">astToStr</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
  <span class="kd">var</span> <span class="n">msg</span><span class="p">:</span> <span class="kt">string</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">exp</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="n">isNilOrEmpty</span><span class="p">():</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="n">indentationStr</span> <span class="o">&amp;</span> <span class="n">expStr</span> <span class="o">&amp;</span> <span class="s">" .. "</span> <span class="o">&amp;</span> <span class="n">failureMsg</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">indentationStr</span> <span class="o">&amp;</span> <span class="n">expStr</span> <span class="o">&amp;</span> <span class="s">" .. passed"</span>
      
  <span class="n">echo</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div></div>
<ul>
<li><code>untyped</code> means the expression doesn’t have to have a type yet, imagine passing variable name that doesn’t exist yet <code>defineVar(myVar, 5)</code> so here <code>myVar</code> needs to be untyped or the compiler will complain.<span class="intersentencespace"></span> check the manual for more info https://nim-lang.org/docs/manual.html#templates
</li>
<li><code>astToStr</code> converts the AST <code>exp</code> to a string
</li>
<li><code>indent</code> amount of spaces prefixing the message.<span class="intersentencespace"></span>
</li></ul>
</div>
<div id="uid92" data-tralics-id="uid92" class="subsection" data-number="8.3.2"><h3><a href="#uid92" class="heading hyperref"><span class="number">8.3.2 </span>Macros</a></h3>
<p class="noindent">Nim provides us with a way to access the AST in a very low level when we templates don’t cut it.</p>
<p>What we expected is having a <code>suite</code> macro
</p><div class="code"><div class="highlight"><pre><span></span>  suite "Strs":
    check("HELLO".toLowerAscii() == "hello")
    check("".isNilOrEmpty() == true)
</pre></div></div>
<p>that takes a <code>name</code> for the suite and bunch of <code>statements</code>
- Please note there’re two kind of macros and we’re interested in the <code>statements macro</code> here
- Statments macro is a macro that has <code>colon</code> <code>:</code> operator followed by bunch of statements</p>
<div id="uid93" data-tralics-id="uid93" class="subsubsection" data-number="8.3.2.1"><h4><a href="#uid93" class="heading">dumpTree</a></h4>
<p class="noindent">dumpTree is amazing to debug the ast and print them in a good visual way</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="n">dumpTree</span><span class="p">:</span>
    <span class="n">suite</span> <span class="s">"Strs"</span><span class="p">:</span>
      <span class="n">check</span><span class="p">(</span><span class="s">"HELLO"</span><span class="p">.</span><span class="n">toLowerAscii</span><span class="p">()</span> <span class="o">==</span> <span class="s">"hello"</span><span class="p">)</span>
</pre></div></div>
<div class="code"><div class="highlight"><pre><span></span>Ident ident"suite"
    StrLit Strs
    StmtList
      Call
        Ident ident"check"
        Infix
          Ident ident"=="
          Call
            DotExpr
              StrLit HELLO
              Ident ident"toLowerAscii"
          StrLit hello
</pre></div></div>
<ul>
<li><code>dumpTree</code> says it got <code>Identifier Ident</code> named <code>suite</code>
</li>
<li><code>suite</code> contains <code>StringLiteral</code> node with value <code>Strs</code>
</li>
<li><code>suite</code> contains <code>StmtList</code> node
</li>
<li>first statement in <code>StmtList</code> is a <code>call</code> statement
</li>
<li><code>call</code> statement consist of <code>procedure</code> name <code>check</code> in this case and args list and so on..<span class="intersentencespace"></span>
</li></ul>
<div class="code"><div class="highlight"><pre><span></span><span class="k">macro</span> <span class="n">suite</span><span class="o">*</span><span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="kt">string</span><span class="p">,</span> <span class="n">exprs</span><span class="p">:</span> <span class="n">untyped</span><span class="p">)</span> <span class="p">:</span> <span class="n">typed</span> <span class="o">=</span> 
</pre></div></div>
<p>Here, we define a macro <code>suite</code> takes <code>name</code> and bunch of statements <code>exprs</code>
- Macro must return an AST in our case will be list of statements of <code>check</code> call statemenets
- Need the messages to be indented</p>
<p>To achieve the indentation we can either print tab before calling <code>check</code> or overwrite check to pass <code>indent</code> option, we will go with overwrite the <code>check</code> call ASTs</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="kd">var</span> <span class="n">result</span> <span class="o">=</span> <span class="n">newStmtList</span><span class="p">()</span>
</pre></div></div>
<p>We will be returning a list of statments right?</p>
<div class="code"><div class="highlight"><pre><span></span>  let equline = newCall("repeat", newStrLitNode("="), newIntLitNode(50))
</pre></div></div>
<p>statement node that equals <code>repeat("=", 50)</code></p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="k">let</span> <span class="n">writeEquline</span> <span class="o">=</span> <span class="n">newCall</span><span class="p">(</span><span class="s">"echo"</span><span class="p">,</span> <span class="n">equline</span><span class="p">)</span>
</pre></div></div>
<p>statement node the equals <code>echo repeat("=", 50)</code></p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">writeEquline</span><span class="p">,</span> <span class="n">newCall</span><span class="p">(</span><span class="s">"echo"</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
  <span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">writeEquline</span><span class="p">)</span>
</pre></div></div>
<p>this will generate
</p><div class="code"><div class="highlight"><pre><span></span>================
$name
================
</pre></div></div>
<p>Now we iterate over the passed statements to <code>suite</code> macro and check for its kind
</p><div class="code"><div class="highlight"><pre><span></span>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mf">0</span><span class="p">..</span><span class="o">&lt;</span><span class="n">exprs</span><span class="p">.</span><span class="n">len</span><span class="p">:</span>
    <span class="kd">var</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">exprs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span>
    <span class="k">let</span> <span class="n">expKind</span> <span class="o">=</span> <span class="n">exp</span><span class="p">.</span><span class="n">kind</span>
    <span class="k">case</span> <span class="n">expKind</span>
    <span class="k">of</span> <span class="n">nnkCall</span><span class="p">:</span>
      <span class="k">case</span> <span class="n">exp</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">.</span><span class="n">kind</span>
      <span class="k">of</span> <span class="n">nnkIdent</span><span class="p">:</span>
        <span class="k">let</span> <span class="n">identName</span> <span class="o">=</span> <span class="o">$</span><span class="n">exp</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">.</span><span class="n">ident</span>
        <span class="k">if</span> <span class="n">identName</span> <span class="o">==</span> <span class="s">"check"</span><span class="p">:</span>
</pre></div></div>
<ul>
<li>If we’re in a <code>check</code> call we will convert it from <code>check(expr)</code> =&gt; <code>check(expr, "", 1)</code>
</li></ul>
<div class="code"><div class="highlight"><pre><span></span>          <span class="kd">var</span> <span class="n">checkWithIndent</span> <span class="o">=</span> <span class="n">exp</span>
          <span class="n">checkWithIndent</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">newStrLitNode</span><span class="p">(</span><span class="s">""</span><span class="p">))</span>
          <span class="n">checkWithIndent</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">newIntLitNode</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
          <span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">checkWithIndent</span><span class="p">)</span>
</pre></div></div>
<p>otherwise we add any other statement as is unprocessesed.</p>
<div class="code"><div class="highlight"><pre><span></span>      <span class="k">else</span><span class="p">:</span>
        <span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span> 
    <span class="k">else</span><span class="p">:</span>
      <span class="k">discard</span>
        
  <span class="k">return</span> <span class="n">result</span>
</pre></div></div>
<p>Code is available on https://github.com/xmonader/nim-minitest</p>
</div></div></div>
<div id="cid29" data-tralics-id="cid29" class="chapter" data-number="9"><h1><a href="#cid29" class="heading hyperref"><span class="number">Chapter 9 </span>Day 9: Tic tac toe</a></h1>
<p class="noindent">Who didn’t play <a href="https://en.wikipedia.org/wiki/Tic-tac-toe" target="_blank" rel="noopener">Tic tac toe</a> with his friends?<span class="intersentencespace"></span> :)</p>
</div>
<div id="cid30" data-tralics-id="cid30" class="section" data-number="9.1"><h2><a href="#cid30" class="heading hyperref"><span class="number">9.1 </span>What to expect</a></h2>
<p class="noindent">Today we will implement tic tac toe game in Nim, with 2 modes
- Human vs Human
- Human vs AI</p>
</div>
<div id="cid31" data-tralics-id="cid31" class="section" data-number="9.2"><h2><a href="#cid31" class="heading hyperref"><span class="number">9.2 </span>Implementation</a></h2>
<p class="noindent">So, let’s get it.<span class="intersentencespace"></span> The winner in the game is the first one who manages to get 3 cells on the board to be the same in the same column or row or diagonally first.</p>
<div id="uid100" data-tralics-id="uid100" class="subsection" data-number="9.2.1"><h3><a href="#uid100" class="heading hyperref"><span class="number">9.2.1 </span>imports</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">sequtils</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">strutils</span><span class="p">,</span> <span class="n">strformat</span><span class="p">,</span> <span class="n">random</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">parseopt2</span>

<span class="n">randomize</span><span class="p">()</span>
</pre></div></div>
</div>
<div id="uid101" data-tralics-id="uid101" class="subsection" data-number="9.2.2"><h3><a href="#uid101" class="heading hyperref"><span class="number">9.2.2 </span>Constraints and objects</a></h3>
<p class="noindent">As the game allow turns we should have a way to keep track of the next player</p>
<div class="code"><div class="highlight"><pre><span></span>let NEXT_PLAYER = {"X":"O", "O":"X"}.toTable
</pre></div></div>
<p>Here we use a table to tell us the next player</p>
<div id="uid102" data-tralics-id="uid102" class="subsubsection" data-number="9.2.2.1"><h4><a href="#uid102" class="heading">Board</a></h4>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> 
  <span class="n">Board</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">RootObj</span>
    <span class="n">list</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="kt">string</span><span class="o">]</span>
</pre></div></div>
<p>Here we define a simple class representing the board
- list is a sequence representing the cells <code>maybe cells is a better name</code>
- please note list is just a sequenece of elements <code>0 1 2 3 4 5 6 7 8</code> but we visualize it as</p>
<div class="code"><div class="highlight"><pre><span></span>0 1 2
3 4 5
6 7 9
</pre></div></div>
<p>instead of using a 2d array for the sake of simplicity</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">WINS</span> <span class="o">=</span> <span class="o">@[</span> <span class="o">@[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="o">@[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="o">]</span><span class="p">,</span> <span class="o">@[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="o">]</span><span class="p">,</span> <span class="o">@[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="o">]</span><span class="p">,</span> <span class="o">@[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="o">]</span><span class="p">,</span> <span class="o">@[</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="o">]</span><span class="p">,</span> <span class="o">@[</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="o">]</span><span class="p">,</span> <span class="o">@[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="o">]</span> <span class="o">]</span>
</pre></div></div>
<p>We talked <code>WIN</code> patterns cells in the same row or the same column or in same diagonal</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">newBoard</span><span class="p">():</span> <span class="n">Board</span> <span class="o">=</span>
  <span class="kd">var</span> <span class="n">b</span> <span class="o">=</span> <span class="n">Board</span><span class="p">()</span>
  <span class="n">b</span><span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="o">@[</span><span class="s">"0"</span><span class="p">,</span> <span class="s">"1"</span><span class="p">,</span> <span class="s">"2"</span><span class="p">,</span> <span class="s">"3"</span><span class="p">,</span> <span class="s">"4"</span><span class="p">,</span> <span class="s">"5"</span><span class="p">,</span> <span class="s">"6"</span><span class="p">,</span> <span class="s">"7"</span><span class="p">,</span> <span class="s">"8"</span><span class="o">]</span>
  <span class="k">return</span> <span class="n">b</span>
</pre></div></div>
<p>this is the initializer of the board and sets the cell value to the string represention of its index</p>
<div3 id="uid103" data-tralics-id="uid103" data-number="">Winning
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">done</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Board</span><span class="p">):</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">string</span><span class="p">)</span> <span class="o">=</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">WINS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="n">w</span><span class="o">[</span><span class="mi">0</span><span class="o">]]</span> <span class="o">==</span> <span class="n">this</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="n">w</span><span class="o">[</span><span class="mi">1</span><span class="o">]]</span> <span class="ow">and</span> <span class="n">this</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="n">w</span><span class="o">[</span><span class="mi">1</span><span class="o">]]</span>  <span class="o">==</span> <span class="n">this</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="n">w</span><span class="o">[</span><span class="mi">2</span><span class="o">]]</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="n">w</span><span class="o">[</span><span class="mi">0</span><span class="o">]]</span> <span class="o">==</span> <span class="s">"X"</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kp">true</span><span class="p">,</span> <span class="s">"X"</span><span class="p">)</span>
          <span class="k">elif</span> <span class="n">this</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="n">w</span><span class="o">[</span><span class="mi">0</span><span class="o">]]</span> <span class="o">==</span> <span class="s">"O"</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kp">true</span><span class="p">,</span> <span class="s">"O"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">all</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="k">proc</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="kt">string</span><span class="p">):</span><span class="kt">bool</span> <span class="o">=</span> <span class="n">x</span> <span class="ow">in</span> <span class="o">@[</span><span class="s">"O"</span><span class="p">,</span> <span class="s">"X"</span><span class="o">]</span><span class="p">)</span> <span class="o">==</span> <span class="kp">true</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kp">true</span><span class="p">,</span> <span class="s">"tie"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kp">false</span><span class="p">,</span> <span class="s">"going"</span><span class="p">)</span>
</pre></div></div>
<p>Here we check for the state of the game and the winner if all of the item in <code>WIN</code> patterns are the same</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">`$`</span><span class="p">(</span><span class="n">this</span><span class="p">:</span><span class="n">Board</span><span class="p">):</span> <span class="kt">string</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">rows</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="kt">seq</span><span class="o">[</span><span class="kt">string</span><span class="o">]]</span> <span class="o">=</span> <span class="o">@[</span><span class="n">this</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="mf">0</span><span class="p">..</span><span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="mf">3</span><span class="p">..</span><span class="mi">5</span><span class="o">]</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="mf">6</span><span class="p">..</span><span class="mi">8</span><span class="o">]]</span>
  <span class="k">for</span> <span class="n">row</span>  <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
      <span class="n">stdout</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">cell</span> <span class="o">&amp;</span> <span class="s">" | "</span><span class="p">)</span>
    <span class="n">echo</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">--------------"</span><span class="p">)</span>
</pre></div></div>
<p>Here we have the string representation of the board so we can show it as 3x3 grid in a lovely way</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">emptySpots</span><span class="p">(</span><span class="n">this</span><span class="p">:</span><span class="n">Board</span><span class="p">):</span><span class="kt">seq</span><span class="o">[</span><span class="kt">int</span><span class="o">]</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">emptyindices</span> <span class="o">=</span> <span class="n">newSeq</span><span class="o">[</span><span class="kt">int</span><span class="o">]</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">this</span><span class="p">.</span><span class="n">list</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">i</span><span class="p">.</span><span class="n">isDigit</span><span class="p">():</span>
        <span class="n">emptyindices</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">parseInt</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">emptyindices</span>
</pre></div></div>
<p>Here we have a simple helper function that returns the empty spots indices <code>the spots that doesn’t have X or O in it</code>, remember all the cells are initialized to the string representation of their indices.</p>
</div3></div>
<div id="uid104" data-tralics-id="uid104" class="subsubsection" data-number="9.2.2.2"><h4><a href="#uid104" class="heading">Game</a></h4>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span>
  <span class="n">Game</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">RootObj</span>
    <span class="n">currentPlayer</span><span class="o">*</span><span class="p">:</span> <span class="kt">string</span>
    <span class="n">board</span><span class="o">*</span><span class="p">:</span> <span class="n">Board</span>
    <span class="n">aiPlayer</span><span class="o">*</span><span class="p">:</span> <span class="kt">string</span>
    <span class="n">difficulty</span><span class="o">*</span><span class="p">:</span> <span class="kt">int</span>


<span class="k">proc </span><span class="nf">newGame</span><span class="p">(</span><span class="n">aiPlayer</span><span class="p">:</span><span class="kt">string</span><span class="o">=</span><span class="s">""</span><span class="p">,</span> <span class="n">difficulty</span><span class="p">:</span><span class="kt">int</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span> <span class="n">Game</span> <span class="o">=</span>
  <span class="kd">var</span>
    <span class="n">game</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Game</span>

  <span class="n">game</span><span class="p">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">newBoard</span><span class="p">()</span>
  <span class="n">game</span><span class="p">.</span><span class="n">currentPlayer</span> <span class="o">=</span> <span class="s">"X"</span>
  <span class="n">game</span><span class="p">.</span><span class="n">aiPlayer</span> <span class="o">=</span> <span class="n">aiPlayer</span>
  <span class="n">game</span><span class="p">.</span><span class="n">difficulty</span> <span class="o">=</span> <span class="n">difficulty</span>
  
  <span class="k">return</span> <span class="n">game</span>
        <span class="c"># 0 1 2</span>
        <span class="c"># 3 4 5</span>
        <span class="c"># 6 7 8 </span>
</pre></div></div>
<p>Here we have another object representing the game and the players and the difficulty and wether it has an AI player or not and who is the current player</p>
<ul>
<li>difficulty is only logical in case of AI, it means when does the AI start calculating moves and considering scenarios, 9 is the hardest, 0 is the easiest.<span class="intersentencespace"></span>
</li></ul>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">changePlayer</span><span class="p">(</span><span class="n">this</span><span class="p">:</span><span class="n">Game</span><span class="p">)</span> <span class="p">:</span> <span class="n">void</span> <span class="o">=</span>
  <span class="n">this</span><span class="p">.</span><span class="n">currentPlayer</span> <span class="o">=</span> <span class="n">NEXT_PLAYER</span><span class="o">[</span><span class="n">this</span><span class="p">.</span><span class="n">currentPlayer</span><span class="o">]</span>   
</pre></div></div>
<p>Simple procedure to switch turns between players</p>
</div>
<div id="uid106" data-tralics-id="uid106" class="subsubsection" data-number="9.2.2.3"><h4><a href="#uid106" class="heading">Start the game</a></h4>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">startGame</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span><span class="n">Game</span><span class="p">):</span> <span class="n">void</span><span class="o">=</span>
    <span class="k">while</span> <span class="kp">true</span><span class="p">:</span>
        <span class="n">echo</span> <span class="n">this</span><span class="p">.</span><span class="n">board</span>
        <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">aiPlayer</span> <span class="o">!=</span> <span class="n">this</span><span class="p">.</span><span class="n">currentPlayer</span><span class="p">:</span>
          <span class="n">stdout</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"Enter move: "</span><span class="p">)</span>
          <span class="k">let</span> <span class="n">move</span> <span class="o">=</span> <span class="n">stdin</span><span class="p">.</span><span class="n">readLine</span><span class="p">()</span>
          <span class="n">this</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="n">parseInt</span><span class="p">(</span><span class="o">$</span><span class="n">move</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">currentPlayer</span>
        <span class="n">this</span><span class="p">.</span><span class="n">change_player</span><span class="p">()</span>
        <span class="k">let</span> <span class="p">(</span><span class="n">done</span><span class="p">,</span> <span class="n">winner</span><span class="p">)</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">done</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">done</span> <span class="o">==</span> <span class="kp">true</span><span class="p">:</span>
          <span class="n">echo</span> <span class="n">this</span><span class="p">.</span><span class="n">board</span>
          <span class="k">if</span> <span class="n">winner</span> <span class="o">==</span> <span class="s">"tie"</span><span class="p">:</span>
              <span class="n">echo</span><span class="p">(</span><span class="s">"TIE"</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
              <span class="n">echo</span><span class="p">(</span><span class="s">"WINNER IS :"</span><span class="p">,</span> <span class="n">winner</span> <span class="p">)</span>
          <span class="k">break</span>           
</pre></div></div>
<p>Here if we don’t have <code>aiPlayer</code> if not set it’s just a game with 2 humans switching turns and checking for the winner after each move</p>
</div></div>
<div id="uid107" data-tralics-id="uid107" class="subsection" data-number="9.2.3"><h3><a href="#uid107" class="heading hyperref"><span class="number">9.2.3 </span>Minmax and AI support</a></h3>
<p class="noindent"><a href="https://en.wikipedia.org/wiki/Minimax" target="_blank" rel="noopener">Minmax</a> is an algorithm mainly used to predict the possible moves in the future and how to minimize the losses and maximize the chances of winning</p>
<ul>
<li>https://www.youtube.com/watch?v=6ELUvkSkCts
</li>
<li>https://www.youtube.com/watch?v=CwziaVrM_vc&amp;t=1199s
</li></ul>
<div class="code"><div class="highlight"><pre><span></span><span class="k">type</span> 
  <span class="n">Move</span> <span class="o">=</span> <span class="k">tuple</span><span class="o">[</span><span class="n">score</span><span class="p">:</span><span class="kt">int</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span><span class="kt">int</span><span class="o">]</span>
</pre></div></div>
<p>We need a type Move on a certain idx to represent if it’s a good/bad move <code>depending on the score</code></p>
<ul>
<li>good means minimizing chances of the human to win or making AI win =&gt; high score +10
</li>
<li>bad means maximizing chances of the human to win or making AI lose =&gt; low score -10
</li></ul>
<p>So let’s say we are in this situation
</p><div class="code"><div class="highlight"><pre><span></span>X 1 X
O 4 X
X O O
</pre></div></div>
<p>And it’s <code>AI turn</code> we have two possible moves</p>
<div class="code"><div class="highlight"><pre><span></span>X 1 X
O O X
X O O
</pre></div></div>
<p>this moves is clearly wrong because the next move to human will allow him to win the first row So this is a bad move we give it score -10
or</p>
<div class="code"><div class="highlight"><pre><span></span>X O X
O 4 X
X O O
</pre></div></div>
<p>this moves minimizes the losses (leads to a TIE instead of making human wins) so we give it a higher score</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">getBestMove</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Game</span><span class="p">,</span> <span class="n">board</span><span class="p">:</span> <span class="n">Board</span><span class="p">,</span> <span class="n">player</span><span class="p">:</span><span class="kt">string</span><span class="p">):</span> <span class="n">Move</span> <span class="o">=</span>
        <span class="k">let</span> <span class="p">(</span><span class="n">done</span><span class="p">,</span> <span class="n">winner</span><span class="p">)</span> <span class="o">=</span> <span class="n">board</span><span class="p">.</span><span class="n">done</span><span class="p">()</span>
        <span class="c"># determine the score of the move by checking where does it lead to a win or loss.</span>
        <span class="k">if</span> <span class="n">done</span> <span class="o">==</span> <span class="kp">true</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">winner</span> <span class="o">==</span>  <span class="n">this</span><span class="p">.</span><span class="n">aiPlayer</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">score</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">winner</span> <span class="o">!=</span> <span class="s">"tie"</span><span class="p">:</span> <span class="c">#human</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">score</span><span class="p">:(</span><span class="o">-</span><span class="mi">10</span><span class="p">),</span> <span class="n">idx</span><span class="p">:</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">score</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span><span class="mi">0</span><span class="p">)</span>
            
        <span class="k">let</span> <span class="n">empty_spots</span> <span class="o">=</span> <span class="n">board</span><span class="p">.</span><span class="n">empty_spots</span><span class="p">()</span>
        <span class="kd">var</span> <span class="n">moves</span> <span class="o">=</span> <span class="n">newSeq</span><span class="o">[</span><span class="n">Move</span><span class="o">]</span><span class="p">()</span> 
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">empty_spots</span><span class="p">:</span>
            <span class="c"># we calculate more new trees depending on the current situation and see where the upcoming moves lead</span>
            <span class="kd">var</span> <span class="n">newboard</span> <span class="o">=</span> <span class="n">newBoard</span><span class="p">()</span>

            <span class="n">newboard</span><span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">map</span><span class="p">(</span><span class="n">board</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="k">proc</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="kt">string</span><span class="p">):</span><span class="kt">string</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
            <span class="n">newboard</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="n">idx</span><span class="o">]</span> <span class="o">=</span> <span class="n">player</span>
            <span class="k">let</span> <span class="n">score</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">getBestMove</span><span class="p">(</span><span class="n">newboard</span><span class="p">,</span> <span class="n">NEXT_PLAYER</span><span class="o">[</span><span class="n">player</span><span class="o">]</span><span class="p">).</span><span class="n">score</span>
            <span class="k">let</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span>
            <span class="k">let</span> <span class="n">move</span> <span class="o">=</span> <span class="p">(</span><span class="n">score</span><span class="p">:</span><span class="n">score</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">moves</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">move</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">player</span> <span class="o">==</span> <span class="n">this</span><span class="p">.</span><span class="n">aiPlayer</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">max</span><span class="p">(</span><span class="n">moves</span><span class="p">)</span>          
          <span class="c"># var bestScore = -1000</span>
          <span class="c"># var bestMove: Move </span>
          <span class="c"># for m in moves:</span>
          <span class="c">#   if m.score &gt; bestScore:</span>
          <span class="c">#     bestMove = m</span>
          <span class="c">#     bestScore = m.score</span>
          <span class="c"># return bestMove</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="n">moves</span><span class="p">)</span>          
          <span class="c"># var bestScore = 1000</span>
          <span class="c"># var bestMove: Move </span>
          <span class="c"># for m in moves:</span>
          <span class="c">#   if m.score &lt; bestScore:</span>
          <span class="c">#     bestMove = m</span>
          <span class="c">#     bestScore = m.score</span>
          <span class="c"># return bestMove</span>
</pre></div></div>
<p>Here we have a highly annotated <code>getBestMove</code> procedure to calculate recursively the best move for us</p>
<p>Now our startGame should look like this</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">startGame</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span><span class="n">Game</span><span class="p">):</span> <span class="n">void</span><span class="o">=</span>
    <span class="k">while</span> <span class="kp">true</span><span class="p">:</span>
        <span class="sd">##old code</span>

        <span class="sd">## AI check</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">currentPlayer</span> <span class="o">==</span> <span class="n">this</span><span class="p">.</span><span class="n">aiPlayer</span><span class="p">:</span>
              <span class="k">let</span> <span class="n">emptyspots</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">emptySpots</span><span class="p">()</span>
              <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">emptyspots</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">this</span><span class="p">.</span><span class="n">difficulty</span><span class="p">:</span>
                  <span class="n">echo</span><span class="p">(</span><span class="s">"AI MOVE.."</span><span class="p">)</span>
                  <span class="k">let</span> <span class="n">move</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">getbestmove</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">board</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">aiPlayer</span><span class="p">)</span>
                  <span class="n">this</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="n">move</span><span class="p">.</span><span class="n">idx</span><span class="o">]</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">aiPlayer</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="n">echo</span><span class="p">(</span><span class="s">"RANDOM GUESS"</span><span class="p">)</span>
                  <span class="n">this</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="n">emptyspots</span><span class="p">.</span><span class="n">rand</span><span class="p">()</span><span class="o">]</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">aiPlayer</span>
  
        <span class="sd">## oldcode    </span>
</pre></div></div>
<p>Here we allow the game to use difficulty which means when does the AI starts calculating the moves and making the tree?<span class="intersentencespace"></span> from the beginning 9 cells left or when there’re 4 cells left?<span class="intersentencespace"></span> you can set it the way you want it, and until u reach the starting difficulty situation AI will use random guesses (from the available <code>emptyspots</code>) instead of calculating</p>
</div>
<div id="uid112" data-tralics-id="uid112" class="subsection" data-number="9.2.4"><h3><a href="#uid112" class="heading hyperref"><span class="number">9.2.4 </span>CLI entry</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">writeHelp</span><span class="p">()</span> <span class="o">=</span> 
  <span class="n">echo</span> <span class="s">"""</span>
<span class="s">TicTacToe 0.1.0 (MinMax version)</span>
<span class="s">Allowed arguments:</span>
<span class="s">  -h | --help         : show help</span>
<span class="s">  -a | --ai           : AI player [X or O]</span>
<span class="s">  -l | --difficulty   : destination to stow to</span>
<span class="s">  """</span>

<span class="k">proc </span><span class="nf">cli</span><span class="o">*</span><span class="p">()</span> <span class="o">=</span>
  <span class="kd">var</span> 
    <span class="n">aiplayer</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">difficulty</span> <span class="o">=</span> <span class="mi">9</span>

  <span class="k">for</span> <span class="n">kind</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">getopt</span><span class="p">():</span>
    <span class="k">case</span> <span class="n">kind</span>
    <span class="k">of</span> <span class="n">cmdLongOption</span><span class="p">,</span> <span class="n">cmdShortOption</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">key</span>
        <span class="k">of</span> <span class="s">"help"</span><span class="p">,</span> <span class="s">"h"</span><span class="p">:</span> 
            <span class="n">writeHelp</span><span class="p">()</span>
            <span class="c"># quit()</span>
        <span class="k">of</span> <span class="s">"aiplayer"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">:</span>
          <span class="n">echo</span> <span class="s">"AIPLAYER: "</span> <span class="o">&amp;</span> <span class="n">val</span>
          <span class="n">aiplayer</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">of</span> <span class="s">"level"</span><span class="p">,</span> <span class="s">"l"</span><span class="p">:</span> <span class="n">difficulty</span> <span class="o">=</span> <span class="n">parseInt</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">discard</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">discard</span> 

  <span class="k">let</span> <span class="n">g</span> <span class="o">=</span> <span class="n">newGame</span><span class="p">(</span><span class="n">aiPlayer</span><span class="o">=</span><span class="n">aiplayer</span><span class="p">,</span> <span class="n">difficulty</span><span class="o">=</span><span class="n">difficulty</span><span class="p">)</span>
  <span class="n">g</span><span class="p">.</span><span class="n">startGame</span><span class="p">()</span>


<span class="k">when</span> <span class="n">isMainModule</span><span class="p">:</span>
  <span class="n">cli</span><span class="p">()</span>
</pre></div></div>
<p>Code is available on <a href="https://github.com/xmonader/nim-tictactoe/blob/master/src/nim_tictactoe_cli.nim" target="_blank" rel="noopener">https://github.com/xmonader/nim-tictactoe/blob/master/src/nim_tictactoe_cli.nim</a></p>
</div></div>
<div id="cid32" data-tralics-id="cid32" class="chapter" data-number="10"><h1><a href="#cid32" class="heading hyperref"><span class="number">Chapter 10 </span>Day 10: Tic tac toe with GUI!!</a></h1>
<p class="noindent">Hopefully, you’re done with day 9 and enjoyed playing tic tac toe.</p>
</div>
<div id="cid33" data-tralics-id="cid33" class="section" data-number="10.1"><h2><a href="#cid33" class="heading hyperref"><span class="number">10.1 </span>Expectation</a></h2>
<p class="noindent">It’s fun to play on the command line, but it’d be very cool to have some GUI with some buttons using libui bindings in Nim</p>
</div>
<div id="cid34" data-tralics-id="cid34" class="section" data-number="10.2"><h2><a href="#cid34" class="heading hyperref"><span class="number">10.2 </span>Implementation</a></h2>
<p class="noindent">In the previous day we reached some good abstraction separating the logic for the command line gui and the minmax algorithm and it’s not tightly coupled</p>
<div id="uid113" data-tralics-id="uid113" class="subsection" data-number="10.2.1"><h3><a href="#uid113" class="heading hyperref"><span class="number">10.2.1 </span>minimal ui application</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">gui</span><span class="o">*</span><span class="p">()</span> <span class="o">=</span> 
  <span class="kd">var</span> <span class="n">mainwin</span> <span class="o">=</span> <span class="n">newWindow</span><span class="p">(</span><span class="s">"tictactoe"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">show</span><span class="p">(</span><span class="n">mainwin</span><span class="p">)</span>
  <span class="n">mainLoop</span><span class="p">()</span>

<span class="k">when</span> <span class="n">isMainModule</span><span class="p">:</span>
  <span class="c"># cli()</span>
  <span class="n">init</span><span class="p">()</span>
  <span class="n">gui</span><span class="p">()</span>
</pre></div></div>
<p>Here we create a window 400x500 with a title <code>tictactoe</code> and we show it and start its mainLoop <code>getting ready to receive and dispatch events</code></p>
</div>
<div id="uid114" data-tralics-id="uid114" class="subsection" data-number="10.2.2"><h3><a href="#uid114" class="heading hyperref"><span class="number">10.2.2 </span>TicTacToe GUI</a></h3>
<p class="noindent">We can imagine the gui to be something like that</p>
<div class="code"><div class="highlight"><pre><span></span>---------------------------------------------
|  ---------------------------------------  |
+  | INFO LABEL | button to restart       | +
|  ---------------------------------------| |
+  |--------------------------------------| +
|  |  btn     |    btn  |   btn           | |
+  |--------------------------------------| +
|  |  btn     |    btn  |   btn           | |
+  |--------------------------------------| +
|  |  btn     |    btn  |   btn           | |
+  |--------------------------------------| +
---------------------------------------------
</pre></div></div>
<ul>
<li>a window that contains a vertical box
</li>
<li>the vertical box contains 4 rows
</li>
<li>first row to show information about the current game and a button to reset the game
</li>
<li>and the other rows represent the 3x3 tictactoe grid that will reflect <code>game.list</code> :)
</li>
<li>and 9 buttons to be pressed to set X or O
</li>
<li>we will support human vs AI so when human presses a button it gets disabled and the AI presses the button that minimizes its loss and that button gets disabled too.<span class="intersentencespace"></span>
</li></ul>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">gui</span><span class="o">*</span><span class="p">()</span> <span class="o">=</span> 
  <span class="kd">var</span> <span class="n">mainwin</span> <span class="o">=</span> <span class="n">newWindow</span><span class="p">(</span><span class="s">"tictactoe"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>

  <span class="c"># game object to contain the state, the players, the difficulty,...</span>
  <span class="kd">var</span> <span class="n">g</span> <span class="o">=</span> <span class="n">newGame</span><span class="p">(</span><span class="n">aiPlayer</span><span class="o">=</span><span class="s">"O"</span><span class="p">,</span> <span class="n">difficulty</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

  <span class="kd">var</span> <span class="n">currentMove</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="n">mainwin</span><span class="p">.</span><span class="n">margined</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">mainwin</span><span class="p">.</span><span class="n">onClosing</span> <span class="o">=</span> <span class="p">(</span><span class="k">proc</span> <span class="p">():</span> <span class="kt">bool</span> <span class="o">=</span> <span class="k">return</span> <span class="kp">true</span><span class="p">)</span>


  <span class="c"># set up the boxes </span>
  <span class="k">let</span> <span class="n">box</span> <span class="o">=</span> <span class="n">newVerticalBox</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">hbox0</span> <span class="o">=</span> <span class="n">newHorizontalBox</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">hbox1</span> <span class="o">=</span> <span class="n">newHorizontalBox</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">hbox2</span> <span class="o">=</span> <span class="n">newHorizontalBox</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">hbox3</span> <span class="o">=</span> <span class="n">newHorizontalBox</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="c"># list of buttons </span>
  <span class="kd">var</span> <span class="n">buttons</span> <span class="o">=</span> <span class="n">newSeq</span><span class="o">[</span><span class="n">Button</span><span class="o">]</span><span class="p">()</span>

  <span class="c"># information label</span>
  <span class="kd">var</span> <span class="n">labelInfo</span> <span class="o">=</span> <span class="n">newLabel</span><span class="p">(</span><span class="s">"Info: Player X turn"</span><span class="p">)</span>
  <span class="n">hbox0</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">labelInfo</span><span class="p">)</span>

  <span class="c"># restart button</span>
  <span class="n">hbox0</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">newButton</span><span class="p">(</span><span class="s">"Restart"</span><span class="p">,</span> <span class="k">proc</span><span class="p">()</span> <span class="o">=</span> 
                            <span class="n">g</span> <span class="o">=</span><span class="n">newGame</span><span class="p">(</span><span class="n">aiPlayer</span><span class="o">=</span><span class="s">"O"</span><span class="p">,</span> <span class="n">difficulty</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">.</span><span class="n">pairs</span><span class="p">:</span>
                              <span class="n">b</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="o">$</span><span class="n">i</span>
                              <span class="n">b</span><span class="p">.</span><span class="n">enable</span><span class="p">()))</span>
</pre></div></div>
<p>Here we setup the layout we just described and create a button Restart that resets the game again and restore the buttons text and enables them all</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="c"># create the buttons</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">countup</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
    <span class="kd">var</span> <span class="n">handler</span> <span class="p">:</span> <span class="k">proc</span><span class="p">()</span> 
    <span class="n">closureScope</span><span class="p">:</span>
      <span class="k">let</span> <span class="n">senderId</span> <span class="o">=</span> <span class="n">i</span>
      <span class="n">handler</span> <span class="o">=</span> <span class="k">proc</span><span class="p">()</span> <span class="o">=</span>
        <span class="n">currentMove</span> <span class="o">=</span> <span class="n">senderId</span>
        <span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="n">senderId</span><span class="o">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">currentPlayer</span>
        <span class="n">g</span><span class="p">.</span><span class="n">change_player</span><span class="p">()</span>
        <span class="n">labelInfo</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Current player: "</span> <span class="o">&amp;</span> <span class="n">g</span><span class="p">.</span><span class="n">currentPlayer</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">pairs</span><span class="p">:</span>
          <span class="n">buttons</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">let</span> <span class="p">(</span><span class="n">done</span><span class="p">,</span> <span class="n">winner</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">done</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">done</span> <span class="o">==</span> <span class="kp">true</span><span class="p">:</span>
          <span class="n">echo</span> <span class="n">g</span><span class="p">.</span><span class="n">board</span>
          <span class="k">if</span> <span class="n">winner</span> <span class="o">==</span> <span class="s">"tie"</span><span class="p">:</span>
              <span class="n">labelInfo</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Tie.."</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">labelInfo</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">winner</span> <span class="o">&amp;</span> <span class="s">" won."</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">aiPlay</span><span class="p">()</span>
        <span class="n">buttons</span><span class="o">[</span><span class="n">senderId</span><span class="o">]</span><span class="p">.</span><span class="n">disable</span><span class="p">()</span>

    <span class="n">buttons</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">newButton</span><span class="p">(</span><span class="o">$</span><span class="n">i</span><span class="p">,</span> <span class="n">handler</span><span class="p">))</span>
 <span class="p">```</span>

 <span class="o">-</span> <span class="n">Here</span> <span class="n">we</span> <span class="n">create</span> <span class="n">the</span> <span class="n">buttons</span> <span class="n">please</span> <span class="n">notice</span> <span class="n">we</span> <span class="n">are</span> <span class="n">using</span> <span class="p">`</span><span class="n">closureScope</span><span class="p">`</span> <span class="n">feature</span> <span class="n">to</span> <span class="n">capture</span> <span class="n">the</span> <span class="n">button</span> <span class="n">id</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">track</span> <span class="k">of</span> <span class="n">which</span> <span class="n">button</span> <span class="ow">is</span> <span class="n">clicked</span>
 <span class="o">-</span> <span class="n">after</span> <span class="n">pressing</span> <span class="kt">set</span> <span class="kt">set</span> <span class="n">the</span> <span class="n">text</span> <span class="k">of</span> <span class="n">the</span> <span class="n">button</span> <span class="n">to</span> <span class="p">`</span><span class="n">X</span><span class="p">`</span>
 <span class="o">-</span> <span class="n">we</span> <span class="n">disable</span> <span class="n">the</span> <span class="n">button</span> <span class="n">so</span> <span class="n">we</span> <span class="n">don</span><span class="sc">'t receive anymore events.</span>
 <span class="o">-</span> <span class="n">switch</span> <span class="n">turns</span>
 <span class="o">-</span> <span class="n">update</span> <span class="n">the</span> <span class="n">information</span> <span class="n">label</span> <span class="n">whether</span> <span class="n">about</span> <span class="n">the</span> <span class="n">next</span> <span class="n">player</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">game</span> <span class="n">state</span>
 <span class="o">-</span> <span class="k">if</span> <span class="n">the</span> <span class="n">game</span> <span class="ow">is</span> <span class="n">still</span> <span class="n">going</span> <span class="n">we</span> <span class="n">ask</span> <span class="n">the</span> <span class="n">AI</span> <span class="k">for</span> <span class="n">a</span> <span class="n">move</span>


<span class="p">```</span><span class="n">nim</span>

  <span class="c"># code to run when the game asks the ai to play (after each move from the human..)</span>
  <span class="k">proc </span><span class="nf">aiPlay</span><span class="p">()</span> <span class="o">=</span> 
    <span class="k">if</span> <span class="n">g</span><span class="p">.</span><span class="n">currentPlayer</span> <span class="o">==</span> <span class="n">g</span><span class="p">.</span><span class="n">aiPlayer</span><span class="p">:</span>
      <span class="k">let</span> <span class="n">emptySpots</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">emptySpots</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">emptySpots</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">g</span><span class="p">.</span><span class="n">difficulty</span><span class="p">:</span>
        <span class="k">let</span> <span class="n">move</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">getBestMove</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">aiPlayer</span><span class="p">)</span>
        <span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="n">move</span><span class="p">.</span><span class="n">idx</span><span class="o">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">aiPlayer</span>
        <span class="n">buttons</span><span class="o">[</span><span class="n">move</span><span class="p">.</span><span class="n">idx</span><span class="o">]</span><span class="p">.</span><span class="n">disable</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">let</span> <span class="n">rndmove</span> <span class="o">=</span> <span class="n">emptyspots</span><span class="p">.</span><span class="n">rand</span><span class="p">()</span>
        <span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="n">rndmove</span><span class="o">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">aiPlayer</span>
    <span class="n">g</span><span class="p">.</span><span class="n">change_player</span><span class="p">()</span>
    <span class="n">labelInfo</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Current player: "</span> <span class="o">&amp;</span> <span class="n">g</span><span class="p">.</span><span class="n">currentPlayer</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">pairs</span><span class="p">:</span>
      <span class="n">buttons</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">v</span>
      
    <span class="k">let</span> <span class="p">(</span><span class="n">done</span><span class="p">,</span> <span class="n">winner</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">done</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">done</span> <span class="o">==</span> <span class="kp">true</span><span class="p">:</span>
      <span class="n">echo</span> <span class="n">g</span><span class="p">.</span><span class="n">board</span>
      <span class="k">if</span> <span class="n">winner</span> <span class="o">==</span> <span class="s">"tie"</span><span class="p">:</span>
          <span class="n">labelInfo</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Tie.."</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">labelInfo</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">winner</span> <span class="o">&amp;</span> <span class="s">" won."</span>

<span class="p">```</span>

<span class="o">-</span> <span class="n">using</span> <span class="n">minmax</span> <span class="n">algorithm</span> <span class="kn">from</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">day</span> <span class="n">we</span> <span class="n">calculate</span> <span class="n">the</span> <span class="n">best</span> <span class="n">move</span>
<span class="o">-</span> <span class="n">change</span> <span class="n">the</span> <span class="n">button</span> <span class="n">text</span> <span class="n">to</span> <span class="p">`</span><span class="n">O</span><span class="p">`</span>
<span class="o">-</span> <span class="n">disable</span> <span class="n">the</span> <span class="n">button</span>
<span class="o">-</span> <span class="n">update</span> <span class="n">the</span> <span class="n">information</span> <span class="n">label</span>

 <span class="p">```</span><span class="n">nim</span>

  <span class="n">hbox1</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span>
  <span class="n">hbox1</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
  <span class="n">hbox1</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">)</span>

  <span class="n">hbox2</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span><span class="p">)</span>
  <span class="n">hbox2</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">4</span><span class="o">]</span><span class="p">)</span>
  <span class="n">hbox2</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">5</span><span class="o">]</span><span class="p">)</span>

  <span class="n">hbox3</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">6</span><span class="o">]</span><span class="p">)</span>
  <span class="n">hbox3</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">7</span><span class="o">]</span><span class="p">)</span>
  <span class="n">hbox3</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">8</span><span class="o">]</span><span class="p">)</span>
  
  <span class="n">box</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">hbox0</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">box</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">hbox1</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">box</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">hbox2</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">box</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">hbox3</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">mainwin</span><span class="p">.</span><span class="n">setChild</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
</pre></div></div>
<ul>
<li>Here we add the buttons to their correct rows in the correct columns and set the main widget
</li></ul>
<div class="code"><div class="highlight"><pre><span></span>  <span class="n">show</span><span class="p">(</span><span class="n">mainwin</span><span class="p">)</span>
  <span class="n">mainLoop</span><span class="p">()</span>

<span class="k">when</span> <span class="n">isMainModule</span><span class="p">:</span>
  <span class="n">init</span><span class="p">()</span>
  <span class="n">gui</span><span class="p">()</span>
</pre></div></div>
<p>Code is available on <a href="https://github.com/xmonader/nim-tictactoe/blob/master/src/nim_tictactoe_gui.nim" target="_blank" rel="noopener">https://github.com/xmonader/nim-tictactoe/blob/master/src/nim_tictactoe_gui.nim</a></p>
</div></div>
    </div>
  </body>
</html>
