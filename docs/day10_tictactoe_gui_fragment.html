<div id="cid32" data-tralics-id="cid32" class="chapter" data-number="10" data-chapter="day10_tictactoe_gui"><h1><a href="day10_tictactoe_gui_fragment.html#cid32" class="heading hyperref"><span class="number">Chapter 10 </span>Day 10: Tic tac toe with GUI!!</a></h1>
<p class="noindent">Hopefully, you’re done with day 9 and enjoyed playing tic tac toe.</p>
</div><div id="cid33" data-tralics-id="cid33" class="section" data-number="10.1"><h2><a href="day10_tictactoe_gui_fragment.html#cid33" class="heading hyperref"><span class="number">10.1 </span>Expectation</a></h2>
<p class="noindent">It’s fun to play on the command line, but it’d be very cool to have some GUI with some buttons using <a href="https://github.com/nim-lang/ui" target="_blank" rel="noopener">libui</a> bindings in Nim</p>
<ul>
<li>make sure to install it using <code>nimble install ui</code>
</li></ul>
</div><div id="cid34" data-tralics-id="cid34" class="section" data-number="10.2"><h2><a href="day10_tictactoe_gui_fragment.html#cid34" class="heading hyperref"><span class="number">10.2 </span>Implementation</a></h2>
<p class="noindent">In the previous day we reached some good abstraction separating the logic for the command line gui and the minmax algorithm and it’s not tightly coupled</p>
<div id="uid114" data-tralics-id="uid114" class="subsection" data-number="10.2.1"><h3><a href="day10_tictactoe_gui_fragment.html#uid114" class="heading hyperref"><span class="number">10.2.1 </span>minimal ui application</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">gui</span><span class="o">*</span><span class="p">()</span> <span class="o">=</span> 
  <span class="kd">var</span> <span class="n">mainwin</span> <span class="o">=</span> <span class="n">newWindow</span><span class="p">(</span><span class="s">"tictactoe"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">show</span><span class="p">(</span><span class="n">mainwin</span><span class="p">)</span>
  <span class="n">mainLoop</span><span class="p">()</span>

<span class="k">when</span> <span class="n">isMainModule</span><span class="p">:</span>
  <span class="c"># cli()</span>
  <span class="n">init</span><span class="p">()</span>
  <span class="n">gui</span><span class="p">()</span>
</pre></div></div>
<p>Here we create a window 400x500 with a title <code>tictactoe</code> and we show it and start its mainLoop <code>getting ready to receive and dispatch events</code></p>
</div>
<div id="uid115" data-tralics-id="uid115" class="subsection" data-number="10.2.2"><h3><a href="day10_tictactoe_gui_fragment.html#uid115" class="heading hyperref"><span class="number">10.2.2 </span>TicTacToe GUI</a></h3>
<p class="noindent">We can imagine the gui to be something like that</p>
<div class="code"><div class="highlight"><pre><span></span>---------------------------------------------
|  ---------------------------------------  |
+  | INFO LABEL | button to restart       | +
|  ---------------------------------------| |
+  |--------------------------------------| +
|  |  btn     |    btn  |   btn           | |
+  |--------------------------------------| +
|  |  btn     |    btn  |   btn           | |
+  |--------------------------------------| +
|  |  btn     |    btn  |   btn           | |
+  |--------------------------------------| +
---------------------------------------------
</pre></div></div>
<ul>
<li>a window that contains a vertical box
</li>
<li>the vertical box contains 4 rows
</li>
<li>first row to show information about the current game and a button to reset the game
</li>
<li>and the other rows represent the 3x3 tictactoe grid that will reflect <code>game.list</code> :)
</li>
<li>and 9 buttons to be pressed to set X or O
</li>
<li>we will support human vs AI so when human presses a button it gets disabled and the AI presses the button that minimizes its loss and that button gets disabled too.<span class="intersentencespace"></span>
</li></ul>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">gui</span><span class="o">*</span><span class="p">()</span> <span class="o">=</span> 
  <span class="kd">var</span> <span class="n">mainwin</span> <span class="o">=</span> <span class="n">newWindow</span><span class="p">(</span><span class="s">"tictactoe"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>

  <span class="c"># game object to contain the state, the players, the difficulty,...</span>
  <span class="kd">var</span> <span class="n">g</span> <span class="o">=</span> <span class="n">newGame</span><span class="p">(</span><span class="n">aiPlayer</span><span class="o">=</span><span class="s">"O"</span><span class="p">,</span> <span class="n">difficulty</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

  <span class="kd">var</span> <span class="n">currentMove</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="n">mainwin</span><span class="p">.</span><span class="n">margined</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">mainwin</span><span class="p">.</span><span class="n">onClosing</span> <span class="o">=</span> <span class="p">(</span><span class="k">proc</span> <span class="p">():</span> <span class="kt">bool</span> <span class="o">=</span> <span class="k">return</span> <span class="kp">true</span><span class="p">)</span>


  <span class="c"># set up the boxes </span>
  <span class="k">let</span> <span class="n">box</span> <span class="o">=</span> <span class="n">newVerticalBox</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">hbox0</span> <span class="o">=</span> <span class="n">newHorizontalBox</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">hbox1</span> <span class="o">=</span> <span class="n">newHorizontalBox</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">hbox2</span> <span class="o">=</span> <span class="n">newHorizontalBox</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">hbox3</span> <span class="o">=</span> <span class="n">newHorizontalBox</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="c"># list of buttons </span>
  <span class="kd">var</span> <span class="n">buttons</span> <span class="o">=</span> <span class="n">newSeq</span><span class="o">[</span><span class="n">Button</span><span class="o">]</span><span class="p">()</span>

  <span class="c"># information label</span>
  <span class="kd">var</span> <span class="n">labelInfo</span> <span class="o">=</span> <span class="n">newLabel</span><span class="p">(</span><span class="s">"Info: Player X turn"</span><span class="p">)</span>
  <span class="n">hbox0</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">labelInfo</span><span class="p">)</span>

  <span class="c"># restart button</span>
  <span class="n">hbox0</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">newButton</span><span class="p">(</span><span class="s">"Restart"</span><span class="p">,</span> <span class="k">proc</span><span class="p">()</span> <span class="o">=</span> 
                            <span class="n">g</span> <span class="o">=</span><span class="n">newGame</span><span class="p">(</span><span class="n">aiPlayer</span><span class="o">=</span><span class="s">"O"</span><span class="p">,</span> <span class="n">difficulty</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">.</span><span class="n">pairs</span><span class="p">:</span>
                              <span class="n">b</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="o">$</span><span class="n">i</span>
                              <span class="n">b</span><span class="p">.</span><span class="n">enable</span><span class="p">()))</span>
</pre></div></div>
<p>Here we setup the layout we just described and create a button Restart that resets the game again and restore the buttons text and enables them all</p>
<div class="code"><div class="highlight"><pre><span></span>  <span class="c"># create the buttons</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">countup</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
    <span class="kd">var</span> <span class="n">handler</span> <span class="p">:</span> <span class="k">proc</span><span class="p">()</span> 
    <span class="n">closureScope</span><span class="p">:</span>
      <span class="k">let</span> <span class="n">senderId</span> <span class="o">=</span> <span class="n">i</span>
      <span class="n">handler</span> <span class="o">=</span> <span class="k">proc</span><span class="p">()</span> <span class="o">=</span>
        <span class="n">currentMove</span> <span class="o">=</span> <span class="n">senderId</span>
        <span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="n">senderId</span><span class="o">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">currentPlayer</span>
        <span class="n">g</span><span class="p">.</span><span class="n">change_player</span><span class="p">()</span>
        <span class="n">labelInfo</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Current player: "</span> <span class="o">&amp;</span> <span class="n">g</span><span class="p">.</span><span class="n">currentPlayer</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">pairs</span><span class="p">:</span>
          <span class="n">buttons</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">let</span> <span class="p">(</span><span class="n">done</span><span class="p">,</span> <span class="n">winner</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">done</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">done</span> <span class="o">==</span> <span class="kp">true</span><span class="p">:</span>
          <span class="n">echo</span> <span class="n">g</span><span class="p">.</span><span class="n">board</span>
          <span class="k">if</span> <span class="n">winner</span> <span class="o">==</span> <span class="s">"tie"</span><span class="p">:</span>
              <span class="n">labelInfo</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Tie.."</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">labelInfo</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">winner</span> <span class="o">&amp;</span> <span class="s">" won."</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">aiPlay</span><span class="p">()</span>
        <span class="n">buttons</span><span class="o">[</span><span class="n">senderId</span><span class="o">]</span><span class="p">.</span><span class="n">disable</span><span class="p">()</span>

    <span class="n">buttons</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">newButton</span><span class="p">(</span><span class="o">$</span><span class="n">i</span><span class="p">,</span> <span class="n">handler</span><span class="p">))</span>
 <span class="p">```</span>

 <span class="o">-</span> <span class="n">Here</span> <span class="n">we</span> <span class="n">create</span> <span class="n">the</span> <span class="n">buttons</span> <span class="n">please</span> <span class="n">notice</span> <span class="n">we</span> <span class="n">are</span> <span class="n">using</span> <span class="p">`</span><span class="n">closureScope</span><span class="p">`</span> <span class="n">feature</span> <span class="n">to</span> <span class="n">capture</span> <span class="n">the</span> <span class="n">button</span> <span class="n">id</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">track</span> <span class="k">of</span> <span class="n">which</span> <span class="n">button</span> <span class="ow">is</span> <span class="n">clicked</span>
 <span class="o">-</span> <span class="n">after</span> <span class="n">pressing</span> <span class="kt">set</span> <span class="kt">set</span> <span class="n">the</span> <span class="n">text</span> <span class="k">of</span> <span class="n">the</span> <span class="n">button</span> <span class="n">to</span> <span class="p">`</span><span class="n">X</span><span class="p">`</span>
 <span class="o">-</span> <span class="n">we</span> <span class="n">disable</span> <span class="n">the</span> <span class="n">button</span> <span class="n">so</span> <span class="n">we</span> <span class="n">don</span><span class="sc">'t receive anymore events.</span>
 <span class="o">-</span> <span class="n">switch</span> <span class="n">turns</span>
 <span class="o">-</span> <span class="n">update</span> <span class="n">the</span> <span class="n">information</span> <span class="n">label</span> <span class="n">whether</span> <span class="n">about</span> <span class="n">the</span> <span class="n">next</span> <span class="n">player</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">game</span> <span class="n">state</span>
 <span class="o">-</span> <span class="k">if</span> <span class="n">the</span> <span class="n">game</span> <span class="ow">is</span> <span class="n">still</span> <span class="n">going</span> <span class="n">we</span> <span class="n">ask</span> <span class="n">the</span> <span class="n">AI</span> <span class="k">for</span> <span class="n">a</span> <span class="n">move</span>


<span class="p">```</span><span class="n">nim</span>

  <span class="c"># code to run when the game asks the ai to play (after each move from the human..)</span>
  <span class="k">proc </span><span class="nf">aiPlay</span><span class="p">()</span> <span class="o">=</span> 
    <span class="k">if</span> <span class="n">g</span><span class="p">.</span><span class="n">currentPlayer</span> <span class="o">==</span> <span class="n">g</span><span class="p">.</span><span class="n">aiPlayer</span><span class="p">:</span>
      <span class="k">let</span> <span class="n">emptySpots</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">emptySpots</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">emptySpots</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">g</span><span class="p">.</span><span class="n">difficulty</span><span class="p">:</span>
        <span class="k">let</span> <span class="n">move</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">getBestMove</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">aiPlayer</span><span class="p">)</span>
        <span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="n">move</span><span class="p">.</span><span class="n">idx</span><span class="o">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">aiPlayer</span>
        <span class="n">buttons</span><span class="o">[</span><span class="n">move</span><span class="p">.</span><span class="n">idx</span><span class="o">]</span><span class="p">.</span><span class="n">disable</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">let</span> <span class="n">rndmove</span> <span class="o">=</span> <span class="n">emptyspots</span><span class="p">.</span><span class="n">rand</span><span class="p">()</span>
        <span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">list</span><span class="o">[</span><span class="n">rndmove</span><span class="o">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">aiPlayer</span>
    <span class="n">g</span><span class="p">.</span><span class="n">change_player</span><span class="p">()</span>
    <span class="n">labelInfo</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Current player: "</span> <span class="o">&amp;</span> <span class="n">g</span><span class="p">.</span><span class="n">currentPlayer</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">pairs</span><span class="p">:</span>
      <span class="n">buttons</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">v</span>
      
    <span class="k">let</span> <span class="p">(</span><span class="n">done</span><span class="p">,</span> <span class="n">winner</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">board</span><span class="p">.</span><span class="n">done</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">done</span> <span class="o">==</span> <span class="kp">true</span><span class="p">:</span>
      <span class="n">echo</span> <span class="n">g</span><span class="p">.</span><span class="n">board</span>
      <span class="k">if</span> <span class="n">winner</span> <span class="o">==</span> <span class="s">"tie"</span><span class="p">:</span>
          <span class="n">labelInfo</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Tie.."</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">labelInfo</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">winner</span> <span class="o">&amp;</span> <span class="s">" won."</span>

<span class="p">```</span>

<span class="o">-</span> <span class="n">using</span> <span class="n">minmax</span> <span class="n">algorithm</span> <span class="kn">from</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">day</span> <span class="n">we</span> <span class="n">calculate</span> <span class="n">the</span> <span class="n">best</span> <span class="n">move</span>
<span class="o">-</span> <span class="n">change</span> <span class="n">the</span> <span class="n">button</span> <span class="n">text</span> <span class="n">to</span> <span class="p">`</span><span class="n">O</span><span class="p">`</span>
<span class="o">-</span> <span class="n">disable</span> <span class="n">the</span> <span class="n">button</span>
<span class="o">-</span> <span class="n">update</span> <span class="n">the</span> <span class="n">information</span> <span class="n">label</span>

 <span class="p">```</span><span class="n">nim</span>

  <span class="n">hbox1</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span>
  <span class="n">hbox1</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
  <span class="n">hbox1</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">)</span>

  <span class="n">hbox2</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span><span class="p">)</span>
  <span class="n">hbox2</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">4</span><span class="o">]</span><span class="p">)</span>
  <span class="n">hbox2</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">5</span><span class="o">]</span><span class="p">)</span>

  <span class="n">hbox3</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">6</span><span class="o">]</span><span class="p">)</span>
  <span class="n">hbox3</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">7</span><span class="o">]</span><span class="p">)</span>
  <span class="n">hbox3</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">buttons</span><span class="o">[</span><span class="mi">8</span><span class="o">]</span><span class="p">)</span>
  
  <span class="n">box</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">hbox0</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">box</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">hbox1</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">box</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">hbox2</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">box</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">hbox3</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">mainwin</span><span class="p">.</span><span class="n">setChild</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
</pre></div></div>
<ul>
<li>Here we add the buttons to their correct rows in the correct columns and set the main widget
</li></ul>
<div class="code"><div class="highlight"><pre><span></span>  <span class="n">show</span><span class="p">(</span><span class="n">mainwin</span><span class="p">)</span>
  <span class="n">mainLoop</span><span class="p">()</span>

<span class="k">when</span> <span class="n">isMainModule</span><span class="p">:</span>
  <span class="n">init</span><span class="p">()</span>
  <span class="n">gui</span><span class="p">()</span>
</pre></div></div>
<p>Code is available on <a href="https://github.com/xmonader/nim-tictactoe/blob/master/src/nim_tictactoe_gui.nim" target="_blank" rel="noopener">https://github.com/xmonader/nim-tictactoe/blob/master/src/nim_tictactoe_gui.nim</a></p>
</div></div>