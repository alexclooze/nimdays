<div id="cid10" data-tralics-id="cid10" class="chapter" data-number="4" data-chapter="day4_asynclinkschecker"><h1><a href="day4_asynclinkschecker_fragment.html#cid10" class="heading hyperref"><span class="number">Chapter 4 </span>Day 4: LinksChecker</a></h1>
</div><div id="cid11" data-tralics-id="cid11" class="section" data-number="4.1"><h2><a href="day4_asynclinkschecker_fragment.html#cid11" class="heading hyperref"><span class="number">4.1 </span>What to expect ?</a></h2>
<p class="noindent">We will be writing a simple linkschecker in both <code>sequential</code> and <code>asynchronous</code> style in nim</p>
</div><div id="cid12" data-tralics-id="cid12" class="section" data-number="4.2"><h2><a href="day4_asynclinkschecker_fragment.html#cid12" class="heading hyperref"><span class="number">4.2 </span>Implementation</a></h2>
<div id="uid10" data-tralics-id="uid10" class="subsection" data-number="4.2.1"><h3><a href="day4_asynclinkschecker_fragment.html#uid10" class="heading hyperref"><span class="number">4.2.1 </span>Step 0: Imports</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span>  <span class="n">os</span><span class="p">,</span> <span class="n">httpclient</span>
<span class="kn">import</span> <span class="n">strutils</span>
<span class="kn">import</span> <span class="n">times</span>
<span class="kn">import</span> <span class="n">asyncdispatch</span>
</pre></div></div>
</div>
<div id="uid11" data-tralics-id="uid11" class="subsection" data-number="4.2.2"><h3><a href="day4_asynclinkschecker_fragment.html#uid11" class="heading hyperref"><span class="number">4.2.2 </span>Step 1: Data types</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">type</span>
    <span class="n">LinkCheckResult</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> 
        <span class="n">link</span><span class="p">:</span> <span class="kt">string</span>
        <span class="n">state</span><span class="p">:</span> <span class="kt">bool</span>
</pre></div></div>
<p>LinkCheckResult is a simple representation for a link and its state</p>
</div>
<div id="uid12" data-tralics-id="uid12" class="subsection" data-number="4.2.3"><h3><a href="day4_asynclinkschecker_fragment.html#uid12" class="heading hyperref"><span class="number">4.2.3 </span>Step 2: GO Sequential!</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">checkLink</span><span class="p">(</span><span class="n">link</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="n">LinkCheckResult</span>  <span class="o">=</span>
    <span class="kd">var</span> <span class="n">client</span> <span class="o">=</span> <span class="n">newHttpClient</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">link</span><span class="p">).</span><span class="n">code</span> <span class="o">==</span> <span class="n">Http200</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>
</pre></div></div>
<p>Here, we have a proc <code>checkLink</code> takes a link and returns <code>LinkCheckResult</code>
- <code>newHttpClient()</code> to create a new client
- <code>client.get</code> to send a get request to a link and it returns a response
- <code>response.code</code> gives us the HTTP status code, and we consider a link is valid if its status == 200
- <code>client.get</code> raises error for invalid structured links that’s why we wrapped it a <code>try/except</code> block</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">sequentialLinksChecker</span><span class="p">(</span><span class="n">links</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="kt">string</span><span class="o">]</span><span class="p">):</span> <span class="n">void</span> <span class="o">=</span> 
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">link</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s">""</span><span class="p">:</span>
            <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">checkLink</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
            <span class="n">echo</span> <span class="n">result</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="s">" is "</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">state</span>
</pre></div></div>
<p>Here, <code>sequentialLinksChecker</code> proc takes sequence of <code>links</code> and executes <code>checkLink</code> on them <code>sequentially</code></p>
<div class="code"><div class="highlight"><pre><span></span>LINKS: @["https://www.google.com.eg", "https://yahoo.com", "https://reddit.com", "https://none.nonadasdet", "https://github.com", ""]
SEQUENTIAL::
https://www.google.com.eg is true
https://yahoo.com is true
https://reddit.com is true
https://none.nonadasdet is false
https://github.com is true
7.716497898101807
</pre></div></div>
<p>On my lousy internet it took 7.7 seconds to finish :(</p>
</div>
<div id="uid13" data-tralics-id="uid13" class="subsection" data-number="4.2.4"><h3><a href="day4_asynclinkschecker_fragment.html#uid13" class="heading hyperref"><span class="number">4.2.4 </span>Step 3: GO ASYNC!</a></h3>
<p class="noindent">We can do better than waiting on IO requests to finish</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">checkLinkAsync</span><span class="p">(</span><span class="n">link</span><span class="p">:</span> <span class="kt">string</span><span class="p">):</span> <span class="n">Future</span><span class="o">[</span><span class="n">LinkCheckResult</span><span class="o">]</span> <span class="p">{.</span><span class="n">async</span><span class="p">.}</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">client</span> <span class="o">=</span> <span class="n">newAsyncHttpClient</span><span class="p">()</span>

    <span class="k">let</span> <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">future</span>
    <span class="k">if</span> <span class="n">future</span><span class="p">.</span><span class="n">failed</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">let</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">future</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">resp</span><span class="p">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">Http200</span><span class="p">)</span> 
</pre></div></div>
<p>Here, we define a <code>checkLinkAsync</code> proc
- to declare a proc as async we use <code>async</code> pragma
- notice the client is of type <code>newAsyncHttpClient</code> that doesn’t block on <code>.get</code> calls
- <code>client.get</code> returns immediately a future that can either fail, and we can infer know that from <code>future.failed</code> or succeed
- <code>yield future</code> means okay i’m done for now dear <code>event loop</code> you can schedule other tasks and continue my execution when you have more update on my fancy <code>future</code>
when the eventloop comes back because the future now has some updates
- clearly, if the <code>future</code> failed we return the link with a <code>false</code> state
- otherwise, we get the <code>response</code> object that’s enclosed in the future by calling <code>read</code></p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">asyncLinksChecker</span><span class="p">(</span><span class="n">links</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="kt">string</span><span class="o">]</span><span class="p">)</span> <span class="p">{.</span><span class="n">async</span><span class="p">.}</span> <span class="o">=</span> 
    <span class="c"># client.maxRedirects = 0</span>
    <span class="kd">var</span> <span class="n">futures</span> <span class="o">=</span> <span class="n">newSeq</span><span class="o">[</span><span class="n">Future</span><span class="o">[</span><span class="n">LinkCheckResult</span><span class="o">]]</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">link</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s">""</span><span class="p">:</span>
            <span class="n">futures</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">checkLinkAsync</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
    
    <span class="c"># waitFor -&gt; call async proc from sync proc, await -&gt; call async proc from async proc</span>
    <span class="k">let</span> <span class="n">done</span> <span class="o">=</span> <span class="n">await</span> <span class="n">all</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
        <span class="n">echo</span> <span class="n">x</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="s">" is "</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">state</span>
</pre></div></div>
<p>Here, we have another async procedure <code>asyncLinksChecker</code> that will take a sequence of <code>links</code> and create futures for all of them and wait when they finish and give us some results
- <code>futures</code> is a sequence for the future results of all the <code>LinkCheckResults</code> for all the links passed to <code>asyncLinksChecker</code> proc
- we loop on the links and get <code>future</code> for the execution of <code>checkLinkAsync</code> and add it to the <code>futures</code> sequence.<span class="intersentencespace"></span> - we now ask to force to block until we get all of the results out of the futures into <code>done</code> variable
- then we print all the results
- Please notice <code>await</code> is used only to call <code>async</code> proc from another <code>async</code> proc, and <code>waitFor</code> is used to call <code>async</code> proc from <code>sync</code> proc</p>
<div class="code"><div class="highlight"><pre><span></span>ASYNC::
https://www.google.com.eg is true
https://yahoo.com is true
https://reddit.com is true
https://none.nonadasdet is false
https://github.com is true
 is false
3.601503849029541
</pre></div></div>
</div>
<div id="uid14" data-tralics-id="uid14" class="subsection" data-number="4.2.5"><h3><a href="day4_asynclinkschecker_fragment.html#uid14" class="heading hyperref"><span class="number">4.2.5 </span>Step 4 simple cli</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">main</span><span class="p">()</span><span class="o">=</span>
    <span class="n">echo</span> <span class="s">"Param count: "</span><span class="p">,</span> <span class="n">paramCount</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">paramCount</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">let</span> <span class="n">linksfile</span> <span class="o">=</span> <span class="n">paramStr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="kd">var</span> <span class="n">f</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">linksfile</span><span class="p">,</span> <span class="n">fmRead</span><span class="p">)</span>
        <span class="k">let</span> <span class="n">links</span> <span class="o">=</span> <span class="n">readAll</span><span class="p">(</span><span class="n">f</span><span class="p">).</span><span class="n">splitLines</span><span class="p">()</span>
        <span class="n">echo</span> <span class="s">"LINKS: "</span> <span class="o">&amp;</span> <span class="o">$</span><span class="n">links</span>
        <span class="n">echo</span> <span class="s">"SEQUENTIAL:: "</span>
        <span class="kd">var</span> <span class="n">t</span> <span class="o">=</span> <span class="n">epochTime</span><span class="p">()</span>
        <span class="n">sequentialLinksChecker</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
        <span class="n">echo</span> <span class="n">epochTime</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>
        <span class="n">echo</span> <span class="s">"ASYNC:: "</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">epochTime</span><span class="p">()</span>
        <span class="n">waitFor</span> <span class="n">asyncLinksChecker</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>
        <span class="n">echo</span> <span class="n">epochTime</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">echo</span> <span class="s">"Please provide linksfile"</span>
<span class="n">main</span><span class="p">()</span>
</pre></div></div>
<p>the only interesting part is <code>waitFor asyncLinksChecker(links)</code> as we said to call <code>async</code> proc from <code>sync</code> proc like this main proc you will need to use <code>waitFor</code></p>
</div>
<div id="uid15" data-tralics-id="uid15" class="subsection" data-number="4.2.6"><h3><a href="day4_asynclinkschecker_fragment.html#uid15" class="heading hyperref"><span class="number">4.2.6 </span>Extra, threading</a></h3>
<p class="noindent"></p><div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">threadpool</span>
<span class="k">proc </span><span class="nf">checkLinkParallel</span><span class="p">(</span><span class="n">link</span><span class="p">:</span> <span class="kt">string</span><span class="p">)</span> <span class="p">:</span> <span class="n">LinkCheckResult</span> <span class="p">{.</span><span class="n">thread</span><span class="p">.}</span> <span class="o">=</span>
    <span class="kd">var</span> <span class="n">client</span> <span class="o">=</span> <span class="n">newHttpClient</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">link</span><span class="p">).</span><span class="n">code</span> <span class="o">==</span> <span class="n">Http200</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinkCheckResult</span><span class="p">(</span><span class="n">link</span><span class="p">:</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>
</pre></div></div>
<p>Same as before, only <code>thread</code> pragma i used to note that proc will be executed within a thread</p>
<div class="code"><div class="highlight"><pre><span></span><span class="k">proc </span><span class="nf">threadsLinksChecker</span><span class="p">(</span><span class="n">links</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="kt">string</span><span class="o">]</span><span class="p">):</span> <span class="n">void</span> <span class="o">=</span> 
    <span class="kd">var</span> <span class="n">LinkCheckResults</span> <span class="o">=</span> <span class="n">newSeq</span><span class="o">[</span><span class="n">FlowVar</span><span class="o">[</span><span class="n">LinkCheckResult</span><span class="o">]]</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
        <span class="n">LinkCheckResults</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">spawn</span> <span class="n">checkLinkParallel</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>  
    
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">LinkCheckResults</span><span class="p">:</span>
        <span class="k">let</span> <span class="n">res</span> <span class="o">=</span> <span class="p">^</span><span class="n">x</span>
        <span class="n">echo</span> <span class="n">res</span><span class="p">.</span><span class="n">link</span><span class="p">,</span> <span class="s">" is "</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">state</span>
</pre></div></div>
<p>- spawned <code>tasks</code> or <code>threads</code> returns a value of type <code>FlowVar[T]</code>, where <code>T</code> is the return value of the spawned <code>proc</code>
- To get the value of a <code>FlowVar</code> we use <code></code> operator.</p>
<blockquote class="quotation"><p class="quote">Note: you should use <code>nim.cfg</code> with flags <code>-d:ssl</code> to allow working with https</p>
</blockquote><p>Send me a PR for improvements</p>
</div></div>